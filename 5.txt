<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Copia siempre este archivo desde la vista "Raw" o usando curl/wget para evitar pegar parches con prefijos `diff --git` -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GNSS.AI Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/exifr.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.456.0/dist/umd/lucide.min.js"></script>
    <style>
:root {
    color-scheme: dark;
    --bg: linear-gradient(135deg, #0a2463 0%, #1a1a2e 100%);
    --bg-elevated: rgba(255, 255, 255, 0.03);
    --bg-panel: rgba(255, 255, 255, 0.05);
    --bg-sidebar: rgba(255, 255, 255, 0.02);
    --border: rgba(0, 240, 255, 0.2);
    --border-strong: rgba(0, 240, 255, 0.4);
    --text: #ffffff;
    --text-muted: rgba(255, 255, 255, 0.7);
    --accent: #00f0ff;
    --accent-strong: #00d9a3;
    --danger: #ff6b7a;
    --warning: #ffc75f;
    --success: #5be7a9;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    --radius: 15px;
    --transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    --blur: 10px;
}

/* RTK Banner */
.rtk-banner {
    display: none;
    margin: 12px 0 0 0;
    padding: 12px 14px;
    border: 1px solid var(--border-strong);
    border-radius: 12px;
    background: linear-gradient(90deg, rgba(0, 188, 212, 0.12), rgba(15, 240, 179, 0.08));
}
.rtk-banner.is-visible { display: grid; }
.rtk-banner {
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 12px;
    align-items: center;
}
.rtk-banner__item { display: flex; gap: 8px; align-items: center; }
.rtk-banner__label { font-size: 12px; opacity: .8; }
.rtk-banner__value { font-weight: 700; }
.rtk-banner--warn { border-color: var(--warning); background: linear-gradient(90deg, rgba(255, 199, 95, .14), rgba(255, 199, 95, .08)); }
.rtk-banner--error { border-color: var(--danger); background: linear-gradient(90deg, rgba(255, 107, 122, .14), rgba(255, 107, 122, .08)); }

/* Quick actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
    margin: 14px 0 0 0;
}
.quick-actions .qa-btn { display: flex; align-items: center; justify-content: center; gap: 8px; }

body.light {
    color-scheme: light;
    --bg: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
    --bg-elevated: rgba(255, 255, 255, 0.9);
    --bg-panel: rgba(255, 255, 255, 0.8);
    --bg-sidebar: rgba(255, 255, 255, 0.95);
    --border: rgba(0, 150, 200, 0.3);
    --border-strong: rgba(0, 150, 200, 0.5);
    --text: #1a1a1a;
    --text-muted: rgba(0, 0, 0, 0.6);
    --accent: #0288d1;
    --accent-strong: #00897b;
    --danger: #f43f5e;
    --warning: #f59e0b;
    --success: #22c55e;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    --blur: 22px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 20px;
    transition: all 0.5s ease;
}

.layout {
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr);
    gap: 24px;
    width: min(1300px, 100%);
}

.mobile-toolbar {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 12px;
    padding: 12px 18px calc(12px + env(safe-area-inset-bottom));
    background: rgba(7, 13, 26, 0.86);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(16px);
    z-index: 45;
}

@media (min-width: 1101px) {
    .mobile-toolbar {
        display: none;
    }
}

.mobile-toolbar__btn {
    flex: 1 1 auto;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    font-size: 1.125rem;
    font-weight: 600;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--accent);
    color: var(--card-bg);
    min-height: 48px;
    touch-action: manipulation;
}

.mobile-toolbar__btn.is-secondary {
    background: transparent;
    color: var(--text);
}

.sidebar {
    background: var(--bg-sidebar);
    border-radius: calc(var(--radius) + 4px);
    border: 1px solid var(--border);
    padding: 28px 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
}

.brand {
    display: grid;
    gap: 4px;
}

.brand__title {
    font-size: 1.8rem;
    font-weight: 800;
    letter-spacing: -0.02em;
}

.brand__accent {
    color: var(--accent);
}

.brand__subtitle {
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.16em;
}

.menu {
    display: grid;
    gap: 12px;
    margin: 32px 0;
}

.menu__item {
    display: flex;
    align-items: center;
    gap: 12px;
    border: 1px solid transparent;
    padding: 12px 14px;
    border-radius: calc(var(--radius) - 6px);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: var(--transition);
}

.menu__item:hover,
.menu__item:focus-visible {
    border-color: var(--border);
    color: var(--text);
    outline: none;
}

.menu__item i {
    width: 20px;
    height: 20px;
}

.menu__item.is-active {
    background: linear-gradient(135deg, rgba(50, 212, 255, 0.25), rgba(15, 240, 179, 0.2));
    border-color: var(--border-strong);
    color: var(--text);
    box-shadow: 0 10px 25px rgba(0, 179, 255, 0.18);
}

.sidebar__footer {
    display: grid;
    gap: 18px;
}

.session {
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid var(--border);
    padding: 14px 16px;
    display: grid;
    gap: 6px;
}

.session__label {
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    color: var(--text-muted);
    text-transform: uppercase;
}

.session__value {
    font-size: 1.4rem;
    font-weight: 700;
}

.primary-btn,
.ghost-btn,
.icon-btn,
.mode-toggle {
    font: inherit;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: var(--transition);
}

.primary-btn {
    padding: 12px 18px;
    border-radius: calc(var(--radius) - 6px);
    background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    color: #030712;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    box-shadow: 0 15px 35px rgba(3, 169, 244, 0.28);
}

.primary-btn:hover {
    filter: brightness(1.05);
}

.icon-btn {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: var(--bg-panel);
    border: 1px solid var(--border);
    color: var(--text);
}

.icon-btn:hover {
    border-color: var(--border-strong);
    color: var(--accent);
}

.mode-toggle {
    padding: 10px 16px;
    border-radius: 16px;
    background: var(--bg-panel);
    border: 1px solid var(--border);
    color: var(--text);
    gap: 6px;
}

.mode-toggle__label {
    text-transform: uppercase;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    color: var(--text-muted);
}

.mode-toggle__value {
    font-weight: 700;
}

.ghost-btn {
    padding: 10px 16px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--text);
}

.ghost-btn:hover {
    color: var(--accent);
    border-color: var(--border);
}

.content {
    display: grid;
    gap: 24px;
}

.topbar {
    background: var(--bg-elevated);
    border-radius: calc(var(--radius) + 2px);
    border: 1px solid var(--border);
    padding: 22px 26px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
}

.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 6px 10px;
    border-radius: 12px;
    background: var(--bg-panel);
    border: 1px solid var(--border);
}
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: rgba(255,255,255,.2);
}
.status-dot.is-online { background: #22c55e; }
.status-dot.is-offline { background: #ef4444; }
.uptime { opacity: .8; }

.status-group {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 140px));
    gap: 14px;
}

.status-card {
    background: var(--bg-panel);
    padding: 16px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    display: grid;
    gap: 6px;
    position: relative;
    overflow: hidden;
}

.status-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(50, 212, 255, 0.15), transparent 55%);
    opacity: 0;
    transition: var(--transition);
}

.status-card.is-active::after {
    opacity: 1;
}

.status-card__label {
    font-size: 0.75rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.status-card__value {
    font-size: 1.2rem;
    font-weight: 700;
}

.topbar__actions {
    display: inline-flex;
    align-items: center;
    gap: 14px;
}

.badge {
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--bg-panel);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text-muted);
}

.view {
    display: none;
    flex-direction: column;
    gap: 24px;
}

.view.is-active {
    display: flex;
}

.grid {
    display: grid;
    gap: 24px;
}

.grid--primary {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

.grid--secondary {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
}

.card {
    background: var(--bg-elevated);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    padding: 22px 24px;
    display: grid;
    gap: 18px;
    backdrop-filter: blur(calc(var(--blur) * 0.75));
    box-shadow: var(--shadow);
}

.card.focus {
    grid-column: span 2;
}

.card__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
}

.card__title {
    font-size: 1.1rem;
    font-weight: 700;
}

.card__subtitle {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.solution {
    display: grid;
    gap: 18px;
}

.solution__utm {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    padding: 16px;
    border-radius: var(--radius);
    background: rgba(8, 15, 32, 0.65);
    border: 1px solid rgba(255, 255, 255, 0.04);
}

.solution__utm strong {
    display: block;
    font-size: 1rem;
    font-weight: 600;
}

.solution__utm span {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text-muted);
}

.solution__utm p {
    margin-top: 6px;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.solution__coords {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: 0.02em;
}

.solution__alt {
    font-size: 1.1rem;
    color: var(--text-muted);
}

.solution__alt--secondary {
    margin-top: -4px;
    font-size: 0.95rem;
}

.solution__meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 18px;
}

.solution__meta dt {
    font-size: 0.75rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.solution__meta dd {
    font-size: 1.1rem;
    font-weight: 600;
}

.map-card {
    min-height: 320px;
}

.map-card__controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-end;
}

.action-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.logging-state {
    font-size: 0.8rem;
    line-height: 1.4;
    color: var(--text-muted);
}

.logging-state strong {
    color: var(--text);
    display: block;
}

.modal {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    background: rgba(7, 13, 26, 0.65);
    backdrop-filter: blur(12px);
    opacity: 0;
    pointer-events: none;
    transition: 200ms ease;
    z-index: 40;
}

.modal.is-open {
    opacity: 1;
    pointer-events: auto;
}

.modal__content {
    width: min(460px, 92vw);
    background: rgba(17, 28, 55, 0.92);
    border-radius: calc(var(--radius) + 2px);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    padding: 28px 30px;
    position: relative;
    max-height: min(640px, 92vh);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: flex;
    flex-direction: column;
    transform: translateY(12px);
    transition: var(--transition);
}

.modal.is-open .modal__content {
    transform: translateY(0);
}

.modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 18px;
}

.modal__toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 12px;
}

.modal__toolbar .ghost-btn,
.modal__toolbar .primary-btn {
    flex: 1 1 140px;
    justify-content: center;
}

.modal__title {
    font-size: 1.2rem;
    font-weight: 700;
}

.modal__close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.form {
    display: grid;
    gap: 16px;
}

.modal__content .form {
    flex: 1;
    overflow-y: auto;
    padding-right: 8px;
    margin-right: -8px;
    overscroll-behavior: contain;
}

.form__hint {
    font-size: 0.75rem;
    line-height: 1.45;
    color: var(--text-muted);
}

.form__hint.is-success {
    color: var(--success);
}

.form__hint.is-error {
    color: var(--danger);
}

.form__group {
    display: grid;
    gap: 6px;
}

.form__row {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
}

.form__toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.form__toolbar .ghost-btn,
.form__toolbar .primary-btn {
    flex: 1 1 160px;
    justify-content: center;
}

.form__label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.form__input,
.form__select,
.form__textarea {
    background: rgba(12, 20, 40, 0.65);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    color: var(--text);
    font: inherit;
    transition: var(--transition);
}

.form__textarea {
    min-height: 90px;
    resize: vertical;
}

.form__input:focus,
.form__select:focus,
.form__textarea:focus {
    outline: none;
    border-color: var(--accent);
}

.switch {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-radius: 14px;
    background: rgba(12, 20, 40, 0.45);
    border: 1px solid var(--border);
}

.switch input {
    appearance: none;
    width: 44px;
    height: 22px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.16);
    position: relative;
    cursor: pointer;
    transition: var(--transition);
}

.switch input::after {
    content: '';
    position: absolute;
    inset: 3px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--text);
    transform: translateX(0);
    transition: var(--transition);
}

.switch input:checked {
    background: var(--accent);
}

.switch input:checked::after {
    transform: translateX(22px);
    background: var(--bg);
}

.switch__label {
    font-weight: 600;
}

.modal__footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 12px;
    position: sticky;
    bottom: -12px;
    background: linear-gradient(180deg, rgba(11, 19, 36, 0), rgba(11, 19, 36, 0.92) 55%, rgba(11, 19, 36, 0.98));
    padding: 16px 0 calc(12px + env(safe-area-inset-bottom));
    border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.modal__content .modal__footer {
    margin: 0 -30px -28px;
    padding: 16px 30px 28px;
}

body.light .modal__footer {
    background: linear-gradient(180deg, rgba(237, 242, 251, 0), rgba(237, 242, 251, 0.92) 55%, rgba(237, 242, 251, 0.98));
    border-top-color: rgba(15, 23, 42, 0.08);
}

.modal__hint {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.ntrip {
    display: grid;
    gap: 12px;
}

.ntrip__item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.ntrip__item span:first-child {
    font-size: 0.7rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.ntrip__badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(50, 212, 255, 0.25);
    background: rgba(50, 212, 255, 0.12);
    color: var(--accent);
}

.logging-card {
    display: grid;
    gap: 14px;
}

.logging-card__row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.logging-card__row span:first-child {
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.logging-card__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(50, 212, 255, 0.25);
    background: rgba(50, 212, 255, 0.12);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.04em;
}

.tag--alt {
    border-color: rgba(255, 199, 95, 0.35);
    background: rgba(255, 199, 95, 0.15);
    color: var(--warning);
}

.tag--success {
    border-color: rgba(91, 231, 169, 0.35);
    background: rgba(91, 231, 169, 0.18);
    color: var(--success);
}

.stakeout {
    display: grid;
    gap: 16px;
}

.stakeout__status {
    display: grid;
    gap: 6px;
}

.stakeout__badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    width: fit-content;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: 1px solid rgba(50, 212, 255, 0.28);
    background: rgba(50, 212, 255, 0.14);
    color: var(--accent);
}

.stakeout__badge.is-success {
    border-color: rgba(91, 231, 169, 0.35);
    background: rgba(91, 231, 169, 0.18);
    color: var(--success);
}

.stakeout__badge.is-warning {
    border-color: rgba(255, 199, 95, 0.35);
    background: rgba(255, 199, 95, 0.18);
    color: var(--warning);
}

.stakeout__distance {
    font-size: 2.1rem;
    font-weight: 700;
    letter-spacing: 0.04em;
}

.stakeout__bearing {
    font-size: 0.9rem;
    color: var(--text-muted);
}

.stakeout__vectors {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.stakeout__vector {
    flex: 1 1 140px;
    padding: 14px 16px;
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid var(--border);
    background: rgba(12, 20, 40, 0.5);
    text-align: center;
}

.stakeout__vector span {
    display: block;
    font-size: 0.68rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: var(--text-muted);
}

.stakeout__vector strong {
    display: block;
    margin-top: 6px;
    font-size: 1.35rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}

.stakeout__vector small {
    display: block;
    margin-top: 4px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.stakeout__vector.is-positive strong {
    color: var(--success);
}

.stakeout__vector.is-negative strong {
    color: var(--danger);
}

.stakeout__vector.is-neutral strong {
    color: var(--accent);
}

.stakeout__utm {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    border: 1px dashed var(--border);
    border-radius: calc(var(--radius) - 8px);
    padding: 14px 16px;
    background: rgba(12, 20, 40, 0.45);
}

.stakeout__utm span {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
}

.stakeout__utm strong {
    font-size: 1rem;
}

.stakeout__utm p {
    margin-top: 4px;
    font-size: 0.85rem;
    color: var(--text-muted);
    font-variant-numeric: tabular-nums;
}

.stakeout__grid span {
    display: block;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
}

.stakeout__grid strong {
    font-size: 1rem;
}

.stakeout__guidance {
    border-radius: 14px;
    border: 1px dashed var(--border);
    padding: 12px 16px;
    font-size: 0.9rem;
    line-height: 1.5;
    background: rgba(12, 20, 40, 0.45);
}

.stakeout__guidance.is-success {
    border-color: rgba(91, 231, 169, 0.6);
    color: var(--success);
}

.stakeout__guidance.is-warning {
    border-color: rgba(255, 199, 95, 0.6);
    color: var(--warning);
}

.modal__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: -6px;
}

.modal__badges .tag {
    background: rgba(12, 20, 40, 0.65);
    border-color: rgba(255, 255, 255, 0.08);
}

.modal__section-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text-muted);
}

.divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.08);
    margin: 6px 0 12px;
}

body.light .modal__content {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(70, 95, 180, 0.18);
}

body.light .form__input,
body.light .form__select,
body.light .form__textarea {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(70, 95, 180, 0.2);
    color: var(--text);
}

body.light .switch {
    background: rgba(255, 255, 255, 0.75);
    border-color: rgba(70, 95, 180, 0.18);
}

body.light .switch input {
    background: rgba(26, 34, 52, 0.15);
}

body.light .switch input::after {
    background: var(--bg);
}

body.light .stakeout__guidance {
    background: rgba(255, 255, 255, 0.82);
    border-color: rgba(70, 95, 180, 0.22);
}

body.light .modal__badges .tag {
    background: rgba(231, 238, 255, 0.78);
    border-color: rgba(70, 95, 180, 0.22);
}

body.light .tag {
    background: rgba(13, 116, 255, 0.08);
    border-color: rgba(13, 116, 255, 0.18);
    color: var(--accent);
}

body.light .tag--alt {
    background: rgba(255, 183, 77, 0.18);
    border-color: rgba(255, 183, 77, 0.3);
}

body.light .tag--success {
    background: rgba(34, 197, 94, 0.18);
    border-color: rgba(34, 197, 94, 0.3);
}

.map {
    height: 280px;
    border-radius: calc(var(--radius) - 6px);
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.legend {
    display: inline-flex;
    gap: 12px;
    align-items: center;
}

.legend__item {
    font-size: 0.75rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
}

.legend__item--gps {
    color: #5be7a9;
}

.legend__item--glo {
    color: #ffc75f;
}

.legend__item--gal {
    color: #32d4ff;
}

.constellations,
.services,
.timeline,
.profiles,
.files {
    list-style: none;
    display: grid;
    gap: 16px;
}

.constellations li,
.services li,
.profiles li,
.files li {
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 8px);
    border: 1px solid var(--border);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 18px;
}

.constellations li span:first-child {
    font-weight: 600;
}

.constellation__metrics {
    display: inline-flex;
    gap: 12px;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.constellations li::before,
.services li::before,
.timeline li::before,
.files li::before,
.profiles li::before {
    content: "";
    width: 10px;
    height: 10px;
    border-radius: 999px;
    margin-right: 12px;
    background: var(--tone, var(--accent));
    box-shadow: 0 0 12px color-mix(in srgb, var(--tone, var(--accent)) 65%, transparent);
}

.photo-log {
    display: grid;
    gap: 16px;
}

.photo-log__empty {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.photo-log__item {
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 8px);
    border: 1px solid var(--border);
    padding: 16px 18px;
    display: grid;
    gap: 12px;
}

.photo-log__item header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.photo-log__item h3 {
    font-size: 1rem;
}

.photo-log__meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 10px 18px;
    font-size: 0.85rem;
}

.photo-log__meta dt {
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.14em;
}

.photo-log__meta dd {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
}

.photo-log__meta dd.is-hint {
    font-weight: 500;
    color: var(--text-muted);
    font-style: italic;
}

.services li.is-warning::before {
    background: var(--warning);
}

.services li.is-danger::before {
    background: var(--danger);
}

.imu {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
}

.imu div {
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 10px);
    border: 1px solid var(--border);
    padding: 14px 16px;
    display: grid;
    gap: 6px;
}

.imu dt {
    font-size: 0.7rem;
    letter-spacing: 0.16em;
    color: var(--text-muted);
    text-transform: uppercase;
}

.imu dd {
    font-weight: 600;
}

.timeline li {
    flex-direction: column;
    align-items: flex-start;
}

.timeline time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.project {
    display: grid;
    gap: 16px;
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid var(--border);
    padding: 18px;
}

.project__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.project__details {
    display: grid;
    gap: 8px;
}

.table-wrapper {
    overflow: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.table thead {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.7rem;
    color: var(--text-muted);
}

.table th,
.table td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    padding: 10px 12px;
    text-align: left;
    white-space: nowrap;
}

.table tbody tr:hover {
    background: rgba(50, 212, 255, 0.08);
}

.table th.is-subtle,
.table td.is-subtle {
    color: var(--text-muted);
    font-size: 0.78rem;
}

.table td.is-utm {
    font-variant-numeric: tabular-nums;
    font-family: "Inter", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.table td.is-multiline {
    white-space: normal;
    line-height: 1.4;
}

.satellites {
    display: grid;
    gap: 14px;
}

.satellite {
    display: grid;
    grid-template-columns: 60px 1fr 80px 32px;
    gap: 12px;
    align-items: center;
    padding: 14px 16px;
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 8px);
    border: 1px solid var(--border);
    transition: all 0.2s;
}

.satellite--los {
    border-left: 3px solid #00d9a3;
}

.satellite--multipath {
    border-left: 3px solid #ff9800;
}

.satellite--nlos {
    border-left: 3px solid #f44336;
}

.satellite__id {
    font-weight: 700;
    font-size: 1.1rem;
}

.satellite__bar {
    height: 8px;
    border-radius: 999px;
    background: rgba(50, 212, 255, 0.18);
    position: relative;
    overflow: hidden;
}

.satellite__bar span {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    transition: width 0.3s ease;
}

.satellite__snr {
    font-size: 0.9rem;
    font-weight: 600;
}

.satellite__signal {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.ml-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    padding: 16px;
    background: var(--bg-elevated);
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid var(--border);
    margin-bottom: 16px;
}

.ml-stat {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.ml-stat__dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.ml-stat__dot--los {
    background: #00d9a3;
}

.ml-stat__dot--multipath {
    background: #ff9800;
}

.ml-stat__dot--nlos {
    background: #f44336;
}

.polar {
    min-height: 320px;
    border-radius: calc(var(--radius) - 6px);
    border: 1px dashed var(--border);
    display: grid;
    place-items: center;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.commands {
    display: grid;
    gap: 16px;
}

.command {
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 8px);
    border: 1px solid var(--border);
    padding: 16px 18px;
    display: grid;
    gap: 8px;
}

.command__title {
    font-weight: 700;
}

.command__desc {
    color: var(--text-muted);
    font-size: 0.85rem;
}

.command__actions {
    display: flex;
    gap: 12px;
}

.command__actions button {
    flex: none;
}

.files li {
    align-items: center;
}

.files span {
    display: grid;
    gap: 4px;
}

.sync {
    display: grid;
    gap: 16px;
    background: var(--bg-panel);
    border-radius: calc(var(--radius) - 6px);
    border: 1px solid var(--border);
    padding: 18px;
}

.toast {
    position: fixed;
    inset: auto 24px 24px auto;
    padding: 14px 18px;
    border-radius: 12px;
    background: rgba(12, 20, 40, 0.95);
    color: #f8fafc;
    font-weight: 600;
    box-shadow: 0 20px 45px rgba(3, 8, 20, 0.6);
    opacity: 0;
    transform: translateY(20px);
    transition: 200ms ease;
    pointer-events: none;
}

.toast.is-visible {
    opacity: 1;
    transform: translateY(0);
}

@media (max-width: 1100px) {
    body {
        padding: 16px;
        padding-bottom: calc(110px + env(safe-area-inset-bottom));
    }

    .layout {
        grid-template-columns: 1fr;
    }

    .sidebar {
        flex-direction: row;
        align-items: center;
        gap: 24px;
    }

    .sidebar__footer {
        display: none;
    }

    .menu {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin: 0;
    }

    .brand {
        min-width: 180px;
    }

    .topbar {
        flex-direction: column;
        gap: 18px;
        align-items: stretch;
    }

    .status-group {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .mobile-toolbar {
        display: flex;
    }
}

@media (max-width: 720px) {
    .status-group {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .card.focus {
        grid-column: auto;
    }

    .map-card__controls {
        justify-content: flex-start;
    }

    .solution__utm {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .modal__content {
        width: 100vw;
        max-height: 100vh;
        height: 100vh;
        border-radius: 0;
        padding: 24px 24px 88px;
    }

    .modal__content .form {
        padding-right: 0;
        margin-right: 0;
    }

    .modal__toolbar {
        margin-bottom: 6px;
    }

    .modal__footer {
        margin: 0 -24px -24px;
        padding: 16px 24px 24px;
        bottom: 0;
    }

    .legend__item {
        font-size: 0.65rem;
    }
}

@media (max-width: 960px) {
    .layout { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .content { padding-bottom: 84px; }
    .topbar { padding: 16px; gap: 14px; flex-direction: column; align-items: stretch; }
    .status-group { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .quick-actions { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .map { height: 68vh; border-radius: 12px; }
    .card.focus { order: 1; }
    .map-card { order: 2; }
    .card__header { flex-direction: column; align-items: flex-start; gap: 10px; }
    .mode-toggle { width: 100%; justify-content: space-between; }
    .primary-btn, .ghost-btn { width: 100%; }
    .form__row { grid-template-columns: 1fr; }
    .form__input, .form__select, .form__textarea { min-height: 44px; }
}
    </style>
    <link rel="stylesheet" href="gnssai_backup/home/gnssai2/gnssai/static/assets/css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.364.0/dist/umd/lucide.js" defer></script>
    <script src="gnssai_backup/home/gnssai2/gnssai/static/assets/js/script.js" defer></script>
    
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="brand">
                <span class="brand__title">GNSS<span class="brand__accent">.AI</span></span>
                <span class="brand__subtitle">Control de estación K922</span>
            </div>
            <nav class="menu" aria-label="Secciones GNSS">
                <button class="menu__item is-active" data-view="overview" aria-current="page">
                    <i data-lucide="activity"></i>
                    <span>Monitoreo</span>
                </button>
                <button class="menu__item" data-view="survey">
                    <i data-lucide="map"></i>
                    <span>Levantamiento</span>
                </button>
                <button class="menu__item" data-view="satellites">
                    <i data-lucide="satellite"></i>
                    <span>Satélites</span>
                </button>
                <button class="menu__item" data-view="control">
                    <i data-lucide="settings"></i>
                    <span>Comandos</span>
                </button>
                <button class="menu__item" data-view="files">
                    <i data-lucide="folder-open"></i>
                    <span>Registro</span>
                </button>
            </nav>
            <div class="sidebar__footer">
                <div class="session" id="sessionInfo">
                    <div class="session__label">Sesión RTK</div>
                    <div class="session__value">--:--</div>
                </div>
                <button class="primary-btn" id="recordBtn">
                    <i data-lucide="radio"></i>
                    <span>Iniciar registro</span>
                </button>
                <button class="ghost-btn" id="loggingConfigBtn">
                    <i data-lucide="sliders-horizontal"></i>
                    Ajustes de logging
                </button>
                <div class="logging-state" id="loggingSummary">
                    <strong>Perfil activo:</strong>
                    NMEA + RINEX · 1 Hz
                </div>
            </div>
        </aside>
        <main class="content">
            <header class="topbar">
                <div class="status-group">
                    <div class="status-card" id="gnssStatus">
                        <span class="status-card__label">GNSS</span>
                        <span class="status-card__value">Offline</span>
                    </div>
                    <div class="status-card" id="rtkStatus">
                        <span class="status-card__label">RTK</span>
                        <span class="status-card__value">Sin solución</span>
                    </div>
                    <div class="status-card" id="imuStatus">
                        <span class="status-card__label">IMU</span>
                        <span class="status-card__value">Inactiva</span>
                    </div>
                    <div class="status-card" id="networkStatus">
                        <span class="status-card__label">NTRIP</span>
                        <span class="status-card__value">Desconectado</span>
                    </div>
                </div>
                <div class="topbar__actions">
                    <div class="badge" id="firmwareBadge">FW K922 · v1.4</div>
                    <button class="icon-btn" id="refreshBtn" aria-label="Actualizar estado">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <div class="connection-status">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="connectionText">Conectando...</span>
                        <span class="uptime">Uptime: <span id="uptime">0s</span></span>
                    </div>
                    <button class="ghost-btn" id="quickProjectBtn">
                        <i data-lucide="file-plus-2"></i>
                        Proyecto
                    </button>
                    <button class="ghost-btn" id="quickStakeoutBtn">
                        <i data-lucide="map-pin"></i>
                        Replanteo
                    </button>
                    <button class="mode-toggle" id="modeToggle" aria-label="Cambiar modo">
                        <span class="mode-toggle__label">Modo</span>
                        <span class="mode-toggle__value">Rover</span>
                    </button>
                    <button class="ghost-btn" id="ntripConfigBtn">
                        <i data-lucide="cast"></i>
                        NTRIP
                    </button>
                    <button class="icon-btn" id="themeToggle" aria-label="Cambiar tema">
                        <i data-lucide="moon-star"></i>
                    </button>
                </div>
            </header>
            <section class="view is-active" id="overviewView">
                <div class="grid grid--primary">
                    <article class="card focus">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Solución Actual</h2>
                                <p class="card__subtitle" id="solutionSubtitle">Esperando datos GNSS</p>
                            </div>
                            <button class="ghost-btn" id="copyCoords">
                                <i data-lucide="copy"></i>
                                Copiar coordenadas
                            </button>
                        </header>
                        <div id="rtkBanner" class="rtk-banner" aria-live="polite">
                            <div class="rtk-banner__item"><span class="rtk-banner__label">RTK</span><span class="rtk-banner__value" id="rtkBannerFix">—</span></div>
                            <div class="rtk-banner__item"><span class="rtk-banner__label">HDOP</span><span class="rtk-banner__value" id="rtkBannerHdop">—</span></div>
                            <div class="rtk-banner__item"><span class="rtk-banner__label">Satélites</span><span class="rtk-banner__value" id="rtkBannerSats">—</span></div>
                            <div class="rtk-banner__item"><span class="rtk-banner__label">Edad corr.</span><span class="rtk-banner__value" id="rtkBannerAge">—</span></div>
                        </div>
                        <div class="quick-actions" id="quickActions">
                            <button class="primary-btn qa-btn" id="qaSavePoint"><i data-lucide="bookmark-plus"></i>Guardar punto</button>
                            <button class="ghost-btn qa-btn" id="qaPhoto"><i data-lucide="camera"></i>Foto</button>
                            <button class="ghost-btn qa-btn" id="qaExport"><i data-lucide="share"></i>Exportar</button>
                            <button class="ghost-btn qa-btn" id="qaStakeout"><i data-lucide="map-pin"></i>Replanteo</button>
                            <button class="ghost-btn qa-btn" id="qaHighPrecision"><i data-lucide="radio"></i>Alta precisión</button>
                        </div>
                        <div class="solution">
                            <div class="solution__coords" id="latLon"></div>
                            <div class="solution__alt" id="altitude"></div>
                            <div class="solution__alt solution__alt--secondary" id="orthometric"></div>
                            <dl class="solution__meta">
                                <div>
                                    <dt>Precisión horizontal</dt>
                                    <dd id="hAccuracy">--</dd>
                                </div>
                                <div>
                                    <dt>HDOP</dt>
                                    <dd id="hdop">--</dd>
                                </div>
                                <div>
                                    <dt>Satélites</dt>
                                    <dd id="satCount">--</dd>
                                </div>
                                <div>
                                    <dt>Edad corrección</dt>
                                    <dd id="correctionAge">--</dd>
                                </div>
                            </dl>
                            <div class="solution__utm" id="utmSummary">
                                <div>
                                    <span>Zona UTM</span>
                                    <strong id="utmZone">—</strong>
                                    <p id="utmEN">—</p>
                                </div>
                                <div>
                                    <span>Actualización</span>
                                    <strong id="positionSource">Esperando datos...</strong>
                                    <p id="positionUpdated">—</p>
                                </div>
                            </div>
                        </div>
                    </article>
                    <article class="card map-card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Mapa en tiempo real</h2>
                                <p class="card__subtitle">Posición GNSS sobre mosaico satelital</p>
                            </div>
                            <div class="map-card__controls">
                                <button class="ghost-btn" id="mapReset">
                                    <i data-lucide="target"></i>
                                    Centrar
                                </button>
                                <button class="ghost-btn" id="mapLayer">
                                    <i data-lucide="layers"></i>
                                    Capa
                                </button>
                            </div>
                        </header>
                        <div class="map" id="map"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Historial de SNR</h2>
                                <p class="card__subtitle">Últimos 10 segundos</p>
                            </div>
                            <div class="legend">
                                <span class="legend__item legend__item--gps">GPS</span>
                                <span class="legend__item legend__item--glo">GLONASS</span>
                                <span class="legend__item legend__item--gal">Galileo</span>
                            </div>
                        </header>
                        <canvas id="snrChart" height="180"></canvas>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Constelaciones</h2>
                                <p class="card__subtitle">Estado combinado</p>
                            </div>
                        </header>
                        <ul class="constellations" id="constellationsList"></ul>
                    </article>
                </div>
                <div class="grid grid--secondary">
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Estado de servicios</h2>
                        </header>
                        <ul class="services" id="servicesList"></ul>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Correcciones NTRIP</h2>
                                <p class="card__subtitle">Caster remoto y sesión</p>
                            </div>
                            <button class="ghost-btn" id="ntripCardBtn">
                                <i data-lucide="settings-2"></i>
                                Configurar
                            </button>
                        </header>
                        <div class="ntrip" id="ntripSummary"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">IMU &amp; Tilt</h2>
                        </header>
                        <dl class="imu" id="imuStats"></dl>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Eventos</h2>
                        </header>
                        <ul class="timeline" id="timeline"></ul>
                    </article>
                </div>
            </section>
            <section class="view" id="surveyView" aria-hidden="true">
                <div class="grid">
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Proyecto activo</h2>
                                <p class="card__subtitle">Gestión de puntos y stakeout</p>
                            </div>
                            <div class="action-toolbar">
                                <button class="primary-btn" id="newPointBtn">
                                    <i data-lucide="plus"></i>
                                    Nuevo punto
                                </button>
                                <button class="ghost-btn" id="projectConfigBtn">
                                    <i data-lucide="folder-cog"></i>
                                    Gestionar proyecto
                                </button>
                            </div>
                        </header>
                        <div class="project" id="projectSummary"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Replanteo activo</h2>
                                <p class="card__subtitle" id="stakeoutSubtitle">Define un objetivo para guiar</p>
                            </div>
                            <div class="action-toolbar">
                                <button class="ghost-btn" id="stakeoutToggleBtn">
                                    <i data-lucide="target"></i>
                                    Activar replanteo
                                </button>
                                <button class="ghost-btn" id="stakeoutBtn">
                                    <i data-lucide="navigation-2"></i>
                                    Configurar
                                </button>
                            </div>
                        </header>
                        <div class="stakeout" id="stakeoutPanel"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Puntos almacenados</h2>
                                <p class="card__subtitle" id="pointsCount">0 puntos registrados</p>
                            </div>
                            <div class="action-toolbar">
                                <button class="ghost-btn" id="exportCSVBtn">
                                    <i data-lucide="file-spreadsheet"></i>
                                    CSV
                                </button>
                                <button class="ghost-btn" id="exportGeoJSONBtn">
                                    <i data-lucide="map-pin"></i>
                                    GeoJSON
                                </button>
                                <button class="ghost-btn" id="exportKMLBtn">
                                    <i data-lucide="globe"></i>
                                    KML
                                </button>
                            </div>
                        </header>
                        <div class="table-wrapper">
                            <table class="table" id="pointsTable">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Zona</th>
                                        <th>E (m)</th>
                                        <th>N (m)</th>
                                        <th class="is-subtle">Latitud</th>
                                        <th class="is-subtle">Longitud</th>
                                        <th>Altura</th>
                                        <th>Alt. EGM2008</th>
                                        <th>Precisión</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </article>
                </div>
            </section>
            <section class="view" id="satellitesView" aria-hidden="true">
                <div class="grid">
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Panel de satélites</h2>
                                <p class="card__subtitle">Potencia de señal y elevación</p>
                            </div>
                        </header>
                        <div class="satellites" id="satellitesPanel"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Gráfico polar</h2>
                        </header>
                        <div class="polar" id="polarChart"></div>
                    </article>
                </div>
            </section>
            <section class="view" id="controlView" aria-hidden="true">
                <div class="grid">
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Comandos rápidos</h2>
                                <p class="card__subtitle">Basados en el fabricante seleccionado</p>
                            </div>
                            <div>
                                <label class="form__label" for="vendorSelect" style="display:block;">Fabricante</label>
                                <select class="form__select" id="vendorSelect" name="vendorSelect">
                                    <option value="ComNav">ComNav K222/K5x</option>
                                    <option value="SinoGNSS">SinoGNSS K922</option>
                                </select>
                            </div>
                        </header>
                        <div class="commands" id="commandList"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Perfiles de operación</h2>
                        </header>
                        <ul class="profiles" id="profiles"></ul>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Terminal GNSS</h2>
                                <p class="card__subtitle">Ver y enviar comandos AT/ASCII al receptor</p>
                            </div>
                        </header>
                        <div class="form" id="terminalPanel">
                            <form id="cmdForm" class="form__row" onsubmit="return false;">
                                <div class="form__group" style="flex:1;">
                                    <label class="form__label" for="cmdInput">Comando</label>
                                    <input class="form__input" id="cmdInput" name="cmdInput" placeholder="Ej: TILTCOMPENSATION ENABLE" />
                                </div>
                                <div class="form__group" style="align-self:flex-end; display:flex; gap:8px;">
                                    <button type="submit" class="primary-btn" id="cmdSendBtn">
                                        <i data-lucide="send"></i>
                                        Enviar
                                    </button>
                                    <button type="button" class="ghost-btn" id="cmdClearBtn">
                                        <i data-lucide="trash-2"></i>
                                        Limpiar
                                    </button>
                                </div>
                            </form>
                            <div id="terminalLog" class="terminal-log" style="margin-top:12px; max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:12px; background: rgba(17,28,55,0.45);">
                                <div class="terminal-log__empty" style="opacity:.7;">No hay mensajes aún. Usa comandos rápidos o escribe uno arriba.</div>
                            </div>
                        </div>
                    </article>
                </div>
            </section>
            <section class="view" id="filesView" aria-hidden="true">
                <div class="grid">
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Perfil de registro</h2>
                                <p class="card__subtitle">Formatos y automatización</p>
                            </div>
                            <button class="ghost-btn" id="loggingCardBtn">
                                <i data-lucide="sliders"></i>
                                Ajustar
                            </button>
                        </header>
                        <div class="logging-card" id="loggingCard"></div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Registros recientes</h2>
                        </header>
                        <ul class="files" id="fileList"></ul>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <div>
                                <h2 class="card__title">Captura fotogramétrica</h2>
                                <p class="card__subtitle">Fotos con metadatos EXIF listos para fotogrametría</p>
                            </div>
                            <button class="primary-btn" id="capturePhotoBtn" type="button">
                                <i data-lucide="camera"></i>
                                Tomar foto
                            </button>
                        </header>
                        <input type="file" id="photoInput" accept="image/*" capture="environment" hidden />
                        <div class="photo-log" id="photoLog">
                            <p class="photo-log__empty">Aún no hay capturas. Usa “Tomar foto” para registrar la primera.</p>
                        </div>
                    </article>
                    <article class="card">
                        <header class="card__header">
                            <h2 class="card__title">Sincronización</h2>
                        </header>
                        <div class="sync" id="syncPanel"></div>
                    </article>
                </div>
            </section>
        </main>
    </div>
    <div class="mobile-toolbar" id="mobileToolbar" aria-hidden="true">
        <button class="mobile-toolbar__btn" id="mobileRecordBtn" type="button">
            <i data-lucide="radio"></i>
            <span>Iniciar registro</span>
        </button>
        <button class="mobile-toolbar__btn is-secondary" id="mobileLoggingBtn" type="button">
            <i data-lucide="sliders-horizontal"></i>
            <span>Logging</span>
        </button>
        <button class="mobile-toolbar__btn is-secondary" id="mobileNtripBtn" type="button">
            <i data-lucide="share-2"></i>
            <span>NTRIP</span>
        </button>
    </div>
    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <div class="modal" id="pointModal" aria-hidden="true">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Registrar punto GNSS</h2>
                <button class="modal__close" type="button" data-modal-close>
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form class="form" id="pointForm">
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointName">Identificador</label>
                        <input class="form__input" id="pointName" name="pointName" required />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointCode">Código</label>
                        <input class="form__input" id="pointCode" name="pointCode" placeholder="P-025" />
                    </div>
                </div>
                <div class="form__group">
                    <label class="form__label" for="pointDescription">Descripción</label>
                    <textarea class="form__textarea" id="pointDescription" name="pointDescription" placeholder="Mojón, eje de vía, vértice de control…"></textarea>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointCategory">Clasificación</label>
                        <select class="form__select" id="pointCategory" name="pointCategory">
                            <option value="topografia">Topografía</option>
                            <option value="control">Control geodésico</option>
                            <option value="fotogrametria">Fotogrametría</option>
                            <option value="catastro">Catastro</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointNotes">Notas rápidas</label>
                        <input class="form__input" id="pointNotes" name="pointNotes" placeholder="Altura prisma, responsable…" />
                    </div>
                </div>
                <span class="modal__section-title">Coordenadas WGS84</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointLat">Latitud (°)</label>
                        <input class="form__input" type="number" step="0.000001" id="pointLat" name="pointLat" readonly />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointLon">Longitud (°)</label>
                        <input class="form__input" type="number" step="0.000001" id="pointLon" name="pointLon" readonly />
                    </div>
                </div>
                <span class="modal__section-title">Coordenadas UTM (WGS84)</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointZone">Zona</label>
                        <input class="form__input" id="pointZone" name="pointZone" readonly />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointHemisphere">Hemisferio</label>
                        <input class="form__input" id="pointHemisphere" name="pointHemisphere" readonly />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointEasting">Este (m)</label>
                        <input class="form__input" type="number" step="0.001" id="pointEasting" name="pointEasting" readonly />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointNorthing">Norte (m)</label>
                        <input class="form__input" type="number" step="0.001" id="pointNorthing" name="pointNorthing" readonly />
                    </div>
                </div>
                <span class="modal__section-title">Alturas (EGM2008)</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointAltitude">Altura elipsoidal (m)</label>
                        <input class="form__input" type="number" step="0.01" id="pointAltitude" name="pointAltitude" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointGeoid">Separación geoidal (m)</label>
                        <input class="form__input" type="number" step="0.01" id="pointGeoid" name="pointGeoid" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointOrthometric">Altura ortométrica (m)</label>
                        <input class="form__input" type="number" step="0.01" id="pointOrthometric" name="pointOrthometric" readonly />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="pointPoleHeight">Altura del bastón (m)</label>
                        <input class="form__input" type="number" step="0.01" id="pointPoleHeight" name="pointPoleHeight" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointApcOffset">Offset APC (m)</label>
                        <input class="form__input" type="number" step="0.001" id="pointApcOffset" name="pointApcOffset" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="pointUseTilt">Usar Tilt/IMU</label>
                        <label class="switch">
                            <input type="checkbox" id="pointUseTilt" name="pointUseTilt" />
                            <span class="switch__label">Ajustar al tip del bastón</span>
                        </label>
                    </div>
                </div>
                <div class="modal__footer">
                    <button type="button" class="ghost-btn" data-modal-close>Cancelar</button>
                    <button type="submit" class="primary-btn">Guardar punto</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="projectModal" aria-hidden="true">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Gestionar proyecto</h2>
                <button class="modal__close" type="button" data-modal-close>
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form class="form" id="projectForm">
                <div class="form__group">
                    <label class="form__label" for="projectName">Nombre del proyecto</label>
                    <input class="form__input" id="projectName" name="projectName" required />
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectLocation">Zona / ubicación</label>
                        <input class="form__input" id="projectLocation" name="projectLocation" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectOwner">Responsable</label>
                        <input class="form__input" id="projectOwner" name="projectOwner" />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectAccuracy">Precisión objetivo</label>
                        <input class="form__input" id="projectAccuracy" name="projectAccuracy" placeholder="Ej. 2 cm RMS" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectCode">Código interno</label>
                        <input class="form__input" id="projectCode" name="projectCode" placeholder="GNSS-2024-TRU" />
                    </div>
                </div>
                <div class="form__group">
                    <label class="form__label" for="projectNotes">Notas</label>
                    <textarea class="form__textarea" id="projectNotes" name="projectNotes" placeholder="Observaciones, referencias de control o requerimientos"></textarea>
                </div>
                <span class="modal__section-title">Sistema de coordenadas y datum</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectDatum">Datum</label>
                        <select class="form__input" id="projectDatum" name="projectDatum">
                            <option value="WGS84">WGS84</option>
                            <option value="SIRGAS2000">SIRGAS2000</option>
                            <option value="PSAD56">PSAD56</option>
                            <option value="NAD83">NAD83</option>
                        </select>
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectCoordinateSystem">Sistema</label>
                        <select class="form__input" id="projectCoordinateSystem" name="projectCoordinateSystem">
                            <option value="UTM">UTM</option>
                            <option value="Geographic">Geográfico (Lat/Lon)</option>
                            <option value="Local">Local</option>
                        </select>
                    </div>
                </div>
                <span class="modal__section-title">Configuración de instrumento</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectPoleHeight">Altura del bastón (m)</label>
                        <input class="form__input" type="number" step="0.01" id="projectPoleHeight" name="projectPoleHeight" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectApcOffset">Offset APC (m)</label>
                        <input class="form__input" type="number" step="0.001" id="projectApcOffset" name="projectApcOffset" />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectGeoidModel">Modelo geoidal</label>
                        <select class="form__input" id="projectGeoidModel" name="projectGeoidModel">
                            <option value="EGM2008">EGM2008</option>
                            <option value="EGM96">EGM96</option>
                            <option value="Local">Local</option>
                        </select>
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectHeightType">Tipo de altura</label>
                        <select class="form__input" id="projectHeightType" name="projectHeightType">
                            <option value="Ellipsoidal">Elipsoidal</option>
                            <option value="Orthometric">Ortométrica</option>
                        </select>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="projectUnit">Unidad</label>
                        <select class="form__input" id="projectUnit" name="projectUnit">
                            <option value="Meters">Metros</option>
                            <option value="Feet">Pies</option>
                            <option value="US Survey Feet">Pies US</option>
                        </select>
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="projectPrecision">Decimales</label>
                        <select class="form__input" id="projectPrecision" name="projectPrecision">
                            <option value="2">2 (cm)</option>
                            <option value="3">3 (mm)</option>
                            <option value="4">4 (0.1mm)</option>
                        </select>
                    </div>
                </div>
                <span class="modal__section-title">Stakeout previsto</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="stakeoutTarget">Objetivo</label>
                        <input class="form__input" id="stakeoutTarget" name="stakeoutTarget" placeholder="P-023" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="stakeoutDistance">Distancia estimada (m)</label>
                        <input class="form__input" type="number" step="0.01" id="stakeoutDistance" name="stakeoutDistance" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="stakeoutBearing">Rumbo previsto (°)</label>
                        <input class="form__input" type="number" step="0.1" id="stakeoutBearing" name="stakeoutBearing" />
                    </div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="projectReset" name="projectReset" />
                    <span class="switch__label">Vaciar la lista de puntos al crear un nuevo proyecto</span>
                </label>
                <div class="modal__footer">
                    <button type="button" class="ghost-btn" data-modal-close>Cancelar</button>
                    <button type="submit" class="primary-btn">Guardar proyecto</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="ntripModal" aria-hidden="true">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Configuración NTRIP</h2>
                <button class="modal__close" type="button" data-modal-close>
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal__toolbar">
                <button type="button" class="ghost-btn" id="ntripShareLink">
                    <i data-lucide="share-2"></i>
                    Generar enlace
                </button>
                <button type="button" class="ghost-btn" id="ntripShareToken">
                    <i data-lucide="copy"></i>
                    Copiar token
                </button>
            </div>
            <form class="form" id="ntripForm">
                <label class="switch">
                    <input type="checkbox" id="ntripEnabled" name="ntripEnabled" />
                    <span class="switch__label">Activar sesión NTRIP</span>
                </label>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="ntripCaster">Caster / host</label>
                        <input class="form__input" id="ntripCaster" name="ntripCaster" placeholder="caster.midominio.com" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="ntripPort">Puerto</label>
                        <input class="form__input" type="number" id="ntripPort" name="ntripPort" placeholder="2101" />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="ntripMountpoint">Mountpoint</label>
                        <input class="form__input" id="ntripMountpoint" name="ntripMountpoint" placeholder="K922_RT" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="ntripFormat">Formato RTCM</label>
                        <select class="form__select" id="ntripFormat" name="ntripFormat">
                            <option value="RTCM 3.0">RTCM 3.0</option>
                            <option value="RTCM 3.2">RTCM 3.2</option>
                            <option value="RTCM 3.3">RTCM 3.3</option>
                            <option value="MSM4">MSM4</option>
                            <option value="MSM7">MSM7</option>
                        </select>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="ntripUser">Usuario</label>
                        <input class="form__input" id="ntripUser" name="ntripUser" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="ntripPass">Contraseña</label>
                        <input class="form__input" type="password" id="ntripPass" name="ntripPass" />
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="ntripBitrate">Bitrate esperado</label>
                        <input class="form__input" id="ntripBitrate" name="ntripBitrate" placeholder="56 kbps" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="ntripLatency">Latencia objetivo (s)</label>
                        <input class="form__input" type="number" step="0.1" id="ntripLatency" name="ntripLatency" />
                    </div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="ntripSsl" name="ntripSsl" />
                    <span class="switch__label">Usar TLS/SSL (https)</span>
                </label>
                <div class="form__group">
                    <label class="form__label" for="ntripNotes">Notas o recordatorios</label>
                    <textarea class="form__textarea" id="ntripNotes" name="ntripNotes" placeholder="Credenciales de respaldo, IP alterna, etc."></textarea>
                </div>
                <div class="form__group">
                    <label class="form__label" for="ntripTransfer">Importar / compartir</label>
                    <textarea class="form__textarea" id="ntripTransfer" name="ntripTransfer" placeholder="Pega un enlace o token GNSS.AI NTRIP"></textarea>
                    <p class="form__hint" id="ntripTransferStatus">Genera un enlace para compartir con otro dispositivo o pega uno existente.</p>
                    <div class="form__toolbar">
                        <button type="button" class="ghost-btn" id="ntripImportApply">
                            <i data-lucide="download"></i>
                            Aplicar token
                        </button>
                        <button type="button" class="ghost-btn" id="ntripTransferClear">
                            <i data-lucide="eraser"></i>
                            Limpiar
                        </button>
                    </div>
                </div>
                <div class="modal__footer">
                    <button type="button" class="ghost-btn" data-modal-close>Cancelar</button>
                    <button type="submit" class="primary-btn">Guardar NTRIP</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="loggingModal" aria-hidden="true">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Ajustes de logging</h2>
                <button class="modal__close" type="button" data-modal-close>
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form class="form" id="loggingForm">
                <div class="modal__badges">
                    <span class="tag" id="loggingStorageBadge"></span>
                    <span class="tag tag--success" id="loggingAutoBadge"></span>
                </div>
                <span class="modal__section-title">Formatos</span>
                <div class="divider"></div>
                <label class="switch">
                    <input type="checkbox" id="loggingNmea" name="loggingNmea" />
                    <span class="switch__label">Registrar NMEA (GGA, GST, VTG)</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="loggingRinex" name="loggingRinex" />
                    <span class="switch__label">Generar RINEX automático</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="loggingRtcm" name="loggingRtcm" />
                    <span class="switch__label">Guardar flujo RTCM crudo</span>
                </label>
                <span class="modal__section-title">Automatización</span>
                <div class="divider"></div>
                <label class="switch">
                    <input type="checkbox" id="loggingAuto" name="loggingAuto" />
                    <span class="switch__label">Subir automáticamente a la nube</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="loggingAutoStart" name="loggingAutoStart" />
                    <span class="switch__label">Iniciar cuando la solución sea RTK Fixed</span>
                </label>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="loggingInterval">Intervalo (s)</label>
                        <input class="form__input" type="number" min="1" id="loggingInterval" name="loggingInterval" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="loggingPath">Almacenamiento</label>
                        <input class="form__input" id="loggingPath" name="loggingPath" placeholder="/data/gnss/logs" />
                    </div>
                </div>
                <div class="form__group">
                    <label class="form__label" for="loggingDestination">Destino en la nube</label>
                    <input class="form__input" id="loggingDestination" name="loggingDestination" placeholder="GNSS Cloud" />
                </div>
                <div class="form__group">
                    <label class="form__label" for="loggingNotes">Notas</label>
                    <textarea class="form__textarea" id="loggingNotes" name="loggingNotes" placeholder="Observaciones de campo, responsables del respaldo..."></textarea>
                </div>
                <div class="modal__footer">
                    <button type="button" class="ghost-btn" data-modal-close>Cancelar</button>
                    <button type="submit" class="primary-btn">Guardar perfil</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="stakeoutModal" aria-hidden="true">
        <div class="modal__content">
            <div class="modal__header">
                <h2 class="modal__title">Configuración de replanteo</h2>
                <button class="modal__close" type="button" data-modal-close>
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form class="form" id="stakeoutForm">
                <div class="form__group">
                    <label class="form__label" for="stakeoutPoint">Selecciona un punto guardado</label>
                    <input class="form__input" id="stakeoutSearch" name="stakeoutSearch" placeholder="Buscar por nombre o código" />
                    <select class="form__select" id="stakeoutPoint" name="stakeoutPoint"></select>
                </div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="stakeoutTolerance">Tolerancia horizontal (m)</label>
                        <input class="form__input" type="number" step="0.01" id="stakeoutTolerance" name="stakeoutTolerance" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="stakeoutPole">Altura de prisma / varilla (m)</label>
                        <input class="form__input" type="number" step="0.01" id="stakeoutPole" name="stakeoutPole" />
                    </div>
                </div>
                <span class="modal__section-title">Coordenadas manuales</span>
                <div class="divider"></div>
                <div class="form__row">
                    <div class="form__group">
                        <label class="form__label" for="stakeoutLat">Latitud</label>
                        <input class="form__input" type="number" step="0.000001" id="stakeoutLat" name="stakeoutLat" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="stakeoutLon">Longitud</label>
                        <input class="form__input" type="number" step="0.000001" id="stakeoutLon" name="stakeoutLon" />
                    </div>
                    <div class="form__group">
                        <label class="form__label" for="stakeoutAlt">Altura</label>
                        <input class="form__input" type="number" step="0.01" id="stakeoutAlt" name="stakeoutAlt" />
                    </div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="stakeoutManual" name="stakeoutManual" />
                    <span class="switch__label">Usar coordenadas manuales en lugar del punto seleccionado</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="stakeoutActiveToggle" name="stakeoutActiveToggle" />
                    <span class="switch__label">Mantener replanteo activo tras guardar</span>
                </label>
                <div class="form__group">
                    <label class="form__label" for="stakeoutNotes">Instrucciones para la cuadrilla</label>
                    <textarea class="form__textarea" id="stakeoutNotes" name="stakeoutNotes" placeholder="Ajustar altura de prisma, acercarse por el norte, etc."></textarea>
                </div>
                <div class="modal__footer">
                    <button type="button" class="ghost-btn" data-modal-close>Cancelar</button>
                    <button type="submit" class="primary-btn">Guardar replanteo</button>
                </div>
            </form>
        </div>
    </div>
    <script type="module">
const body = document.body;
const toast = document.getElementById('toast');
const views = {
    overview: document.getElementById('overviewView'),
    survey: document.getElementById('surveyView'),
    satellites: document.getElementById('satellitesView'),
    control: document.getElementById('controlView'),
    files: document.getElementById('filesView')
};

// Theme helpers
function applyTheme() {
    if (state.theme === 'light') {
        document.body.classList.add('light');
    } else {
        document.body.classList.remove('light');
    }
}

// Terminal log helper
function appendTerminalLog(entry) {
    const log = document.getElementById('terminalLog');
    if (!log) return;
    const empty = log.querySelector('.terminal-log__empty');
    if (empty) empty.remove();
    const time = new Date();
    const ts = time.toLocaleTimeString([], { hour12: false });
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '8px';
    row.style.marginBottom = '6px';
    const badge = document.createElement('span');
    badge.textContent = entry.dir === 'TX' ? 'TX' : 'RX';
    badge.style.fontWeight = '600';
    badge.style.fontSize = '12px';
    badge.style.padding = '2px 6px';
    badge.style.borderRadius = '6px';
    badge.style.background = entry.dir === 'TX' ? 'rgba(50,212,255,.18)' : 'rgba(15,240,120,.18)';
    badge.style.border = '1px solid var(--border)';
    const text = document.createElement('code');
    text.textContent = `[${ts}] ${entry.text}`;
    text.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, monospace';
    text.style.fontSize = '12px';
    text.style.opacity = '.95';
    row.appendChild(badge);
    row.appendChild(text);
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
}

function updateRtkBanner() {
    const { gnss } = state;
    const banner = document.getElementById('rtkBanner');
    if (!banner) return;
    const fixEl = document.getElementById('rtkBannerFix');
    const hdopEl = document.getElementById('rtkBannerHdop');
    const satsEl = document.getElementById('rtkBannerSats');
    const ageEl = document.getElementById('rtkBannerAge');

    fixEl.textContent = gnss.fix || '—';
    hdopEl.textContent = Number.isFinite(gnss.hdop) ? gnss.hdop.toFixed(1) : '—';
    satsEl.textContent = Number.isFinite(gnss.satellites) ? String(gnss.satellites) : '—';
    ageEl.textContent = Number.isFinite(gnss.age) ? `${gnss.age.toFixed(1)}s` : '—';

    banner.classList.remove('rtk-banner--warn', 'rtk-banner--error');
    const show = !!gnss && !!gnss.fix && gnss.fix !== 'Sin solución';
    if (show) {
        banner.classList.add('is-visible');
        if (gnss.fix === 'Float' || (Number.isFinite(gnss.hdop) && gnss.hdop > 1.5)) {
            banner.classList.add('rtk-banner--warn');
        }
        if (gnss.fix === 'Autonomous' || gnss.fix === 'Single') {
            banner.classList.add('rtk-banner--error');
        }
    } else {
        banner.classList.remove('is-visible');
    }
}

const STORAGE_KEY = 'gnssai.console.preferences.v1';
let persistTimer;
let pendingNtripNotice = null;
let geolocationWarningShown = false;

function storageAvailable() {
    try {
        const testKey = '__gnssai_test__';
        localStorage.setItem(testKey, '1');
        localStorage.removeItem(testKey);
        return true;
    } catch (error) {
        console.warn('Persistencia deshabilitada:', error);
        return false;
    }
}

const canPersist = typeof window !== 'undefined' && typeof localStorage !== 'undefined' && storageAvailable();

function readStoredState() {
    if (!canPersist) return null;
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try {
        return JSON.parse(raw);
    } catch (error) {
        console.warn('No se pudo parsear el estado guardado', error);
        return null;
    }
}

function writeStoredState() {
    if (!canPersist) return;
    const payload = {
        gnss: {
            latitude: state.gnss.latitude,
            longitude: state.gnss.longitude,
            altitude: state.gnss.altitude,
            source: state.gnss.source,
            updatedAt: state.gnss.updatedAt,
            utm: state.gnss.utm,
            locked: state.gnss.locked,
            geoidSeparation: state.gnss.geoidSeparation,
            orthometric: state.gnss.orthometric
        },
        ntrip: state.ntrip,
        logging: state.logging,
        project: state.project,
        stakeout: state.stakeout,
        points: state.points,
        mapLayer: state.mapLayer,
        photos: state.photos,
        vendor: state.vendor,
        theme: state.theme
    };
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch (error) {
        console.warn('No se pudo guardar el estado', error);
    }
}

function queuePersist() {
    if (!canPersist) return;
    clearTimeout(persistTimer);
    persistTimer = setTimeout(writeStoredState, 250);
}

function encodeBase64(value) {
    if (typeof TextEncoder !== 'undefined') {
        const bytes = new TextEncoder().encode(value);
        let binary = '';
        bytes.forEach(byte => {
            binary += String.fromCharCode(byte);
        });
        return btoa(binary);
    }
    return btoa(unescape(encodeURIComponent(value)));
}

function decodeBase64(value) {
    try {
        const normalized = value.replace(/-/g, '+').replace(/_/g, '/');
        const padded = normalized + '='.repeat((4 - (normalized.length % 4)) % 4);
        const binary = atob(padded);
        if (typeof TextDecoder !== 'undefined') {
            const bytes = Uint8Array.from(binary, char => char.charCodeAt(0));
            return new TextDecoder().decode(bytes);
        }
        return decodeURIComponent(escape(binary));
    } catch (error) {
        console.warn('No se pudo decodificar Base64', error);
        return null;
    }
}

function encodeNtripProfile(profile) {
    const payload = { ntrip: profile };
    return encodeBase64(JSON.stringify(payload)).replace(/=+$/, '').replace(/\+/g, '-').replace(/\//g, '_');
}

function decodeNtripPayload(raw) {
    if (!raw) return null;
    let token = raw.trim();
    try {
        if (/^https?:/.test(token) || token.includes('ntrip=') || token.startsWith('#')) {
            const virtualUrl = token.startsWith('#') ? new URL(`${window.location.origin}${window.location.pathname}${token}`) : new URL(token, window.location.origin);
            token = virtualUrl.searchParams.get('ntrip') || new URLSearchParams(virtualUrl.hash.replace('#', '')).get('ntrip') || token;
        }
    } catch (error) {
        console.warn('URL NTRIP inválida', error);
    }
    token = token.replace(/[^A-Za-z0-9\-_]/g, '');
    if (!token) return null;
    const decoded = decodeBase64(token);
    if (!decoded) return null;
    try {
        const parsed = JSON.parse(decoded);
        if (parsed && typeof parsed === 'object') {
            return parsed.ntrip || parsed;
        }
    } catch (error) {
        console.warn('JSON NTRIP inválido', error);
    }
    return null;
}

function sanitizeNtripProfile(profile = state.ntrip) {
    const {
        enabled,
        caster,
        port,
        mountpoint,
        username,
        password,
        format,
        bitrate,
        latency,
        ssl,
        notes
    } = profile;
    return {
        enabled,
        caster,
        port,
        mountpoint,
        username,
        password,
        format,
        bitrate,
        latency,
        ssl,
        notes
    };
}

function buildNtripSharePackage() {
    const profile = sanitizeNtripProfile();
    const token = encodeNtripProfile(profile);
    const url = new URL(window.location.href);
    url.searchParams.set('ntrip', token);
    return {
        profile,
        token,
        url: url.toString()
    };
}

function copyToClipboard(text, message) {
    if (!text) return;
    if (!navigator.clipboard || typeof navigator.clipboard.writeText !== 'function') {
        console.warn('API de portapapeles no disponible');
        if (message) {
            showToast('Portapapeles no disponible');
        }
        return;
    }
    navigator.clipboard
        .writeText(text)
        .then(() => {
            if (message) {
                showToast(message);
            }
        })
        .catch(error => {
            console.warn('No se pudo copiar al portapapeles', error);
        });
}

function applyNtripProfile(data) {
    if (!data) return false;
    state.ntrip = { ...state.ntrip, ...data };
    state.ntrip.lastConnect = data.lastConnect || state.ntrip.lastConnect;
    queuePersist();
    updateNtripCard();
    updateServices();
    updateStatusCards();
    populateNtripForm();
    return true;
}

function applyNtripFromUrl() {
    if (typeof window === 'undefined') return;
    try {
        const current = new URL(window.location.href);
        const searchToken = current.searchParams.get('ntrip');
        const hashParams = new URLSearchParams(current.hash.replace('#', ''));
        const hashToken = hashParams.get('ntrip');
        const token = searchToken || hashToken;
        if (!token) return;
        const profile = decodeNtripPayload(token);
        if (applyNtripProfile(profile)) {
            pendingNtripNotice = 'Perfil NTRIP importado desde enlace';
        } else {
            pendingNtripNotice = 'No se pudo importar el perfil NTRIP';
        }
        current.searchParams.delete('ntrip');
        if (hashToken) {
            hashParams.delete('ntrip');
            const newHash = hashParams.toString();
            current.hash = newHash ? `#${newHash}` : '';
        }
        window.history.replaceState({}, document.title, `${current.pathname}${current.search}${current.hash}`);
    } catch (error) {
        console.warn('No se pudo aplicar NTRIP desde la URL', error);
    }
}

const state = {
    mode: 'Rover',
    recording: false,
    sessionStart: Date.now(),
    vendor: 'ComNav',
    theme: 'dark',
    mapLayer: 'hybrid',
    gnss: {
        latitude: -9.189967,
        longitude: -75.015152,
        altitude: 0,
        horizontalAccuracy: 0.05,
        hdop: 0.8,
        satellites: 24,
        fix: 'Float',
        age: 1.8,
        source: 'ComNav K222',
        updatedAt: Date.now(),
        utm: null,
        locked: false,
        geoidSeparation: null,
        orthometric: null
    },
    imu: {
        tilt: 1.6,
        heading: 81.2,
        pitch: 0.5,
        roll: -0.2,
        calibrated: true,
        drift: 0.03,
        fusion: 'GNSS + IMU'
    },
    services: [
        { name: 'L-Band PPP', status: 'Sincronizando', tone: 'is-warning' },
        { name: 'NTRIP Caster', status: 'Correcciones 1.2s', tone: 'is-active' },
        { name: 'Radio LoRa', status: 'Stand-by', tone: '' },
        { name: 'Ethernet', status: 'Desconectado', tone: 'is-danger' }
    ],
    constellations: [
        { name: 'GPS', count: 12, snr: 41, color: '#5be7a9' },
        { name: 'GLONASS', count: 6, snr: 38, color: '#ffc75f' },
        { name: 'Galileo', count: 5, snr: 44, color: '#32d4ff' },
        { name: 'BeiDou', count: 4, snr: 37, color: '#ff94d5' }
    ],
    satellites: [],
    project: {
        name: 'Proyecto GNSS.AI',
        location: 'Zona UTM pendiente',
        owner: 'GNSS.AI Labs',
        accuracy: '—',
        code: 'K922',
        notes: 'Define ubicación inicial desde el panel GNSS.',
        datum: 'WGS84',
        coordinateSystem: 'UTM',
        utmZone: 'Auto',
        hemisphere: 'Auto',
        geoidModel: 'EGM2008',
        heightType: 'Ellipsoidal',
        unit: 'Meters',
        precision: 3,
        poleHeight: 1.80,
        apcOffset: 0.12,
        stakeout: {
            target: '—',
            distance: 0,
            bearing: 0
        }
    },
    points: [],
    events: [
        { title: 'Correcciones RTCM aplicadas', time: 'Hace 45s' },
        { title: 'IMU calibrada correctamente', time: 'Hace 3m' },
        { title: 'Proyecto sincronizado con GNSS Cloud', time: 'Hace 12m' }
    ],
    stakeout: {
        active: false,
        targetId: null,
        tolerance: 0.05,
        poleHeight: 2.0,
        mode: 'point',
        manual: null,
        guidance: '',
        offsets: { north: 0, east: 0, up: 0 }
    },
    files: [
        { name: '2024-02-22_trujillo_session.obs', size: '18.2 MB', time: 'Hace 4 min' },
        { name: 'projects_backup.json', size: '256 KB', time: 'Hoy 09:00' }
    ],
    photos: [],
    sync: {
        drive: true,
        lastSync: 'Hoy · 09:00',
        pending: 2
    },
    ntrip: {
        enabled: true,
        caster: 'caster.gnss.ai',
        port: 2101,
        mountpoint: 'K922_RT',
        username: 'gnssai-rover',
        password: 'K922@field',
        format: 'RTCM 3.2',
        bitrate: '56 kbps',
        latency: 1.2,
        ssl: true,
        notes: 'Caster redundante disponible en :2102',
        lastConnect: 'Hace 45 s'
    },
    logging: {
        nmea: true,
        rinex: true,
        rtcm: false,
        autoUpload: true,
        autoStart: true,
        interval: 1,
        path: '/data/gnss/logs',
        destination: 'GNSS Cloud',
        notes: 'Sincronizar al finalizar la jornada',
        startedAutomatically: false
    },
    snrHistory: Array.from({ length: 10 }, (_, i) => ({
        label: `-${10 - i}s`,
        gps: 40 + Math.random() * 5,
        glonass: 35 + Math.random() * 5,
        galileo: 38 + Math.random() * 5
    })),
    satellites: []
};

function hydrateFromStorage() {
    const saved = readStoredState();
    if (!saved) {
        const geoid = Number.isFinite(state.gnss.geoidSeparation)
            ? state.gnss.geoidSeparation
            : resolveGeoidSeparation(state.gnss.latitude, state.gnss.longitude);
        const orthometric = computeOrthometricHeight(state.gnss.altitude, geoid);
        if (Number.isFinite(geoid)) {
            state.gnss.geoidSeparation = geoid;
        }
        if (Number.isFinite(orthometric)) {
            state.gnss.orthometric = orthometric;
        }
        if (!state.gnss.updatedAt) {
            state.gnss.updatedAt = Date.now();
        }
        return;
    }
    if (saved.mapLayer) {
        state.mapLayer = saved.mapLayer;
    }
    if (saved.ntrip) {
        state.ntrip = { ...state.ntrip, ...saved.ntrip };
    }
    if (saved.logging) {
        state.logging = { ...state.logging, ...saved.logging };
    }
    if (saved.project) {
        state.project = { ...state.project, ...saved.project };
    }
    if (saved.stakeout) {
        state.stakeout = { ...state.stakeout, ...saved.stakeout };
    }
    if (saved.gnss) {
        const geoid = Number.isFinite(saved.gnss.geoidSeparation)
            ? saved.gnss.geoidSeparation
            : resolveGeoidSeparation(saved.gnss.latitude, saved.gnss.longitude, state.gnss.geoidSeparation);
        const orthometric = computeOrthometricHeight(saved.gnss.altitude, geoid);
        state.gnss = {
            ...state.gnss,
            ...saved.gnss,
            geoidSeparation: Number.isFinite(geoid) ? geoid : state.gnss.geoidSeparation,
            orthometric: Number.isFinite(orthometric) ? orthometric : state.gnss.orthometric,
            utm: saved.gnss.utm || (Number.isFinite(saved.gnss.latitude) && Number.isFinite(saved.gnss.longitude) ? latLonToUtm(saved.gnss.latitude, saved.gnss.longitude) : state.gnss.utm),
            updatedAt: saved.gnss.updatedAt || state.gnss.updatedAt || Date.now()
        };
    }
    if (Array.isArray(saved.points)) {
        state.points = saved.points.map(point => {
            const geoid = Number.isFinite(point.geoidSeparation)
                ? point.geoidSeparation
                : resolveGeoidSeparation(point.lat, point.lon, state.gnss.geoidSeparation);
            const orthometric = Number.isFinite(point.orthometric)
                ? point.orthometric
                : computeOrthometricHeight(point.alt, geoid);
            return {
                ...point,
                utm: point.utm ? { ...point.utm } : latLonToUtm(point.lat, point.lon),
                geoidSeparation: geoid,
                orthometric
            };
        });
    }
    if (Array.isArray(saved.photos)) {
        state.photos = saved.photos.map(photo => {
            const metadata = photo.metadata || {};
            const lat = metadata.latitude;
            const lon = metadata.longitude;
            const geoid = Number.isFinite(metadata.geoid)
                ? metadata.geoid
                : resolveGeoidSeparation(lat, lon, state.gnss.geoidSeparation);
            const utm = metadata.utm
                ? { ...metadata.utm }
                : Number.isFinite(lat) && Number.isFinite(lon)
                ? latLonToUtm(lat, lon)
                : null;
            const altitude = metadata.altitude;
            const orthometric = Number.isFinite(metadata.orthometric)
                ? metadata.orthometric
                : Number.isFinite(altitude) && Number.isFinite(geoid)
                ? computeOrthometricHeight(altitude, geoid)
                : null;
            return {
                ...photo,
                metadata: {
                    ...metadata,
                    utm,
                    geoid,
                    orthometric
                }
            };
        });
    }
    if (saved.project?.stakeout) {
        state.project.stakeout = { ...state.project.stakeout, ...saved.project.stakeout };
    }
}

let map;
let mapMarker;
let hybridLayer;
let topoLayer;
let snrChart;
let pointLayer;

function chartAxisColor() {
    return body.classList.contains('light') ? 'rgba(26,34,52,0.55)' : 'rgba(255,255,255,0.6)';
}

function chartGridColor() {
    return body.classList.contains('light') ? 'rgba(26,34,52,0.08)' : 'rgba(255,255,255,0.1)';
}

function formatCoord(value) {
    return `${value.toFixed(7)}°`;
}

function formatMeters(value, decimals = 2) {
    return `${value.toFixed(decimals)} m`;
}

const EGM2008_GRID = {
    lats: [-20, -16, -12, -8, -4, 0, 4],
    lons: [-85, -81, -77, -73, -69],
    values: [
        [-4.6, -6.2, -8.4, -10.1, -12.2],
        [-9.3, -11.5, -14.2, -16.3, -18.7],
        [-13.8, -16.5, -19.6, -22.4, -24.8],
        [-18.5, -21.3, -24.6, -27.5, -29.8],
        [-22.1, -24.8, -27.9, -30.6, -32.4],
        [-24.4, -26.9, -29.5, -31.8, -33.1],
        [-25.5, -27.7, -29.9, -31.6, -32.2]
    ]
};

function clamp(value, min, max) {
    return Math.max(min, Math.min(max, value));
}

function lookupEgm2008(lat, lon) {
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
    const { lats, lons, values } = EGM2008_GRID;
    const clampedLat = clamp(lat, lats[0], lats[lats.length - 1]);
    const clampedLon = clamp(lon, lons[0], lons[lons.length - 1]);

    const findBracket = (array, target) => {
        let lowerIndex = 0;
        for (let i = 0; i < array.length - 1; i += 1) {
            if (target >= array[i] && target <= array[i + 1]) {
                lowerIndex = i;
                break;
            }
            if (target > array[i + 1]) {
                lowerIndex = i + 1;
            }
        }
        const upperIndex = Math.min(lowerIndex + 1, array.length - 1);
        return [lowerIndex, upperIndex];
    };

    const [latLowIdx, latHighIdx] = findBracket(lats, clampedLat);
    const [lonLowIdx, lonHighIdx] = findBracket(lons, clampedLon);

    const latLow = lats[latLowIdx];
    const latHigh = lats[latHighIdx];
    const lonLow = lons[lonLowIdx];
    const lonHigh = lons[lonHighIdx];
    const latRange = latHigh - latLow || 1;
    const lonRange = lonHigh - lonLow || 1;
    const latT = (clampedLat - latLow) / latRange;
    const lonT = (clampedLon - lonLow) / lonRange;

    const q11 = values[latLowIdx][lonLowIdx];
    const q12 = values[latLowIdx][lonHighIdx];
    const q21 = values[latHighIdx][lonLowIdx];
    const q22 = values[latHighIdx][lonHighIdx];

    const interpolate = (a, b, t) => a + (b - a) * t;
    const r1 = interpolate(q11, q12, lonT);
    const r2 = interpolate(q21, q22, lonT);
    return interpolate(r1, r2, latT);
}

function resolveGeoidSeparation(lat, lon, fallback = -28) {
    const approx = lookupEgm2008(lat, lon);
    if (Number.isFinite(approx)) {
        return approx;
    }
    if (Number.isFinite(fallback)) {
        return fallback;
    }
    return -28;
}

function computeOrthometricHeight(ellipsoidal, geoid) {
    if (!Number.isFinite(ellipsoidal) || !Number.isFinite(geoid)) {
        return null;
    }
    return ellipsoidal - geoid;
}

function formatDateTimeLocal(date = new Date()) {
    const pad = value => String(value).padStart(2, '0');
    const year = date.getFullYear();
    const month = pad(date.getMonth() + 1);
    const day = pad(date.getDate());
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

function deriveNextPointName() {
    const base = state.points
        .map(point => {
            const match = /\d+/.exec(point.name || '');
            return match ? parseInt(match[0], 10) : null;
        })
        .filter(Number.isFinite);
    const nextNumber = base.length ? Math.max(...base) + 1 : 1;
    return `P-${String(nextNumber).padStart(3, '0')}`;
}

function escapeHtml(value) {
    return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatRelativeTime(timestamp) {
    if (!Number.isFinite(timestamp)) return '—';
    const diff = Date.now() - timestamp;
    if (diff < 0) return 'en curso';
    const seconds = Math.floor(diff / 1000);
    if (seconds < 45) return 'hace segundos';
    if (seconds < 90) return 'hace 1 minuto';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 45) return `hace ${minutes} min`;
    if (minutes < 90) return 'hace 1 hora';
    const hours = Math.floor(minutes / 60);
    if (hours < 22) return `hace ${hours} h`;
    const days = Math.floor(hours / 24);
    if (days < 26) return `hace ${days} d`;
    const date = new Date(timestamp);
    return date.toLocaleString('es-PE', {
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatTimestamp(value) {
    const date = value ? new Date(value) : null;
    if (!date || Number.isNaN(date.getTime())) {
        return '—';
    }
    return date.toLocaleString('es-PE', {
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function formatExposure(value) {
    if (!value) return '—';
    if (value >= 1) {
        return `${value.toFixed(2)} s`;
    }
    const denominator = Math.round(1 / value);
    return `1/${denominator}`;
}

function formatFNumber(value) {
    if (!value) return '—';
    return `f/${parseFloat(value).toFixed(1)}`;
}

function formatFocalLength(value) {
    if (!value) return '—';
    return `${parseFloat(value).toFixed(1)} mm`;
}

function formatSpeed(value) {
    if (!Number.isFinite(value)) return '—';
    return `${value.toFixed(value >= 10 ? 0 : 2)} m/s`;
}

function formatBytes(bytes) {
    if (!Number.isFinite(bytes)) return '—';
    if (bytes < 1024) return `${bytes} B`;
    const units = ['KB', 'MB', 'GB'];
    let value = bytes / 1024;
    let unit = units.shift();
    while (value >= 1024 && units.length) {
        value /= 1024;
        unit = units.shift();
    }
    return `${value.toFixed(value >= 100 ? 0 : 1)} ${unit}`;
}

function normalizeExifDate(value) {
    if (!value) return null;
    if (value instanceof Date) return value.toISOString();
    if (typeof value === 'number') {
        return new Date(value).toISOString();
    }
    if (typeof value === 'string') {
        const trimmed = value.trim();
        const match = trimmed.match(/^(\d{4}):(\d{2}):(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/);
        if (match) {
            return `${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:${match[6]}`;
        }
        const parsed = new Date(trimmed);
        if (!Number.isNaN(parsed.getTime())) {
            return parsed.toISOString();
        }
    }
    return null;
}

function showToast(message) {
    toast.textContent = message;
    toast.classList.add('is-visible');
    clearTimeout(showToast.timeout);
    showToast.timeout = setTimeout(() => {
        toast.classList.remove('is-visible');
    }, 2500);
}

function openModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    const focusable = modal.querySelector('input, select, textarea, button');
    if (focusable) {
        setTimeout(() => focusable.focus(), 60);
    }
}

function closeModal(target) {
    const modal = typeof target === 'string' ? document.getElementById(target) : target;
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    if (!document.querySelector('.modal.is-open')) {
        document.body.style.overflow = '';
    }
}

function setupModals() {
    document.querySelectorAll('[data-modal-close]').forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            closeModal(modal);
        });
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', event => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
    });

    document.addEventListener('keydown', event => {
        if (event.key === 'Escape') {
            const open = document.querySelector('.modal.is-open');
            if (open) closeModal(open);
        }
    });
}

function maskPassword(value) {
    if (!value) return 'No asignada';
    return '•'.repeat(Math.max(value.length, 6));
}

function updateSessionTimer() {
    const sessionEl = document.querySelector('#sessionInfo .session__value');
    const elapsed = Math.floor((Date.now() - state.sessionStart) / 1000);
    const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
    const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
    const seconds = String(elapsed % 60).padStart(2, '0');
    sessionEl.textContent = `${hours}:${minutes}:${seconds}`;
}

function formatUptime(seconds) {
    if (!Number.isFinite(seconds) || seconds <= 0) return '0s';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    if (h > 0) return `${h}h ${m}m ${s}s`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function updateConnectionStatus() {
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('connectionText');
    const up = document.getElementById('uptime');
    if (!dot || !text || !up) return;
    dot.classList.toggle('is-online', !!realtimeConnected);
    dot.classList.toggle('is-offline', !realtimeConnected);
    text.textContent = realtimeConnected ? 'Conectado' : 'Desconectado';
    const seconds = Number((state.system && state.system.uptime) || 0);
    up.textContent = formatUptime(seconds);
}

function updateStatusCards() {
    const { gnss } = state;
    document.querySelector('#gnssStatus .status-card__value').textContent = `${gnss.satellites} sats`;
    document.querySelector('#rtkStatus .status-card__value').textContent = gnss.fix;
    updateRtkBanner();
    document.querySelector('#imuStatus .status-card__value').textContent = state.imu.calibrated ? 'Activo' : 'Calibrando';
    document.querySelector('#networkStatus .status-card__value').textContent = state.ntrip.enabled
        ? `Correcciones ${state.ntrip.latency.toFixed(1)}s`
        : 'Desconectado';

    document.querySelectorAll('.status-card').forEach(card => card.classList.remove('is-active'));
    if (gnss.fix.toLowerCase() === 'rtk fixed') {
        document.getElementById('rtkStatus').classList.add('is-active');
    }
}

function updateSolution() {
    const { gnss } = state;
    document.getElementById('solutionSubtitle').textContent = gnss.fix === 'Sin solución'
        ? 'Esperando posicionamiento RTK'
        : `${gnss.fix} · ${gnss.satellites} satélites`;
    
    const latLonEl = document.getElementById('latLon');
    if (Number.isFinite(gnss.latitude) && Number.isFinite(gnss.longitude)) {
        latLonEl.innerHTML = `
            <div class="coord">
                <span class="coord__label">Lat</span>
                <span class="coord__value">${gnss.latitude.toFixed(8)}°</span>
            </div>
            <div class="coord">
                <span class="coord__label">Lon</span>
                <span class="coord__value">${gnss.longitude.toFixed(8)}°</span>
            </div>`;
    } else {
        latLonEl.innerHTML = '<div class="coord coord--empty">Esperando coordenadas...</div>';
    }
    
    const altEl = document.getElementById('altitude');
    if (Number.isFinite(gnss.altitude)) {
        altEl.innerHTML = `
            <div class="coord">
                <span class="coord__label">Altura elipsoidal</span>
                <span class="coord__value">${gnss.altitude.toFixed(3)} m</span>
            </div>`;
    } else {
        altEl.innerHTML = '<div class="coord coord--empty">Altura no disponible</div>';
    }
    
    const orthEl = document.getElementById('orthometric');
    if (Number.isFinite(gnss.orthometric)) {
        orthEl.innerHTML = `
            <div class="coord">
                <span class="coord__label">Altura ortométrica (EGM2008)</span>
                <span class="coord__value">${gnss.orthometric.toFixed(3)} m</span>
            </div>`;
    } else {
        orthEl.innerHTML = '<div class="coord coord--empty">Calculando altura ortométrica...</div>';
    }
    
    document.getElementById('hAccuracy').textContent = Number.isFinite(gnss.horizontalAccuracy)
        ? `${(gnss.horizontalAccuracy * 1000).toFixed(0)} mm`
        : '--';
    document.getElementById('hdop').textContent = Number.isFinite(gnss.hdop)
        ? gnss.hdop.toFixed(1)
        : '--';
    document.getElementById('satCount').textContent = Number.isFinite(gnss.satellites)
        ? String(gnss.satellites)
        : '--';
    document.getElementById('correctionAge').textContent = Number.isFinite(gnss.age)
        ? `${gnss.age.toFixed(1)}s`
        : '--';
    
    const utmEl = document.getElementById('utmSummary');
    if (gnss.utm && gnss.utm.zone) {
        document.getElementById('utmZone').textContent = `${gnss.utm.zone}${gnss.utm.hemisphere}`;
        document.getElementById('utmEasting').textContent = `${gnss.utm.easting.toFixed(3)} m`;
        document.getElementById('utmNorthing').textContent = `${gnss.utm.northing.toFixed(3)} m`;
        utmEl.style.display = 'block';
    } else {
        utmEl.style.display = 'none';
    }
    updateRtkBanner();
    const updatedEl = document.getElementById('positionUpdated');
    if (updatedEl) {
        updatedEl.textContent = `${gnss.locked ? 'Fijado' : 'Automático'} · ${formatRelativeTime(gnss.updatedAt || Date.now())}`;
    }
}

function updateConstellations() {
    const list = document.getElementById('constellationsList');
    list.innerHTML = '';
    state.constellations.forEach(constellation => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${constellation.name}</span>
            <div class="constellation__metrics">
                <span>${constellation.count} satélites</span>
                <span>${constellation.snr} dBHz</span>
            </div>`;
        li.style.setProperty('--tone', constellation.color);
        list.appendChild(li);
    });
}

function updateServices() {
    const list = document.getElementById('servicesList');
    list.innerHTML = '';
    const ntripService = state.services.find(service => service.name.includes('NTRIP'));
    if (ntripService) {
        ntripService.status = state.ntrip.enabled
            ? `Correcciones ${state.ntrip.latency.toFixed(1)}s`
            : 'NTRIP desconectado';
        ntripService.tone = state.ntrip.enabled ? 'is-active' : 'is-danger';
    }
    state.services.forEach(service => {
        const li = document.createElement('li');
        if (service.tone) li.classList.add(service.tone);
        li.innerHTML = `
            <span>${service.name}</span>
            <span>${service.status}</span>`;
        list.appendChild(li);
    });
}

function updateImu() {
    const container = document.getElementById('imuStats');
    container.innerHTML = '';
    const entries = [
        { label: 'Tilt', value: `${state.imu.tilt.toFixed(1)}°` },
        { label: 'Heading', value: `${state.imu.heading.toFixed(1)}°` },
        { label: 'Pitch', value: `${state.imu.pitch.toFixed(1)}°` },
        { label: 'Roll', value: `${state.imu.roll.toFixed(1)}°` },
        { label: 'Drift', value: `${state.imu.drift.toFixed(2)}°/h` },
        { label: 'Fusión', value: state.imu.fusion }
    ];

    entries.forEach(entry => {
        const group = document.createElement('div');
        group.innerHTML = `<dt>${entry.label}</dt><dd>${entry.value}</dd>`;
        container.appendChild(group);
    });
}

function updateTimeline() {
    const list = document.getElementById('timeline');
    list.innerHTML = '';
    state.events.forEach(event => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${event.title}</strong><time>${event.time}</time>`;
        list.appendChild(li);
    });
}

function updateProject() {
    const summary = document.getElementById('projectSummary');
    const notes = escapeHtml(state.project.notes || 'Sin notas registradas');
    const stakeout = state.project.stakeout || { target: '—', distance: 0, bearing: 0 };
    const hasStakeout = stakeout.target && stakeout.target !== '—';
    const stakeoutActive = state.stakeout.active && hasStakeout;
    const distanceLabel = Number.isFinite(stakeout.distance) ? stakeout.distance.toFixed(2) : '0.00';
    const bearingLabel = Number.isFinite(stakeout.bearing) ? Math.round(stakeout.bearing) : 0;
    const stakeoutLine = stakeoutActive
        ? `${stakeout.target} · ${distanceLabel} m · ${bearingLabel}°`
        : hasStakeout
        ? `${stakeout.target} listo · ${distanceLabel} m · ${bearingLabel}°`
        : 'Replanteo en espera';
    const locationLabel = state.gnss.utm
        ? `Zona UTM ${state.gnss.utm.zone}${state.gnss.utm.band}${state.gnss.utm.hemisphere}`
        : state.project.location;
    const accuracy = escapeHtml(state.project.accuracy || '—');
    summary.innerHTML = `
        <div class="project__header">
            <div>
                <h3>${escapeHtml(state.project.name)}</h3>
                <p>${escapeHtml(locationLabel)}</p>
            </div>
            <span class="badge">Precisión ${accuracy}</span>
        </div>
        <div class="project__details">
            <p><strong>Responsable:</strong> ${escapeHtml(state.project.owner)}</p>
            <p><strong>Código:</strong> ${escapeHtml(state.project.code || 'Sin código')}</p>
            <p><strong>Stakeout:</strong> ${escapeHtml(stakeoutLine)}</p>
            <p><strong>Notas:</strong> ${notes}</p>
        </div>`;
}

function updatePoints() {
    const tbody = document.querySelector('#pointsTable tbody');
    tbody.innerHTML = '';
    
    // Actualizar contador
    const countEl = document.getElementById('pointsCount');
    if (countEl) {
        countEl.textContent = `${state.points.length} punto${state.points.length !== 1 ? 's' : ''} registrado${state.points.length !== 1 ? 's' : ''}`;
    }
    
    state.points.forEach(point => {
        if (!point.utm) {
            point.utm = latLonToUtm(point.lat, point.lon);
        }
        const utm = point.utm;
        const geoid = Number.isFinite(point.geoidSeparation)
            ? point.geoidSeparation
            : resolveGeoidSeparation(point.lat, point.lon, state.gnss.geoidSeparation);
        if (!Number.isFinite(point.geoidSeparation) && Number.isFinite(geoid)) {
            point.geoidSeparation = geoid;
        }
        const orthometric = Number.isFinite(point.orthometric)
            ? point.orthometric
            : computeOrthometricHeight(point.alt, geoid);
        const name = escapeHtml(point.name);
        const category = point.category ? escapeHtml(point.category.toUpperCase()) : '—';
        const date = escapeHtml(point.date || '');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${name}</td>
            <td>${category}</td>
            <td class="is-utm">${utm.zone}${utm.band}${utm.hemisphere}</td>
            <td class="is-utm">${utm.easting.toFixed(2)}</td>
            <td class="is-utm">${utm.northing.toFixed(2)}</td>
            <td class="is-subtle">${point.lat.toFixed(6)}</td>
            <td class="is-subtle">${point.lon.toFixed(6)}</td>
            <td>${point.alt.toFixed(2)}</td>
            <td>${Number.isFinite(orthometric) ? orthometric.toFixed(2) : '—'}</td>
            <td>${(point.accuracy * 100).toFixed(1)} cm</td>
            <td>${date}</td>`;
        tbody.appendChild(row);
    });
    renderPointsOnMap();
}

function formatOffset(value) {
    const sign = value > 0 ? '+' : '';
    return `${sign}${value.toFixed(2)} m`;
}

function describeOffset(axis, value) {
    const magnitude = Math.abs(value);
    if (axis === 'N') {
        if (magnitude < 0.01) return 'Perfecto en Norte';
        return value >= 0 ? 'Avanza hacia el norte' : 'Retrocede hacia el sur';
    }
    if (axis === 'E') {
        if (magnitude < 0.01) return 'Perfecto en Este';
        return value >= 0 ? 'Desplázate al este' : 'Desplázate al oeste';
    }
    if (axis === 'Z') {
        if (magnitude < 0.01) return 'Altura correcta';
        return value >= 0 ? 'Sube la antena' : 'Baja la antena';
    }
    return `${magnitude.toFixed(2)} m`;
}

function toRadians(value) {
    return (value * Math.PI) / 180;
}

function latToUtmBand(lat) {
    const bands = 'CDEFGHJKLMNPQRSTUVWX';
    const index = Math.floor((lat + 80) / 8);
    if (index < 0) return 'C';
    if (index >= bands.length) return 'X';
    return bands[index];
}

function latLonToUtm(lat, lon) {
    const a = 6378137;
    const f = 1 / 298.257223563;
    const k0 = 0.9996;
    const eSq = f * (2 - f);
    const e = Math.sqrt(eSq);
    const latRad = toRadians(lat);
    const lonRad = toRadians(lon);
    let zone = Math.floor((lon + 180) / 6) + 1;

    if (lat >= 56 && lat < 64 && lon >= 3 && lon < 12) zone = 32;
    if (lat >= 72 && lat < 84) {
        if (lon >= 0 && lon < 9) zone = 31;
        else if (lon >= 9 && lon < 21) zone = 33;
        else if (lon >= 21 && lon < 33) zone = 35;
        else if (lon >= 33 && lon < 42) zone = 37;
    }

    const lonOrigin = (zone - 1) * 6 - 180 + 3;
    const lonOriginRad = toRadians(lonOrigin);
    const ePrimeSq = eSq / (1 - eSq);
    const sinLat = Math.sin(latRad);
    const cosLat = Math.cos(latRad);
    const tanLat = Math.tan(latRad);
    const N = a / Math.sqrt(1 - eSq * sinLat ** 2);
    const T = tanLat ** 2;
    const C = ePrimeSq * cosLat ** 2;
    const A = cosLat * (lonRad - lonOriginRad);

    const M =
        a *
        ((1 - eSq / 4 - (3 * eSq ** 2) / 64 - (5 * eSq ** 3) / 256) * latRad -
            ((3 * eSq) / 8 + (3 * eSq ** 2) / 32 + (45 * eSq ** 3) / 1024) * Math.sin(2 * latRad) +
            ((15 * eSq ** 2) / 256 + (45 * eSq ** 3) / 1024) * Math.sin(4 * latRad) -
            ((35 * eSq ** 3) / 3072) * Math.sin(6 * latRad));

    const easting =
        k0 *
            N *
            (A + ((1 - T + C) * A ** 3) / 6 + ((5 - 18 * T + T ** 2 + 72 * C - 58 * ePrimeSq) * A ** 5) / 120) +
        500000;
    let northing =
        k0 *
        (M +
            N *
                tanLat *
                (A ** 2 / 2 + ((5 - T + 9 * C + 4 * C ** 2) * A ** 4) / 24 + ((61 - 58 * T + T ** 2 + 600 * C - 330 * ePrimeSq) * A ** 6) / 720));

    const hemisphere = lat >= 0 ? 'N' : 'S';
    if (lat < 0) {
        northing += 10000000;
    }

    return {
        zone,
        hemisphere,
        band: latToUtmBand(lat),
        easting,
        northing
    };
}

function utmToLatLon({ zone, hemisphere, easting, northing }) {
    if (!Number.isFinite(zone) || !Number.isFinite(easting) || !Number.isFinite(northing)) {
        return null;
    }
    const a = 6378137;
    const f = 1 / 298.257223563;
    const k0 = 0.9996;
    const eSq = f * (2 - f);
    const e = Math.sqrt(eSq);
    const ePrimeSq = eSq / (1 - eSq);
    const x = easting - 500000;
    let y = northing;
    const hemisphereUpper = (hemisphere || 'N').toUpperCase();
    if (hemisphereUpper === 'S') {
        y -= 10000000;
    }
    const m = y / k0;
    const mu =
        m /
        (a * (1 - eSq / 4 - (3 * eSq ** 2) / 64 - (5 * eSq ** 3) / 256));
    const e1 = (1 - Math.sqrt(1 - eSq)) / (1 + Math.sqrt(1 - eSq));
    const j1 = (3 * e1) / 2 - (27 * e1 ** 3) / 32;
    const j2 = (21 * e1 ** 2) / 16 - (55 * e1 ** 4) / 32;
    const j3 = (151 * e1 ** 3) / 96;
    const j4 = (1097 * e1 ** 4) / 512;
    const phi1 =
        mu +
        j1 * Math.sin(2 * mu) +
        j2 * Math.sin(4 * mu) +
        j3 * Math.sin(6 * mu) +
        j4 * Math.sin(8 * mu);
    const sinPhi1 = Math.sin(phi1);
    const cosPhi1 = Math.cos(phi1);
    const tanPhi1 = Math.tan(phi1);
    const n1 = a / Math.sqrt(1 - eSq * sinPhi1 ** 2);
    const r1 = (a * (1 - eSq)) / Math.pow(1 - eSq * sinPhi1 ** 2, 1.5);
    const t1 = tanPhi1 ** 2;
    const c1 = ePrimeSq * cosPhi1 ** 2;
    const d = x / (n1 * k0);
    const lat =
        phi1 -
        (n1 * tanPhi1) /
            r1 *
            (d ** 2 / 2 -
                ((5 + 3 * t1 + 10 * c1 - 4 * c1 ** 2 - 9 * ePrimeSq) * d ** 4) / 24 +
                ((61 + 90 * t1 + 298 * c1 + 45 * t1 ** 2 - 252 * ePrimeSq - 3 * c1 ** 2) * d ** 6) / 720);
    const lon =
        (d -
            ((1 + 2 * t1 + c1) * d ** 3) / 6 +
            ((5 - 2 * c1 + 28 * t1 - 3 * c1 ** 2 + 8 * ePrimeSq + 24 * t1 ** 2) * d ** 5) / 120) /
        cosPhi1;
    const lonOrigin = (zone - 1) * 6 - 180 + 3;
    const latitude = (lat * 180) / Math.PI;
    const longitude = lonOrigin + (lon * 180) / Math.PI;
    return {
        latitude,
        longitude,
        utm: {
            zone,
            hemisphere: hemisphereUpper === 'S' ? 'S' : 'N',
            band: latToUtmBand(latitude),
            easting,
            northing
        }
    };
}

function calculateOffsets(current, target) {
    const targetLat = target.lat ?? target.latitude ?? current.latitude;
    const targetLon = target.lon ?? target.longitude ?? current.longitude;
    const altitude = (target.alt ?? target.altitude ?? current.altitude) - current.altitude;
    const currentUtm = latLonToUtm(current.latitude, current.longitude);
    const targetUtm = target.utm || latLonToUtm(targetLat, targetLon);
    if (!target.utm) {
        target.utm = targetUtm;
    }
    return {
        north: targetUtm.northing - currentUtm.northing,
        east: targetUtm.easting - currentUtm.easting,
        up: altitude
    };
}

function updateStakeoutToggle() {
    const toggleBtn = document.getElementById('stakeoutToggleBtn');
    if (!toggleBtn) return;
    const isActive = !!state.stakeout.active;
    toggleBtn.innerHTML = isActive
        ? '<i data-lucide="pause-circle"></i>Pausar replanteo'
        : '<i data-lucide="target"></i>Activar replanteo';
    toggleBtn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    lucide.createIcons();
}

function updateStakeoutPanel() {
    const panel = document.getElementById('stakeoutPanel');
    if (!panel) return;
    updateStakeoutToggle();

    if (!state.stakeout.active) {
        const last = state.project.stakeout || { target: '—', distance: 0, bearing: 0 };
        const hasTarget = last.target && last.target !== '—';
        const distanceLabel = Number.isFinite(last.distance) ? last.distance.toFixed(2) : '0.00';
        const bearingLabel = Number.isFinite(last.bearing) ? Math.round(last.bearing) : 0;
        const summary = hasTarget
            ? `<p class="stakeout__guidance">Último objetivo: <strong>${escapeHtml(last.target)}</strong> · ${distanceLabel} m · ${bearingLabel}°</p>`
            : '<p class="stakeout__guidance">Selecciona un punto desde “Configurar” para preparar un replanteo.</p>';
        panel.innerHTML = `${summary}`;
        const subtitle = document.getElementById('stakeoutSubtitle');
        if (subtitle) {
            subtitle.textContent = hasTarget ? 'Replanteo en espera' : 'Sin objetivo activo';
        }
        updateProject();
        return;
    }

    let target = null;
    if (state.stakeout.mode === 'manual' && state.stakeout.manual) {
        target = state.stakeout.manual;
    } else {
        target = state.points.find(point => point.name === state.stakeout.targetId) || state.points[0];
        if (target) {
            state.stakeout.targetId = target.name;
        }
    }

    if (!target) {
        panel.innerHTML = '<p class="modal__hint">Aún no hay puntos almacenados. Crea uno para habilitar el replanteo.</p>';
        const subtitle = document.getElementById('stakeoutSubtitle');
        if (subtitle) {
            subtitle.textContent = 'Sin objetivo definido';
        }
        state.stakeout.active = false;
        updateStakeoutToggle();
        updateProject();
        return;
    }

    const offsets = calculateOffsets(state.gnss, target);
    state.stakeout.offsets = offsets;
    const distance = Math.sqrt(offsets.north ** 2 + offsets.east ** 2);
    const bearing = (Math.atan2(offsets.east, offsets.north) * 180) / Math.PI;
    const normalizedBearing = (bearing + 360) % 360;
    const withinTolerance = distance <= state.stakeout.tolerance;
    const guidanceRaw = state.stakeout.guidance || (withinTolerance ? 'Objetivo dentro de tolerancia.' : 'Ajusta desplazamiento hasta cumplir la tolerancia.');
    const guidance = escapeHtml(guidanceRaw);
    const targetUtm = target.utm || latLonToUtm(target.lat ?? target.latitude, target.lon ?? target.longitude);
    const currentUtm = latLonToUtm(state.gnss.latitude, state.gnss.longitude);

    state.project.stakeout = {
        target: state.stakeout.mode === 'manual' ? (state.stakeout.targetId || 'Manual') : state.stakeout.targetId,
        distance,
        bearing: normalizedBearing
    };

    const badgeTone = withinTolerance ? 'is-success' : 'is-warning';
    const targetLabel = escapeHtml(state.project.stakeout.target);
    const renderVector = (axis, value) => {
        const tone = value > 0.02 ? 'is-positive' : value < -0.02 ? 'is-negative' : 'is-neutral';
        return `
            <div class="stakeout__vector ${tone}">
                <span>${axis}</span>
                <strong>${formatOffset(value)}</strong>
                <small>${describeOffset(axis, value)}</small>
            </div>`;
    };

    panel.innerHTML = `
        <div class="stakeout__status">
            <span class="stakeout__badge ${badgeTone}">${targetLabel}</span>
            <div class="stakeout__distance">${distance.toFixed(3)} m</div>
            <p class="stakeout__bearing">Rumbo ${normalizedBearing.toFixed(0)}° · Tol ±${state.stakeout.tolerance.toFixed(2)} m</p>
        </div>
        <div class="stakeout__vectors">
            ${renderVector('N', offsets.north)}
            ${renderVector('E', offsets.east)}
            ${renderVector('Z', offsets.up)}
        </div>
        <div class="stakeout__utm">
            <div>
                <span>UTM objetivo</span>
                <strong>${targetUtm.zone}${targetUtm.band}${targetUtm.hemisphere}</strong>
                <p>${targetUtm.easting.toFixed(2)} E · ${targetUtm.northing.toFixed(2)} N</p>
            </div>
            <div>
                <span>UTM equipo</span>
                <strong>${currentUtm.zone}${currentUtm.band}${currentUtm.hemisphere}</strong>
                <p>${currentUtm.easting.toFixed(2)} E · ${currentUtm.northing.toFixed(2)} N</p>
            </div>
        </div>
        <p class="stakeout__guidance ${withinTolerance ? 'is-success' : 'is-warning'}">${guidance}</p>`;

    document.getElementById('stakeoutSubtitle').textContent = `Tolerancia ±${state.stakeout.tolerance.toFixed(2)} m`;
    updateProject();
}

function updateNtripCard() {
    const summary = document.getElementById('ntripSummary');
    if (!summary) return;
    const caster = escapeHtml(`${state.ntrip.caster || ''}:${state.ntrip.port}`);
    const mountpoint = escapeHtml(state.ntrip.mountpoint || '—');
    const credentials = `${escapeHtml(state.ntrip.username || '—')} / ${escapeHtml(maskPassword(state.ntrip.password))}`;
    const formatLabel = escapeHtml(state.ntrip.format || '—');
    const bitrateLabel = escapeHtml(state.ntrip.bitrate || '—');
    const notes = escapeHtml(state.ntrip.notes || 'Sin notas');
    summary.innerHTML = `
        <div class="ntrip__item"><span>Estado</span><span class="ntrip__badge">${state.ntrip.enabled ? 'Activo' : 'Detenido'}</span></div>
        <div class="ntrip__item"><span>Caster</span><strong>${caster}</strong></div>
        <div class="ntrip__item"><span>Mountpoint</span><strong>${mountpoint}</strong></div>
        <div class="ntrip__item"><span>Credenciales</span><strong>${credentials}</strong></div>
        <div class="ntrip__item"><span>Formato</span><strong>${formatLabel} · ${bitrateLabel}</strong></div>
        <div class="ntrip__item"><span>Latencia</span><strong>${state.ntrip.enabled ? `${state.ntrip.latency.toFixed(1)} s` : '--'}</strong></div>
        <div class="ntrip__item"><span>Notas</span><strong>${notes}</strong></div>
        <p class="modal__hint">Esta configuración se guarda en este navegador. Usa “Generar enlace” para compartirla con otros equipos.</p>`;
}

function updateLoggingCard() {
    const container = document.getElementById('loggingCard');
    if (!container) return;
    const formats = [];
    if (state.logging.nmea) formats.push('<span class="tag">NMEA</span>');
    if (state.logging.rinex) formats.push('<span class="tag">RINEX</span>');
    if (state.logging.rtcm) formats.push('<span class="tag tag--alt">RTCM</span>');
    const destination = escapeHtml(state.logging.destination || '—');
    const path = escapeHtml(state.logging.path || '—');
    const notes = escapeHtml(state.logging.notes || 'Sin notas adicionales');

    container.innerHTML = `
        <div class="logging-card__row"><span>Formatos</span><div class="logging-card__tags">${formats.join('') || '<span class="modal__hint">Sin formatos</span>'}</div></div>
        <div class="logging-card__row"><span>Intervalo</span><strong>${state.logging.interval} s</strong></div>
        <div class="logging-card__row"><span>Destino</span><strong>${destination}</strong></div>
        <div class="logging-card__row"><span>Ruta</span><strong>${path}</strong></div>
        <div class="logging-card__row"><span>Estado</span><strong>${state.recording ? 'Grabando' : 'En espera'}${state.logging.autoUpload ? ' · Auto-sync' : ''}</strong></div>
        <p class="modal__hint">${notes}</p>`;
}

function updateLoggingSummary() {
    const summary = document.getElementById('loggingSummary');
    if (!summary) return;
    const formats = ['NMEA', 'RINEX', 'RTCM'].filter((format, index) => {
        if (format === 'NMEA') return state.logging.nmea;
        if (format === 'RINEX') return state.logging.rinex;
        if (format === 'RTCM') return state.logging.rtcm;
        return false;
    });
    const joined = formats.length ? formats.join(' + ') : 'Sin formatos';
    summary.innerHTML = `
        <strong>Perfil activo:</strong>
        ${joined} · ${state.logging.interval} s<br>
        ${state.recording ? 'Grabación en curso' : 'Listo para iniciar'}${state.logging.autoUpload ? ' · Auto-sync' : ''}`;
}

function populateProjectForm() {
    const form = document.getElementById('projectForm');
    if (!form) return;
    form.projectName.value = state.project.name;
    form.projectLocation.value = state.project.location;
    form.projectOwner.value = state.project.owner;
    form.projectAccuracy.value = state.project.accuracy;
    form.projectCode.value = state.project.code || '';
    form.projectNotes.value = state.project.notes || '';
    form.projectDatum.value = state.project.datum || 'WGS84';
    form.projectCoordinateSystem.value = state.project.coordinateSystem || 'UTM';
    form.projectGeoidModel.value = state.project.geoidModel || 'EGM2008';
    form.projectHeightType.value = state.project.heightType || 'Ellipsoidal';
    form.projectUnit.value = state.project.unit || 'Meters';
    form.projectPrecision.value = state.project.precision || '3';
    form.stakeoutTarget.value = state.project.stakeout?.target || '';
    form.stakeoutDistance.value = state.project.stakeout?.distance ? state.project.stakeout.distance.toFixed(2) : '';
    form.stakeoutBearing.value = state.project.stakeout?.bearing ?? '';
    form.projectReset.checked = false;
}

function populateNtripForm() {
    const form = document.getElementById('ntripForm');
    if (!form) return;
    form.ntripEnabled.checked = !!state.ntrip.enabled;
    form.ntripCaster.value = state.ntrip.caster || '';
    form.ntripPort.value = state.ntrip.port || '';
    form.ntripMountpoint.value = state.ntrip.mountpoint || '';
    form.ntripFormat.value = state.ntrip.format || 'RTCM 3.2';
    form.ntripUser.value = state.ntrip.username || '';
    form.ntripPass.value = state.ntrip.password || '';
    form.ntripBitrate.value = state.ntrip.bitrate || '';
    form.ntripLatency.value = state.ntrip.latency ? state.ntrip.latency.toFixed(1) : '';
    form.ntripSsl.checked = !!state.ntrip.ssl;
    form.ntripNotes.value = state.ntrip.notes || '';
}

function populateLoggingForm() {
    const form = document.getElementById('loggingForm');
    if (!form) return;
    form.loggingNmea.checked = !!state.logging.nmea;
    form.loggingRinex.checked = !!state.logging.rinex;
    form.loggingRtcm.checked = !!state.logging.rtcm;
    form.loggingAuto.checked = !!state.logging.autoUpload;
    form.loggingAutoStart.checked = !!state.logging.autoStart;
    form.loggingInterval.value = state.logging.interval;
    form.loggingPath.value = state.logging.path;
    form.loggingDestination.value = state.logging.destination;
    form.loggingNotes.value = state.logging.notes || '';

    const storageBadge = document.getElementById('loggingStorageBadge');
    const autoBadge = document.getElementById('loggingAutoBadge');
    if (storageBadge) {
        storageBadge.textContent = `Ruta local: ${state.logging.path}`;
    }
    if (autoBadge) {
        autoBadge.textContent = state.logging.autoUpload ? 'Auto-subida activa' : 'Sin sincronización automática';
        autoBadge.classList.toggle('tag--success', state.logging.autoUpload);
        autoBadge.classList.toggle('tag--alt', !state.logging.autoUpload);
    }
}

function populateStakeoutForm(filter = '') {
    const form = document.getElementById('stakeoutForm');
    if (!form) return;
    const select = form.stakeoutPoint;
    select.innerHTML = '';
    const query = String(filter || '').toLowerCase();
    const candidates = state.points.filter(p => {
        const name = String(p.name || '').toLowerCase();
        const code = String(p.code || '').toLowerCase();
        return !query || name.includes(query) || code.includes(query);
    });

    candidates.forEach(point => {
        const option = document.createElement('option');
        option.value = point.name;
        if (!point.utm) {
            point.utm = latLonToUtm(point.lat, point.lon);
        }
        option.textContent = `${point.name} · ${point.utm.zone}${point.utm.band}${point.utm.hemisphere} · ${point.utm.easting.toFixed(2)}E / ${point.utm.northing.toFixed(2)}N`;
        select.appendChild(option);
    });

    const manualOption = document.createElement('option');
    manualOption.value = 'manual';
    manualOption.textContent = 'Usar coordenadas manuales';
    select.appendChild(manualOption);

    if (state.stakeout.mode === 'manual') {
        select.value = 'manual';
    } else if (state.stakeout.targetId && state.points.some(point => point.name === state.stakeout.targetId)) {
        select.value = state.stakeout.targetId;
    } else if (select.options.length && select.options[0].value !== 'manual') {
        select.value = select.options[0].value;
    } else {
        select.value = 'manual';
    }

    form.stakeoutTolerance.value = state.stakeout.tolerance?.toFixed(2) || '0.05';
    form.stakeoutPole.value = state.stakeout.poleHeight?.toFixed(2) || '2.00';

    const selectedPoint = state.points.find(point => point.name === select.value);
    if (state.stakeout.manual) {
        form.stakeoutLat.value = state.stakeout.manual.lat ?? '';
        form.stakeoutLon.value = state.stakeout.manual.lon ?? '';
        form.stakeoutAlt.value = state.stakeout.manual.alt ?? '';
    } else if (selectedPoint) {
        form.stakeoutLat.value = selectedPoint.lat.toFixed(6);
        form.stakeoutLon.value = selectedPoint.lon.toFixed(6);
        form.stakeoutAlt.value = selectedPoint.alt.toFixed(2);
    } else {
        form.stakeoutLat.value = state.gnss.latitude.toFixed(6);
        form.stakeoutLon.value = state.gnss.longitude.toFixed(6);
        form.stakeoutAlt.value = state.gnss.altitude.toFixed(2);
    }

    form.stakeoutManual.checked = state.stakeout.mode === 'manual';
    form.stakeoutNotes.value = state.stakeout.guidance || '';
    form.stakeoutActiveToggle.checked = !!state.stakeout.active;
}

function populatePointForm() {
    const form = document.getElementById('pointForm');
    if (!form) return;
    const utm = state.gnss.utm || latLonToUtm(state.gnss.latitude, state.gnss.longitude);
    const suggested = deriveNextPointName();
    form.pointName.value = suggested;
    form.pointCode.value = suggested;
    form.pointDescription.value = '';
    form.pointCategory.value = 'topografia';
    form.pointNotes.value = '';
    form.pointLat.value = Number.isFinite(state.gnss.latitude) ? state.gnss.latitude.toFixed(6) : '';
    form.pointLon.value = Number.isFinite(state.gnss.longitude) ? state.gnss.longitude.toFixed(6) : '';
    form.pointZone.value = utm.zone;
    form.pointHemisphere.value = `${utm.hemisphere} · Banda ${utm.band}`;
    form.pointEasting.value = utm.easting.toFixed(3);
    form.pointNorthing.value = utm.northing.toFixed(3);
    const geoid = Number.isFinite(state.gnss.geoidSeparation)
        ? state.gnss.geoidSeparation
        : resolveGeoidSeparation(state.gnss.latitude, state.gnss.longitude, -28.5);
    if (!Number.isFinite(state.gnss.geoidSeparation) && Number.isFinite(geoid)) {
        state.gnss.geoidSeparation = geoid;
    }
    form.pointAltitude.value = Number.isFinite(state.gnss.altitude) ? state.gnss.altitude.toFixed(2) : '';
    form.pointGeoid.value = Number.isFinite(geoid) ? geoid.toFixed(2) : '';
    const orthometric = computeOrthometricHeight(state.gnss.altitude, geoid);
    form.pointOrthometric.value = Number.isFinite(orthometric) ? orthometric.toFixed(2) : '';
    form.pointPoleHeight.value = Number.isFinite(state.project.poleHeight) ? state.project.poleHeight.toFixed(2) : (Number.isFinite(state.stakeout.poleHeight) ? state.stakeout.poleHeight.toFixed(2) : '1.80');
    form.pointApcOffset.value = Number.isFinite(state.project.apcOffset) ? state.project.apcOffset.toFixed(3) : '0.120';
    form.pointUseTilt.checked = true;
}

function updateSatellites() {
    const panel = document.getElementById('satellitesPanel');
    panel.innerHTML = '';
    if (!state.satellites.length) {
        const empty = document.createElement('div');
        empty.className = 'is-hint';
        empty.textContent = 'Sin datos de satélites (aún).';
        panel.appendChild(empty);
        return;
    }
    // Ordenar por SNR descendente
    const sorted = [...state.satellites].sort((a, b) => (b.snr || 0) - (a.snr || 0));
    
    sorted.forEach(sat => {
        const container = document.createElement('div');
        container.className = 'satellite';
        
        // Color según clasificación ML
        let signalClass = '';
        let signalIcon = '';
        if (sat.signalType === 'LOS') {
            signalClass = 'satellite--los';
            signalIcon = '✓';
        } else if (sat.signalType === 'Multipath') {
            signalClass = 'satellite--multipath';
            signalIcon = '~';
        } else if (sat.signalType === 'NLOS') {
            signalClass = 'satellite--nlos';
            signalIcon = '✗';
        }
        
        container.className = `satellite ${signalClass}`;
        container.innerHTML = `
            <span class="satellite__id" title="${sat.constellation || 'Unknown'}">${sat.id}</span>
            <div class="satellite__bar">
                <span style="width: ${Math.min((sat.snr || 0) / 60 * 100, 100)}%"></span>
            </div>
            <span class="satellite__snr">${sat.snr || 0} dBHz</span>
            <span class="satellite__signal" title="${sat.signalType || 'Unknown'}">${signalIcon}</span>`;
        panel.appendChild(container);
    });
    
    // Mostrar resumen ML si existe
    if (state.ml && panel.parentElement) {
        const summary = panel.parentElement.querySelector('.ml-summary') || document.createElement('div');
        summary.className = 'ml-summary';
        summary.innerHTML = `
            <div class="ml-stat"><span class="ml-stat__dot ml-stat__dot--los"></span> LOS: ${state.ml.losSats || 0}</div>
            <div class="ml-stat"><span class="ml-stat__dot ml-stat__dot--multipath"></span> Multipath: ${state.ml.multipathSats || 0}</div>
            <div class="ml-stat"><span class="ml-stat__dot ml-stat__dot--nlos"></span> NLOS: ${state.ml.nlosSats || 0}</div>
            <div class="ml-stat"><strong>Confianza: ${(state.ml.avgConfidence || 0).toFixed(1)}%</strong></div>`;
        if (!panel.parentElement.querySelector('.ml-summary')) {
            panel.parentElement.insertBefore(summary, panel);
        }
    }
}

function updateCommands() {
    // Conjuntos según fabricante (ComNav/SinoGNSS). Se usan comandos comunes del manual: INTERFACEMODE, COM, LOG, UNLOGALL, NMEATALKER, SAVECONFIG.
    const isComNav = (state.vendor || 'ComNav') === 'ComNav';
    const baseCommon = {
        Sistema: [
            { title: 'Guardar configuración', cmd: 'SAVECONFIG', desc: 'Persistir configuración actual' },
            { title: 'Detener todas las salidas', cmd: 'UNLOGALL', desc: 'UNLOGALL en todos los puertos activos' }
        ],
        Puertos: [
            { title: 'COM1 115200', cmd: 'COM COM1 115200', desc: 'Baud rate 115200 en COM1' },
            { title: 'COM2 115200', cmd: 'COM COM2 115200', desc: 'Baud rate 115200 en COM2' },
            { title: 'COM1 AUTO', cmd: 'INTERFACEMODE COM1 AUTO AUTO', desc: 'Modo RX/TX automático en COM1' }
        ],
        NMEA_RTCM: [
            { title: 'GGA 1Hz COM1', cmd: 'LOG GPGGA COM1 ONTIME 1', desc: 'Salida GPGGA 1 Hz por COM1' },
            { title: 'RMC 1Hz COM1', cmd: 'LOG GPRMC COM1 ONTIME 1', desc: 'Salida GPRMC 1 Hz por COM1' },
            { title: 'Talker GN', cmd: 'NMEATALKER GN', desc: 'Identificador NMEA GN (multi-sistema)' }
        ]
    };

    const vendorSets = isComNav ? {
        ...baseCommon,
        RTK: [
            { title: 'Rover (serial/NTRIP listo)', cmd: 'INTERFACEMODE COM2 AUTO AUTO', desc: 'Configura puerto para correcciones' },
            { title: 'Base RTCM (COM2 1Hz)', cmd: 'LOG RTCM1006 COM2 ONTIME 1', desc: 'Ejemplo RTCM 1006 a 1 Hz (ajustar según montaje)' }
        ],
        Diagnóstico: [
            { title: 'BESTPOS una vez', cmd: 'LOG BESTPOS ONCE', desc: 'Posición en formato propietario una vez' },
            { title: 'TRACKSTAT una vez', cmd: 'LOG TRACKSTAT ONCE', desc: 'Estado de seguimiento' }
        ]
    } : {
        ...baseCommon,
        RTK: [
            { title: 'Rover (serial/NTRIP listo)', cmd: 'INTERFACEMODE COM2 AUTO AUTO', desc: 'Habilita puerto de correcciones' },
            { title: 'Base RTCM (COM2 1Hz)', cmd: 'LOG RTCM1006 COM2 ONTIME 1', desc: 'RTCM 1006 1 Hz (ejemplo K922)' }
        ],
        Diagnóstico: [
            { title: 'BESTPOS una vez', cmd: 'LOG BESTPOS ONCE', desc: 'Posición una vez' },
            { title: 'SATXYZ una vez', cmd: 'LOG SATXYZ ONCE', desc: 'Coordenadas de satélites una vez' }
        ]
    };

    const commands = vendorSets;

    const container = document.getElementById('commandList');
    container.innerHTML = '';

    Object.entries(commands).forEach(([group, items]) => {
        const heading = document.createElement('h3');
        heading.textContent = group;
        container.appendChild(heading);

        items.forEach(item => {
            const block = document.createElement('div');
            block.className = 'command';
            block.innerHTML = `
                <div class="command__title">${item.title}</div>
                <div class="command__desc">${item.desc}</div>
                <code>${item.cmd}</code>
                <div class="command__actions">
                    <button class="ghost-btn" data-command="${item.cmd}">Enviar</button>
                    <button class="icon-btn" aria-label="Copiar comando" data-copy="${item.cmd}"><i data-lucide="copy"></i></button>
                </div>`;
            container.appendChild(block);
        });
    });

    const imuGroup = document.createElement('h3');
    imuGroup.textContent = 'IMU/Tilt';
    container.appendChild(imuGroup);
    [
        { title: 'HDT 1Hz COM1', cmd: 'LOG HDT COM1 ONTIME 1', desc: 'Heading True a 1 Hz' },
        { title: 'VHD 1Hz COM1', cmd: 'LOG VHD COM1 ONTIME 1', desc: 'Velocidad y rumbo a 1 Hz' },
        { title: 'GST 1Hz COM1', cmd: 'LOG GST COM1 ONTIME 1', desc: 'Estimación de errores a 1 Hz' },
        { title: 'GSV 1Hz COM1', cmd: 'LOG GSV COM1 ONTIME 1', desc: 'Satélites en vista a 1 Hz' },
        { title: 'Tilt Compensation ON', cmd: 'TILTCOMPENSATION ENABLE', desc: 'Activar compensación de inclinación' },
        { title: 'Tilt Compensation OFF', cmd: 'TILTCOMPENSATION DISABLE', desc: 'Desactivar compensación de inclinación' }
    ].forEach(item => {
        const block = document.createElement('div');
        block.className = 'command';
        block.innerHTML = `
            <div class="command__title">${item.title}</div>
            <div class="command__desc">${item.desc}</div>
            <code>${item.cmd}</code>
            <div class="command__actions">
                <button class="ghost-btn" data-command="${item.cmd}">Enviar</button>
                <button class="icon-btn" aria-label="Copiar comando" data-copy="${item.cmd}"><i data-lucide="copy"></i></button>
            </div>`;
        container.appendChild(block);
    });
}

function updateProfiles() {
    const profiles = document.getElementById('profiles');
    profiles.innerHTML = '';
    const data = [
        { name: 'Topografía RTK', desc: 'RTK fijo + Tilt', accuracy: '2 cm' },
        { name: 'PPP L-Band', desc: 'PPP + IMU', accuracy: '5 cm' },
        { name: 'Base fija', desc: 'RTCM 3.x @ 1Hz', accuracy: 'Controlada' }
    ];

    data.forEach(profile => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>
                <strong>${profile.name}</strong>
                <small>${profile.desc}</small>
            </span>
            <span>${profile.accuracy}</span>`;
        profiles.appendChild(li);
    });
}

function updateFiles() {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    state.files.forEach(file => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>
                <strong>${file.name}</strong>
                <small>${file.time}</small>
            </span>
            <span>${file.size}</span>`;
        list.appendChild(li);
    });

    const sync = document.getElementById('syncPanel');
    sync.innerHTML = `
        <div><strong>Google Drive</strong><p>${state.sync.drive ? 'Vinculado' : 'Sin conexión'}</p></div>
        <div><strong>Última sincronización</strong><p>${state.sync.lastSync}</p></div>
        <div><strong>Pendientes</strong><p>${state.sync.pending}</p></div>
        <button class="primary-btn" id="syncBtn"><i data-lucide="refresh-cw"></i> Sincronizar ahora</button>`;
}

function updatePhotoLog() {
    const container = document.getElementById('photoLog');
    if (!container) return;
    container.innerHTML = '';
    if (!state.photos.length) {
        container.innerHTML = '<p class="photo-log__empty">Aún no hay capturas. Usa “Tomar foto” para registrar la primera.</p>';
        return;
    }

    state.photos.forEach(photo => {
        const meta = photo.metadata || {};
        const utm = meta.utm;
        const location = Number.isFinite(meta.latitude) && Number.isFinite(meta.longitude)
            ? `${meta.latitude.toFixed(6)}°, ${meta.longitude.toFixed(6)}°`
            : '—';
        const utmLabel = utm
            ? `${utm.zone}${utm.band}${utm.hemisphere} · ${utm.easting.toFixed(2)}E / ${utm.northing.toFixed(2)}N`
            : '—';
        const altitude = Number.isFinite(meta.altitude) ? `${meta.altitude.toFixed(2)} m` : '—';
        const orthometric = Number.isFinite(meta.orthometric) ? `${meta.orthometric.toFixed(2)} m` : '—';
        const geoid = Number.isFinite(meta.geoid) ? `${meta.geoid.toFixed(2)} m` : '—';
        const direction = Number.isFinite(meta.direction)
            ? `${meta.direction.toFixed(1)}°${meta.directionRef ? ` ${meta.directionRef}` : ''}`
            : '—';
        const resolution = meta.width && meta.height ? `${meta.width} × ${meta.height}` : '—';
        const source = meta.source || 'EXIF original';
        const capturedMs = meta.timestamp ? new Date(meta.timestamp).getTime() : new Date(photo.capturedAt).getTime();
        const relative = Number.isFinite(capturedMs) ? formatRelativeTime(capturedMs) : '—';
        const speed = formatSpeed(meta.speed);
        const equipment = escapeHtml([meta.make, meta.model].filter(Boolean).join(' ') || '—');
        const lens = escapeHtml(meta.lens || '—');
        const iso = escapeHtml(meta.iso ?? '—');
        const resolutionLabel = escapeHtml(resolution);
        const weight = escapeHtml(formatBytes(photo.size));
        const locationLabel = escapeHtml(location);
        const utmDisplay = escapeHtml(utmLabel);
        const sourceLabel = escapeHtml(source);
        const relativeLabel = escapeHtml(relative);

        const item = document.createElement('article');
        item.className = 'photo-log__item';
        item.innerHTML = `
            <header>
                <h3>${escapeHtml(photo.name)}</h3>
                <span class="tag">${formatTimestamp(photo.capturedAt)}</span>
            </header>
            <dl class="photo-log__meta">
                <div><dt>Equipo</dt><dd>${equipment}</dd></div>
                <div><dt>Óptica</dt><dd>${lens}</dd></div>
                <div><dt>ISO</dt><dd>${iso}</dd></div>
                <div><dt>Exposición</dt><dd>${formatExposure(meta.exposure)}</dd></div>
                <div><dt>Apertura</dt><dd>${formatFNumber(meta.fnumber)}</dd></div>
                <div><dt>Focal</dt><dd>${formatFocalLength(meta.focalLength)}</dd></div>
                <div><dt>Velocidad</dt><dd>${speed}</dd></div>
                <div><dt>Dirección</dt><dd>${direction}</dd></div>
                <div><dt>Altitud</dt><dd>${altitude}</dd></div>
                <div><dt>Alt. EGM2008</dt><dd>${orthometric}</dd></div>
                <div><dt>Geoid</dt><dd>${geoid}</dd></div>
                <div><dt>Resolución</dt><dd>${resolutionLabel}</dd></div>
                <div><dt>Peso</dt><dd>${weight}</dd></div>
                <div><dt>Lat/Lon</dt><dd>${locationLabel}</dd></div>
                <div><dt>UTM</dt><dd>${utmDisplay}</dd></div>
                <div><dt>Fuente</dt><dd class="is-hint">${sourceLabel}</dd></div>
                <div><dt>Referencia</dt><dd class="is-hint">${relativeLabel}</dd></div>
            </dl>`;
        container.appendChild(item);
    });
}

async function extractPhotoMetadata(file) {
    let data = {};
    let usedFallback = false;
    if (typeof exifr !== 'undefined') {
        try {
            data = (await exifr.parse(file, {
                tiff: true,
                ifd1: true,
                exif: true,
                gps: true,
                xmp: true,
                translateValues: false
            })) || {};
            if (!data || Object.keys(data).length === 0) {
                usedFallback = true;
            }
        } catch (error) {
            console.warn('Lectura EXIF fallida, intentando con buffer', error);
            try {
                const buffer = await file.arrayBuffer();
                data = (await exifr.parse(buffer, {
                    tiff: true,
                    ifd1: true,
                    exif: true,
                    gps: true,
                    xmp: true,
                    translateValues: false
                })) || {};
                if (!data || Object.keys(data).length === 0) {
                    usedFallback = true;
                }
            } catch (fallbackError) {
                console.warn('No se pudo leer EXIF tras reintento', fallbackError);
                data = {};
                usedFallback = true;
            }
        }
    } else {
        console.warn('exifr no disponible, usando datos GNSS para la foto');
        usedFallback = true;
    }

    const timestamp = normalizeExifDate(data?.DateTimeOriginal || data?.CreateDate || data?.ModifyDate) || new Date().toISOString();
    let latitude = Number.isFinite(data?.latitude) ? data.latitude : Number.isFinite(data?.GPSLatitude) ? data.GPSLatitude : null;
    let longitude = Number.isFinite(data?.longitude)
        ? data.longitude
        : Number.isFinite(data?.GPSLongitude)
        ? data.GPSLongitude
        : null;
    let altitude = Number.isFinite(data?.GPSAltitude) ? data.GPSAltitude : Number.isFinite(data?.altitude) ? data.altitude : null;
    if (!Number.isFinite(latitude) || !Number.isFinite(longitude)) {
        latitude = state.gnss.latitude;
        longitude = state.gnss.longitude;
        usedFallback = true;
    }
    if (!Number.isFinite(altitude)) {
        altitude = state.gnss.altitude;
    }
    const utm = Number.isFinite(latitude) && Number.isFinite(longitude) ? latLonToUtm(latitude, longitude) : null;
    const geoidSeparation = resolveGeoidSeparation(latitude, longitude, state.gnss.geoidSeparation);
    if (!Number.isFinite(state.gnss.geoidSeparation) && Number.isFinite(geoidSeparation)) {
        state.gnss.geoidSeparation = geoidSeparation;
    }
    const orthometric = Number.isFinite(altitude) && Number.isFinite(geoidSeparation)
        ? computeOrthometricHeight(altitude, geoidSeparation)
        : null;

    let exposure = data?.ExposureTime || null;
    if (!exposure && Number.isFinite(data?.ShutterSpeedValue)) {
        exposure = 1 / Math.pow(2, data.ShutterSpeedValue);
    }

    const source = usedFallback ? 'GNSS.AI (sin EXIF completo)' : 'EXIF original';

    return {
        timestamp,
        make: data?.Make || data?.make || 'Desconocido',
        model: data?.Model || data?.model || 'Desconocido',
        lens: data?.LensModel || data?.lensModel || data?.LensInfo || 'N/A',
        iso: data?.ISO || data?.ISOSpeedRatings || data?.PhotographicSensitivity || null,
        focalLength: data?.FocalLength || data?.focalLength || null,
        focalLength35mm: data?.FocalLengthIn35mmFormat || null,
        exposure,
        fnumber: data?.FNumber || data?.ApertureValue || null,
        focalLength: data?.FocalLength || null,
        width: data?.ExifImageWidth || data?.ImageWidth || null,
        height: data?.ExifImageHeight || data?.ImageHeight || null,
        direction: data?.GPSImgDirection || null,
        directionRef: data?.GPSImgDirectionRef || null,
        altitude,
        latitude,
        longitude,
        utm,
        geoid: geoidSeparation,
        orthometric,
        speed: data?.GPSSpeed || null,
        source
    };
}

function setupMap() {
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView([state.gnss.latitude, state.gnss.longitude], 17);

    hybridLayer = L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=KPsw7SfjD8VR6pXqJx3NQ0dJrLrE2J28vKb5d9uKZ6SUIZIb2ypz6rZh0GJn4Ojd', {
        maxZoom: 20
    });

    topoLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    });

    if (state.mapLayer === 'topo') {
        topoLayer.addTo(map);
    } else {
        hybridLayer.addTo(map);
    }

    mapMarker = L.circleMarker([state.gnss.latitude, state.gnss.longitude], {
        radius: 8,
        color: '#32d4ff',
        fillColor: '#0ff0b3',
        fillOpacity: 0.9,
        weight: 3
    }).addTo(map);

    pointLayer = L.layerGroup().addTo(map);
    renderPointsOnMap();
}

function updateMap() {
    mapMarker.setLatLng([state.gnss.latitude, state.gnss.longitude]);
    if (!map.getBounds().contains(mapMarker.getLatLng())) {
        map.panTo(mapMarker.getLatLng());
    }
    renderPointsOnMap();
}

function renderPointsOnMap() {
    if (!map || !pointLayer) return;
    pointLayer.clearLayers();
    state.points
        .filter(point => Number.isFinite(point.lat) && Number.isFinite(point.lon))
        .forEach(point => {
            const marker = L.circleMarker([point.lat, point.lon], {
                radius: 6,
                color: '#0ff0b3',
                fillColor: '#32d4ff',
                fillOpacity: 0.55,
                weight: 2
            });
            const utm = point.utm || latLonToUtm(point.lat, point.lon);
            const geoid = Number.isFinite(point.geoidSeparation)
                ? point.geoidSeparation
                : resolveGeoidSeparation(point.lat, point.lon, state.gnss.geoidSeparation);
            if (!Number.isFinite(point.geoidSeparation) && Number.isFinite(geoid)) {
                point.geoidSeparation = geoid;
            }
            const orthometric = Number.isFinite(point.orthometric)
                ? point.orthometric
                : computeOrthometricHeight(point.alt, geoid);
            const lines = [
                `<strong>${escapeHtml(point.name)}</strong>`,
                `${escapeHtml(point.category || 'punto')} · ${escapeHtml(point.date || formatDateTimeLocal())}`,
                `UTM ${utm.zone}${utm.band}${utm.hemisphere}: ${utm.easting.toFixed(2)} E / ${utm.northing.toFixed(2)} N`,
                `Alt. elipsoidal ${formatMeters(point.alt)}`
            ];
            if (Number.isFinite(orthometric)) {
                lines.push(`Alt. EGM2008 ${formatMeters(orthometric)}`);
            }
            if (point.notes) {
                lines.push(escapeHtml(point.notes));
            }
            marker.bindPopup(lines.join('<br/>'));
            pointLayer.addLayer(marker);
        });
}

function updateRecordingButtons() {
    const desktopBtn = document.getElementById('recordBtn');
    const mobileBtn = document.getElementById('mobileRecordBtn');
    const icon = state.recording ? 'pause' : 'radio';
    const label = state.recording ? 'Detener registro' : 'Iniciar registro';
    if (desktopBtn) {
        desktopBtn.innerHTML = `<i data-lucide="${icon}"></i><span>${label}</span>`;
    }
    if (mobileBtn) {
        mobileBtn.innerHTML = `<i data-lucide="${icon}"></i><span>${label}</span>`;
        mobileBtn.classList.toggle('is-secondary', !state.recording);
    }
    lucide.createIcons();
}

function setRecordingState(nextState, { message, silent } = {}) {
    if (state.recording === nextState && !message) return;
    state.recording = nextState;
    updateRecordingButtons();
    updateLoggingCard();
    updateLoggingSummary();
    if (!nextState) {
        state.logging.startedAutomatically = false;
    }
    if (!silent) {
        showToast(message || (nextState ? 'Grabando puntos GNSS' : 'Registro detenido'));
    }
    queuePersist();
}

function toggleRecording() {
    setRecordingState(!state.recording);
}

function requestGeolocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
        position => {
            const { latitude, longitude, altitude } = position.coords;
            if (Number.isFinite(latitude) && Number.isFinite(longitude)) {
                state.gnss.latitude = latitude;
                state.gnss.longitude = longitude;
                if (Number.isFinite(altitude)) {
                    state.gnss.altitude = altitude;
                }
                const utm = latLonToUtm(latitude, longitude);
                state.gnss.utm = utm;
                state.gnss.source = 'Geolocalización';
                state.gnss.updatedAt = Date.now();
                state.gnss.locked = true;
                state.gnss.geoidSeparation = resolveGeoidSeparation(latitude, longitude, state.gnss.geoidSeparation);
                const ortho = computeOrthometricHeight(state.gnss.altitude, state.gnss.geoidSeparation);
                if (Number.isFinite(ortho)) {
                    state.gnss.orthometric = ortho;
                }
                state.project.location = `Zona UTM ${utm.zone}${utm.band}${utm.hemisphere}`;
                updateSolution();
                updateStakeoutPanel();
                updateProject();
                updateMap();
                queuePersist();
            }
        },
        error => {
            console.warn('Geolocalización no disponible', error);
            if (!geolocationWarningShown) {
                showToast('⚠️ Geolocalización no disponible. Esperando datos del módulo GNSS...');
                geolocationWarningShown = true;
            }
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function setupSnrChart() {
    const ctx = document.getElementById('snrChart');
    snrChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: state.snrHistory.map(item => item.label),
            datasets: [
                {
                    label: 'GPS',
                    data: state.snrHistory.map(item => item.gps),
                    borderColor: '#5be7a9',
                    tension: 0.35,
                    fill: false
                },
                {
                    label: 'GLONASS',
                    data: state.snrHistory.map(item => item.glonass),
                    borderColor: '#ffc75f',
                    tension: 0.35,
                    fill: false
                },
                {
                    label: 'Galileo',
                    data: state.snrHistory.map(item => item.galileo),
                    borderColor: '#32d4ff',
                    tension: 0.35,
                    fill: false
                }
            ]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: chartAxisColor() }, grid: { color: chartGridColor() } },
                y: { ticks: { color: chartAxisColor() }, grid: { color: chartGridColor() }, suggestedMin: 20, suggestedMax: 55 }
            }
        }
    });
    updateChartTheme();
}

function updateSnrChart() {
    state.snrHistory.shift();
    state.snrHistory.push({
        label: 'Ahora',
        gps: 38 + Math.random() * 8,
        glonass: 34 + Math.random() * 8,
        galileo: 36 + Math.random() * 8
    });

    snrChart.data.labels = state.snrHistory.map(item => item.label);
    snrChart.data.datasets[0].data = state.snrHistory.map(item => item.gps);
    snrChart.data.datasets[1].data = state.snrHistory.map(item => item.glonass);
    snrChart.data.datasets[2].data = state.snrHistory.map(item => item.galileo);
    snrChart.update();
}

function updateChartTheme() {
    if (!snrChart) return;
    const axis = chartAxisColor();
    const grid = chartGridColor();
    snrChart.options.scales.x.ticks.color = axis;
    snrChart.options.scales.y.ticks.color = axis;
    snrChart.options.scales.x.grid.color = grid;
    snrChart.options.scales.y.grid.color = grid;
    snrChart.update('none');
}

function bindMenu() {
    document.querySelectorAll('.menu__item').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.menu__item').forEach(item => item.classList.remove('is-active'));
            button.classList.add('is-active');

            Object.values(views).forEach(view => view.classList.remove('is-active'));
            views[button.dataset.view].classList.add('is-active');
            Object.entries(views).forEach(([key, view]) => {
                view.setAttribute('aria-hidden', key === button.dataset.view ? 'false' : 'true');
            });
        });
    });
}

function bindActions() {
    document.getElementById('themeToggle').addEventListener('click', () => {
        body.classList.toggle('light');
        showToast(body.classList.contains('light') ? 'Modo claro activado' : 'Modo nocturno activado');
        updateChartTheme();
    });

    document.getElementById('modeToggle').addEventListener('click', () => {
        state.mode = state.mode === 'Rover' ? 'Base' : 'Rover';
        document.querySelector('.mode-toggle__value').textContent = state.mode;
        showToast(`Modo ${state.mode}`);
        queuePersist();
    });

    document.getElementById('recordBtn').addEventListener('click', toggleRecording);

    document.getElementById('copyCoords').addEventListener('click', () => {
        navigator.clipboard.writeText(`${state.gnss.latitude.toFixed(7)}, ${state.gnss.longitude.toFixed(7)}, ${state.gnss.altitude.toFixed(2)}`);
        showToast('Coordenadas copiadas');
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
        // Forzar actualización desde el servidor
        if (realtimeConnected && socket) {
            socket.emit('request_update');
        }
        pollStatsFromServer();
        showToast('🔄 Solicitando actualización...');
    });

    document.getElementById('mapReset').addEventListener('click', () => {
        map.flyTo([state.gnss.latitude, state.gnss.longitude], 17, { duration: 0.6 });
    });

    document.getElementById('mapLayer').addEventListener('click', () => {
        if (state.mapLayer === 'hybrid') {
            map.removeLayer(hybridLayer);
            topoLayer.addTo(map);
            state.mapLayer = 'topo';
            showToast('Capa Topográfica activada');
        } else {
            map.removeLayer(topoLayer);
            hybridLayer.addTo(map);
            state.mapLayer = 'hybrid';
            showToast('Capa Satelital activada');
        }
        queuePersist();
    });

    const newPointBtn = document.getElementById('newPointBtn');
    if (newPointBtn) {
        newPointBtn.addEventListener('click', () => {
            populatePointForm();
            openModal('pointModal');
        });
    }
    const quickProjectBtn = document.getElementById('quickProjectBtn');
    if (quickProjectBtn) {
        quickProjectBtn.addEventListener('click', () => {
            openModal('projectModal');
        });
    }
    const quickStakeoutBtn = document.getElementById('quickStakeoutBtn');
    if (quickStakeoutBtn) {
        quickStakeoutBtn.addEventListener('click', () => {
            populateStakeoutForm();
            openModal('stakeoutModal');
        });
    }
    const qaStakeout = document.getElementById('qaStakeout');
    if (qaStakeout) {
        qaStakeout.addEventListener('click', () => {
            populateStakeoutForm();
            openModal('stakeoutModal');
        });
    }
    
    // Botones de exportación
    const exportCSVBtn = document.getElementById('exportCSVBtn');
    if (exportCSVBtn) {
        exportCSVBtn.addEventListener('click', exportToCSV);
    }
    
    const exportGeoJSONBtn = document.getElementById('exportGeoJSONBtn');
    if (exportGeoJSONBtn) {
        exportGeoJSONBtn.addEventListener('click', exportToGeoJSON);
    }
    
    const exportKMLBtn = document.getElementById('exportKMLBtn');
    if (exportKMLBtn) {
        exportKMLBtn.addEventListener('click', exportToKML);
    }

    document.getElementById('filesView').addEventListener('click', event => {
        if (event.target.closest('#syncBtn')) {
            state.sync.lastSync = 'Hace instantes';
            state.sync.pending = 0;
            updateFiles();
            lucide.createIcons();
            showToast('Sincronización completada');
            queuePersist();
        }
    });

    const captureBtn = document.getElementById('capturePhotoBtn');
    const photoInput = document.getElementById('photoInput');
    if (captureBtn && photoInput) {
        captureBtn.addEventListener('click', () => {
            photoInput.click();
        });
        photoInput.addEventListener('change', async event => {
            const [file] = event.target.files || [];
            if (!file) return;
            try {
                showToast('Procesando metadatos EXIF…');
                const metadata = await extractPhotoMetadata(file);
                const entry = {
                    id: `${Date.now()}`,
                    name: file.name || `Captura ${state.photos.length + 1}`,
                    size: file.size,
                    capturedAt: metadata.timestamp,
                    metadata
                };
                state.photos.unshift(entry);
                state.events.unshift({ title: 'Foto fotogramétrica registrada', time: 'Ahora mismo' });
                state.events = state.events.slice(0, 6);
                updatePhotoLog();
                updateTimeline();
                updateRtkBanner();
                queuePersist();
                const toastMessage = metadata.source && metadata.source.includes('GNSS')
                    ? 'Foto registrada con datos GNSS'
                    : 'Foto registrada con metadatos EXIF';
                showToast(toastMessage);
            } catch (error) {
                console.error('Error leyendo metadatos', error);
                showToast('No se pudieron leer los metadatos EXIF');
            } finally {
                event.target.value = '';
            }
        });
    }

    document.getElementById('controlView').addEventListener('click', event => {
        const copy = event.target.closest('[data-copy]');
        if (copy) {
            navigator.clipboard.writeText(copy.dataset.copy);
            showToast('✓ Comando copiado al portapapeles');
        }
        const send = event.target.closest('[data-command]');
        if (send) {
            const cmd = send.dataset.command;
            appendTerminalLog({ dir: 'TX', text: cmd });
            sendGnssCommand(cmd)
                .then(data => {
                    if (data && data.success) {
                        showToast(`✓ Comando ejecutado: ${cmd.substring(0, 25)}${cmd.length > 25 ? '...' : ''}`);
                        state.events.unshift({
                            title: `✓ Comando K222: ${cmd.substring(0, 30)}${cmd.length > 30 ? '...' : ''}`,
                            time: 'Ahora mismo'
                        });
                        if (data.response) {
                            appendTerminalLog({ dir: 'RX', text: String(data.response).trim() });
                        } else {
                            appendTerminalLog({ dir: 'RX', text: 'OK' });
                        }
                    } else {
                        showToast(`⚠️ Error: ${(data && data.error) || 'Comando falló'}`);
                        state.events.unshift({ title: `✗ Error comando: ${cmd.substring(0, 25)}`, time: 'Ahora mismo' });
                        if (data && data.error) appendTerminalLog({ dir: 'RX', text: `ERROR: ${data.error}` });
                    }
                    state.events = state.events.slice(0, 6);
                    updateTimeline();
                })
                .catch(error => {
                    console.error('Error enviando comando:', error);
                    showToast(`⚠️ No se pudo enviar comando al módulo`);
                    state.events.unshift({ title: `✗ Fallo conexión: ${cmd.substring(0, 20)}`, time: 'Ahora mismo' });
                    state.events = state.events.slice(0, 6);
                    updateTimeline();
                    appendTerminalLog({ dir: 'RX', text: `ERROR CONEXIÓN: ${error && error.message ? error.message : 'Fallo de red'}` });
                });
        }
    });

    const stakeoutSearch = document.getElementById('stakeoutSearch');
    if (stakeoutSearch) {
        stakeoutSearch.addEventListener('input', event => {
            populateStakeoutForm(event.target.value);
        });
    }

    // Terminal GNSS: enviar comando personalizado y limpiar log
    const cmdForm = document.getElementById('cmdForm');
    const cmdInput = document.getElementById('cmdInput');
    const cmdSendBtn = document.getElementById('cmdSendBtn');
    const cmdClearBtn = document.getElementById('cmdClearBtn');
    if (cmdForm && cmdInput) {
        const submitCustom = () => {
            const raw = (cmdInput.value || '').trim();
            if (!raw) {
                showToast('Ingresa un comando');
                return;
            }
            appendTerminalLog({ dir: 'TX', text: raw });
            sendGnssCommand(raw)
                .then(data => {
                    if (data && data.success) {
                        appendTerminalLog({ dir: 'RX', text: String(data.response || 'OK').trim() });
                        showToast('✓ Comando enviado');
                    } else {
                        appendTerminalLog({ dir: 'RX', text: `ERROR: ${(data && data.error) || 'Fallo'}` });
                        showToast('⚠️ Error al ejecutar comando');
                    }
                })
                .catch(err => {
                    appendTerminalLog({ dir: 'RX', text: `ERROR CONEXIÓN: ${err && err.message ? err.message : 'Fallo de red'}` });
                    showToast('⚠️ No se pudo enviar comando');
                });
        };
        cmdForm.addEventListener('submit', (e) => { e.preventDefault(); submitCustom(); });
        if (cmdSendBtn) cmdSendBtn.addEventListener('click', submitCustom);
    }
    if (cmdClearBtn) {
        cmdClearBtn.addEventListener('click', () => {
            const log = document.getElementById('terminalLog');
            if (log) {
                log.innerHTML = '<div class="terminal-log__empty" style="opacity:.7;">No hay mensajes aún. Usa comandos rápidos o escribe uno arriba.</div>';
            }
        });
    }

    document.getElementById('projectConfigBtn').addEventListener('click', () => {
        populateProjectForm();
        openModal('projectModal');
    });

    document.getElementById('ntripConfigBtn').addEventListener('click', () => {
        populateNtripForm();
        openModal('ntripModal');
    });

    document.getElementById('ntripCardBtn').addEventListener('click', () => {
        populateNtripForm();
        openModal('ntripModal');
    });

    const shareLinkBtn = document.getElementById('ntripShareLink');
    if (shareLinkBtn) {
        shareLinkBtn.addEventListener('click', async () => {
            try {
                const { url } = buildNtripSharePackage();
                if (navigator.share) {
                    await navigator.share({ title: 'Perfil NTRIP GNSS.AI', text: 'Perfil de correcciones K922', url });
                    showToast('Enlace NTRIP enviado');
                } else {
                    copyToClipboard(url, 'Enlace NTRIP copiado');
                }
            } catch (error) {
                console.error('No se pudo compartir enlace NTRIP', error);
                showToast('No se pudo generar el enlace NTRIP');
            }
        });
    }

    const shareTokenBtn = document.getElementById('ntripShareToken');
    if (shareTokenBtn) {
        shareTokenBtn.addEventListener('click', () => {
            try {
                const { token } = buildNtripSharePackage();
                copyToClipboard(token, 'Token NTRIP copiado');
            } catch (error) {
                console.error('No se pudo generar token NTRIP', error);
                showToast('No se pudo generar el token NTRIP');
            }
        });
    }

    document.getElementById('loggingConfigBtn').addEventListener('click', () => {
        populateLoggingForm();
        openModal('loggingModal');
    });

    document.getElementById('loggingCardBtn').addEventListener('click', () => {
        populateLoggingForm();
        openModal('loggingModal');
    });

    document.getElementById('stakeoutBtn').addEventListener('click', () => {
        populateStakeoutForm();
        openModal('stakeoutModal');
    });

    const stakeoutToggle = document.getElementById('stakeoutToggleBtn');
    if (stakeoutToggle) {
        stakeoutToggle.addEventListener('click', () => {
            state.stakeout.active = !state.stakeout.active;
            updateStakeoutPanel();
            queuePersist();
            showToast(state.stakeout.active ? 'Replanteo activado' : 'Replanteo en pausa');
        });
    }

    const mobileRecord = document.getElementById('mobileRecordBtn');
    if (mobileRecord) {
        mobileRecord.addEventListener('click', toggleRecording);
    }
    const mobileLogging = document.getElementById('mobileLoggingBtn');
    if (mobileLogging) {
        mobileLogging.addEventListener('click', () => {
            populateLoggingForm();
            openModal('loggingModal');
        });
    }
    const mobileNtrip = document.getElementById('mobileNtripBtn');
    if (mobileNtrip) {
        mobileNtrip.addEventListener('click', () => {
            populateNtripForm();
            openModal('ntripModal');
        });
    }
}

function bindForms() {
    const projectForm = document.getElementById('projectForm');
    projectForm.addEventListener('submit', event => {
        event.preventDefault();
        const data = new FormData(projectForm);
        state.project.name = data.get('projectName') || state.project.name;
        state.project.location = data.get('projectLocation') || state.project.location;
        state.project.owner = data.get('projectOwner') || state.project.owner;
        state.project.accuracy = data.get('projectAccuracy') || state.project.accuracy;
        state.project.code = data.get('projectCode') || state.project.code;
        state.project.notes = data.get('projectNotes') || '';
        state.project.datum = data.get('projectDatum') || 'WGS84';
        state.project.coordinateSystem = data.get('projectCoordinateSystem') || 'UTM';
        state.project.geoidModel = data.get('projectGeoidModel') || 'EGM2008';
        state.project.heightType = data.get('projectHeightType') || 'Ellipsoidal';
        state.project.unit = data.get('projectUnit') || 'Meters';
        state.project.precision = parseInt(data.get('projectPrecision'), 10) || 3;
        const pHeight = parseFloat(data.get('projectPoleHeight'));
        if (!Number.isNaN(pHeight)) state.project.poleHeight = pHeight;
        const apc = parseFloat(data.get('projectApcOffset'));
        if (!Number.isNaN(apc)) state.project.apcOffset = apc;
        state.project.stakeout.target = data.get('stakeoutTarget') || state.project.stakeout.target;
        const distance = parseFloat(data.get('stakeoutDistance'));
        const bearing = parseFloat(data.get('stakeoutBearing'));
        if (!Number.isNaN(distance)) state.project.stakeout.distance = distance;
        if (!Number.isNaN(bearing)) state.project.stakeout.bearing = bearing;

        if (data.get('projectReset') === 'on') {
            state.points = [];
            updatePoints();
        }

        state.events.unshift({ title: `Proyecto ${state.project.name} configurado · ${state.project.datum} · ${state.project.coordinateSystem}`, time: 'Ahora mismo' });
        state.events = state.events.slice(0, 6);
        updateTimeline();
        updateStakeoutPanel();
        queuePersist();
        closeModal('projectModal');
        showToast(`✓ Proyecto configurado: ${state.project.datum} · ${state.project.coordinateSystem} · ${state.project.geoidModel}`);
    });

    const ntripForm = document.getElementById('ntripForm');
    ntripForm.addEventListener('submit', event => {
        event.preventDefault();
        const data = new FormData(ntripForm);
        state.ntrip.enabled = data.get('ntripEnabled') === 'on';
        state.ntrip.caster = data.get('ntripCaster') || state.ntrip.caster;
        state.ntrip.port = parseInt(data.get('ntripPort'), 10) || state.ntrip.port;
        state.ntrip.mountpoint = data.get('ntripMountpoint') || state.ntrip.mountpoint;
        state.ntrip.format = data.get('ntripFormat') || state.ntrip.format;
        state.ntrip.username = data.get('ntripUser') || '';
        state.ntrip.password = data.get('ntripPass') || '';
        state.ntrip.bitrate = data.get('ntripBitrate') || state.ntrip.bitrate;
        const latency = parseFloat(data.get('ntripLatency'));
        if (!Number.isNaN(latency)) state.ntrip.latency = latency;
        state.ntrip.ssl = data.get('ntripSsl') === 'on';
        state.ntrip.notes = data.get('ntripNotes') || '';
        state.ntrip.lastConnect = state.ntrip.enabled ? 'Hace instantes' : 'Detenido';

        state.events.unshift({ title: state.ntrip.enabled ? 'NTRIP conectado' : 'NTRIP detenido', time: 'Ahora mismo' });
        state.events = state.events.slice(0, 6);

        updateTimeline();
        updateNtripCard();
        updateServices();
        updateStatusCards();
        queuePersist();
        closeModal('ntripModal');
        showToast(state.ntrip.enabled ? 'NTRIP listo para transmitir' : 'Sesión NTRIP desactivada');
    });

    const ntripTransfer = document.getElementById('ntripTransfer');
    const ntripTransferStatus = document.getElementById('ntripTransferStatus');
    const updateTransferStatus = (message, tone) => {
        if (!ntripTransferStatus) return;
        ntripTransferStatus.textContent = message;
        ntripTransferStatus.classList.remove('is-success', 'is-error');
        if (tone === 'success') {
            ntripTransferStatus.classList.add('is-success');
        } else if (tone === 'error') {
            ntripTransferStatus.classList.add('is-error');
        }
    };
    const importBtn = document.getElementById('ntripImportApply');
    if (importBtn && ntripTransfer) {
        importBtn.addEventListener('click', () => {
            const raw = ntripTransfer.value.trim();
            if (!raw) {
                updateTransferStatus('Ingresa un token o enlace NTRIP para importarlo', 'error');
                return;
            }
            const profile = decodeNtripPayload(raw);
            if (applyNtripProfile(profile)) {
                updateTransferStatus('Perfil NTRIP importado', 'success');
                queuePersist();
            } else {
                updateTransferStatus('No se pudo interpretar el token NTRIP', 'error');
            }
        });
    }
    const clearBtn = document.getElementById('ntripTransferClear');
    if (clearBtn && ntripTransfer) {
        clearBtn.addEventListener('click', () => {
            ntripTransfer.value = '';
            updateTransferStatus('Campo limpio y listo para pegar un token');
        });
    }

    const loggingForm = document.getElementById('loggingForm');
    loggingForm.addEventListener('submit', event => {
        event.preventDefault();
        const data = new FormData(loggingForm);
        state.logging.nmea = data.get('loggingNmea') === 'on';
        state.logging.rinex = data.get('loggingRinex') === 'on';
        state.logging.rtcm = data.get('loggingRtcm') === 'on';
        state.logging.autoUpload = data.get('loggingAuto') === 'on';
        state.logging.autoStart = data.get('loggingAutoStart') === 'on';
        state.logging.interval = Math.max(1, parseInt(data.get('loggingInterval'), 10) || state.logging.interval);
        state.logging.path = data.get('loggingPath') || state.logging.path;
        state.logging.destination = data.get('loggingDestination') || state.logging.destination;
        state.logging.notes = data.get('loggingNotes') || '';
        if (!state.logging.autoStart) {
            state.logging.startedAutomatically = false;
        }

        updateLoggingCard();
        updateLoggingSummary();
        populateLoggingForm();
        queuePersist();
        closeModal('loggingModal');
        showToast('Perfil de logging actualizado');
    });

    const stakeoutForm = document.getElementById('stakeoutForm');
    stakeoutForm.addEventListener('submit', event => {
        event.preventDefault();
        const data = new FormData(stakeoutForm);
        state.stakeout.tolerance = parseFloat(data.get('stakeoutTolerance')) || state.stakeout.tolerance;
        state.stakeout.poleHeight = parseFloat(data.get('stakeoutPole')) || state.stakeout.poleHeight;
        state.stakeout.guidance = data.get('stakeoutNotes') || '';

        const manual = data.get('stakeoutManual') === 'on' || data.get('stakeoutPoint') === 'manual';
        if (manual) {
            state.stakeout.mode = 'manual';
            state.stakeout.targetId = 'Manual';
            const lat = parseFloat(data.get('stakeoutLat'));
            const lon = parseFloat(data.get('stakeoutLon'));
            const alt = parseFloat(data.get('stakeoutAlt'));
            state.stakeout.manual = {
                lat: Number.isFinite(lat) ? lat : state.gnss.latitude,
                lon: Number.isFinite(lon) ? lon : state.gnss.longitude,
                alt: Number.isFinite(alt) ? alt : state.gnss.altitude
            };
            state.project.stakeout = {
                target: 'Manual',
                distance: 0,
                bearing: 0
            };
        } else {
            const targetId = data.get('stakeoutPoint');
            if (targetId) {
                state.stakeout.targetId = targetId;
            }
            state.stakeout.mode = 'point';
            state.stakeout.manual = null;
            const candidate = state.points.find(point => point.name === state.stakeout.targetId);
            if (candidate) {
                const offsets = calculateOffsets(
                    {
                        latitude: state.gnss.latitude,
                        longitude: state.gnss.longitude,
                        altitude: state.gnss.altitude
                    },
                    candidate
                );
                const distance = Math.sqrt(offsets.north ** 2 + offsets.east ** 2);
                const bearing = (Math.atan2(offsets.east, offsets.north) * 180) / Math.PI;
                state.project.stakeout = {
                    target: candidate.name,
                    distance,
                    bearing: (bearing + 360) % 360
                };
            }
        }

        state.stakeout.active = data.get('stakeoutActiveToggle') === 'on';

        updateStakeoutPanel();
        queuePersist();
        closeModal('stakeoutModal');
        showToast('Replanteo actualizado');
    });

    const pointForm = document.getElementById('pointForm');
    if (pointForm) {
        const syncPointOrthometric = () => {
            const altValue = parseFloat(pointForm.pointAltitude.value);
            const geoidValue = parseFloat(pointForm.pointGeoid.value);
            const orthometric = computeOrthometricHeight(altValue, geoidValue);
            pointForm.pointOrthometric.value = Number.isFinite(orthometric) ? orthometric.toFixed(2) : '';
        };
        ['pointAltitude', 'pointGeoid'].forEach(id => {
            const input = pointForm[id];
            if (input) {
                input.addEventListener('input', syncPointOrthometric);
            }
        });
        pointForm.addEventListener('submit', event => {
            event.preventDefault();
        const data = new FormData(pointForm);
            const name = data.get('pointName') || deriveNextPointName();
            const code = data.get('pointCode') || name;
            const description = data.get('pointDescription') || '';
            const category = data.get('pointCategory') || 'topografia';
            const notes = data.get('pointNotes') || '';
            const lat = parseFloat(data.get('pointLat'));
            const lon = parseFloat(data.get('pointLon'));
            const ellipsoidal = parseFloat(data.get('pointAltitude'));
            const geoid = parseFloat(data.get('pointGeoid'));
            const latValue = Number.isFinite(lat) ? lat : state.gnss.latitude;
            const lonValue = Number.isFinite(lon) ? lon : state.gnss.longitude;
            const altValue = Number.isFinite(ellipsoidal) ? ellipsoidal : state.gnss.altitude;
            const geoidValue = Number.isFinite(geoid)
                ? geoid
                : resolveGeoidSeparation(latValue, lonValue, state.gnss.geoidSeparation);
            let utm = latLonToUtm(latValue, lonValue);
            let orthometric = computeOrthometricHeight(altValue, geoidValue);
            const useTilt = data.get('pointUseTilt') === 'on';
            const poleHeight = parseFloat(data.get('pointPoleHeight'));
            const apcOffset = parseFloat(data.get('pointApcOffset'));
            const tiltDeg = Number(state.imu && state.imu.tilt) || 0;
            const headingDeg = Number(state.imu && state.imu.heading) || 0;
            if (useTilt && Number.isFinite(poleHeight) && poleHeight > 0 && Number.isFinite(tiltDeg) && Number.isFinite(headingDeg)) {
                const totalHeight = poleHeight + (Number.isFinite(apcOffset) ? apcOffset : 0);
                const rad = (Math.PI / 180) * tiltDeg;
                const dHoriz = totalHeight * Math.sin(rad);
                const dVert = totalHeight * Math.cos(rad);
                const th = (Math.PI / 180) * headingDeg;
                const eastOff = dHoriz * Math.sin(th);
                const northOff = dHoriz * Math.cos(th);
                const newUtm = {
                    zone: utm.zone,
                    hemisphere: utm.hemisphere,
                    easting: utm.easting + eastOff,
                    northing: utm.northing + northOff
                };
                const tip = utmToLatLon(newUtm);
                if (tip) {
                    latValue = tip.latitude;
                    lonValue = tip.longitude;
                    utm = tip.utm;
                }
                const altTip = altValue - dVert;
                orthometric = computeOrthometricHeight(altTip, geoidValue);
                altValue = altTip;
            }
            if (!Number.isFinite(state.gnss.geoidSeparation) && Number.isFinite(geoidValue)) {
                state.gnss.geoidSeparation = geoidValue;
            }
            const entry = {
                name,
                code,
                description,
                category,
                notes,
                lat: latValue,
                lon: lonValue,
                alt: altValue,
                geoidSeparation: geoidValue,
                orthometric: Number.isFinite(orthometric) ? orthometric : null,
                accuracy: Number.isFinite(state.gnss.horizontalAccuracy) ? state.gnss.horizontalAccuracy : 0.01,
                date: formatDateTimeLocal(new Date()),
                utm,
                poleHeight: Number.isFinite(poleHeight) ? poleHeight : null,
                apcOffset: Number.isFinite(apcOffset) ? apcOffset : null,
                tiltApplied: useTilt || false,
                tiltDeg: Number.isFinite(tiltDeg) ? tiltDeg : null,
                headingDeg: Number.isFinite(headingDeg) ? headingDeg : null
            };
            state.points.unshift(entry);
            state.events.unshift({ title: `Punto ${entry.name} almacenado`, time: 'Ahora mismo' });
            state.events = state.events.slice(0, 6);
            updatePoints();
            updateTimeline();
            updateStakeoutPanel();
            updateMap();
            renderPointsOnMap();
            queuePersist();
            closeModal('pointModal');
            showToast(`✓ Punto ${entry.name} guardado · ${entry.accuracy.toFixed(3)}m · ${state.gnss.fix}`);
        });
    }
}

// Realtime bridge (Socket.IO) to Pi backend
const urlParams = new URLSearchParams((typeof window !== 'undefined' && window.location && window.location.search) || '');
const PI_PORT = Number(urlParams.get('piport')) || 5000;
// Auto-detectar host: usar parámetro, o location.hostname si estamos en el mismo dispositivo, o IP fija
const PI_HOST = urlParams.get('pi') || 
    (typeof location !== 'undefined' && location.hostname && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1' 
        ? location.hostname 
        : '192.168.0.109');
let socket = null;
let simulateTimer = null;
let realtimeConnected = false;
let restPollTimer = null;

// Envío robusto de comandos (RFComm/Serial backend): intenta múltiples endpoints y origen
async function sendGnssCommand(cmd) {
    const base = (typeof PI_HOST !== 'undefined' && PI_HOST)
        ? `http://${PI_HOST}:${PI_PORT}`
        : (typeof location !== 'undefined' ? location.origin : '');
    const endpoints = [
        `${base}/api/command`,
        `${base}/api/rfcomm/command`,
        `${base}/rfcomm/command`,
        `/api/command`,
        `/api/rfcomm/command`,
    ];
    const payload = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ command: cmd }) };
    let lastError = null;
    for (const url of endpoints) {
        try {
            const res = await fetch(url, payload);
            // Algunos backends pueden responder 204 sin cuerpo
            if (res.status === 204) {
                return { success: true, response: 'OK' };
            }
            const data = await res.json().catch(() => ({ success: res.ok }));
            if (data && data.success !== false) return data;
            lastError = new Error(data && data.error ? data.error : `HTTP ${res.status}`);
        } catch (e) {
            lastError = e;
        }
    }
    throw lastError || new Error('No reachable endpoint');
}

function applyStatsFromServer(data) {
    if (!data) return;
    const normalizeSatellites = (d) => {
        let sats = [];
        if (Array.isArray(d.satellites_detail)) {
            sats = d.satellites_detail;
        } else if (Array.isArray(d.satellites)) {
            sats = d.satellites;
        } else if (Array.isArray(d.gsv)) {
            sats = d.gsv;
        } else if (Array.isArray(d.skyview)) {
            sats = d.skyview;
        }
        return sats.map(sat => ({
            id: sat.prn || sat.id || sat.svid || sat.sv || sat.satellite || 'UNK',
            snr: Number(sat.snr || sat.SNR || sat.cnr || sat.signal || 0),
            elevation: Number(sat.elevation || sat.el || sat.elev || 0),
            azimuth: Number(sat.azimuth || sat.az || 0),
            constellation: sat.constellation || sat.sys || sat.system || 'Unknown',
            signalType: sat.signal_type || sat.sigtype || sat.signal || 'Unknown',
            confidence: Number(sat.confidence || 0)
        }));
    };
    if (data.position) {
        state.gnss.latitude = Number(data.position.lat) || state.gnss.latitude;
        state.gnss.longitude = Number(data.position.lon) || state.gnss.longitude;
        state.gnss.altitude = Number(data.position.alt) || state.gnss.altitude;
        state.gnss.utm = latLonToUtm(state.gnss.latitude, state.gnss.longitude);
        state.gnss.updatedAt = Date.now();
    }
    state.gnss.satellites = Number(data.satellites) || state.gnss.satellites;
    state.gnss.hdop = Number(data.hdop) || state.gnss.hdop;
    state.gnss.fix = (data.rtk_status || '').replace('_',' ') || state.gnss.fix;
    state.gnss.source = 'K222';
    if (typeof data.estimated_accuracy === 'number') {
        state.gnss.horizontalAccuracy = data.estimated_accuracy;
    }
    if (typeof data.uptime !== 'undefined') {
        state.system = state.system || {};
        state.system.uptime = data.uptime;
    }
    if (typeof data.avg_confidence !== 'undefined') {
        state.ml = state.ml || {};
        state.ml.avgConfidence = data.avg_confidence;
    }
    const sats = normalizeSatellites(data);
    if (sats.length) {
        state.satellites = sats;
        state.gnss.satellites = sats.length;
    }
    // Actualizar distribución ML
    if (typeof data.los_sats !== 'undefined') {
        state.ml = state.ml || {};
        state.ml.losSats = data.los_sats;
        state.ml.multipathSats = data.multipath_sats;
        state.ml.nlosSats = data.nlos_sats;
    }
}

function setupSocket() {
    try {
        const base = `http://${PI_HOST}:${PI_PORT}`;
        console.log('Intentando conectar Socket.IO a:', base);
        const script = document.createElement('script');
        script.src = `https://cdn.socket.io/4.5.4/socket.io.min.js`;
        script.async = true;
        script.onload = () => {
            try {
                const endpoint = `${base}/ws`;
                console.log('Conectando a endpoint:', endpoint);
                socket = io(endpoint, { 
                    transports: ['websocket', 'polling'],
                    timeout: 5000,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 1000
                });
                socket.on('connect', () => {
                    console.log('✅ Socket.IO conectado exitosamente');
                    realtimeConnected = true;
                    showToast('🔗 Conectado al backend GNSS');
                    if (simulateTimer) {
                        clearInterval(simulateTimer);
                        simulateTimer = null;
                    }
                });
                socket.on('stats', (data) => {
                    applyStatsFromServer(data);
                    updateStatusCards();
                    updateSolution();
                    updateConnectionStatus();
                    updateConstellations();
                    updateServices();
                    updateImu();
                    updateTimeline();
                    updateStakeoutPanel();
                    updatePoints();
                    updateSatellites();
                    updateCommands();
                    updateProfiles();
                    updateFiles();
                    updateNtripCard();
                    updateLoggingCard();
                    updateLoggingSummary();
                    updatePhotoLog();
                    updateMap();
                    updateSnrChart();
                });
                socket.on('connect_error', (error) => {
                    console.warn('Socket.IO error:', error);
                    realtimeConnected = false;
                    updateConnectionStatus();
                    setupRestPolling();
                });
                socket.on('disconnect', () => {
                    console.warn('Socket.IO disconnected');
                    realtimeConnected = false;
                    updateConnectionStatus();
                    setupRestPolling();
                });
            } catch (e) {
                console.warn('Socket.IO setup failed:', e);
                setupRestPolling();
            }
        };
        document.head.appendChild(script);
    } catch (e) {}
}

function setupRestPolling() {
    const base = `http://${PI_HOST}:${PI_PORT}`;
    console.log('🔄 Iniciando REST polling a:', base);
    if (restPollTimer) clearInterval(restPollTimer);
    restPollTimer = setInterval(async () => {
        if (realtimeConnected) return;
        try {
            const res = await fetch(`${base}/api/stats`, { cache: 'no-store' });
            if (res.ok) {
                const text = await res.text();
                console.log('📥 Datos recibidos (primeros 200 chars):', text.substring(0, 200));
                let payload = null;
                try {
                    payload = JSON.parse(text);
                    console.log('✅ JSON parseado correctamente:', payload);
                } catch (e) {
                    console.warn('⚠️ Error parseando JSON, intentando limpiar:', e.message);
                    try {
                        // Manejar respuestas concatenadas tipo `}{` o `}, {`
                        const cleaned = `[${text
                          .trim()
                          .replace(/}\s*{/, '},{')
                          .replace(/}\s*,\s*{/, '},{')}]`;
                        const arr = JSON.parse(cleaned);
                        payload = Array.isArray(arr) ? arr[0] : null;
                        console.log('✅ JSON limpiado y parseado:', payload);
                    } catch (e2) {
                        console.error('❌ No se pudo parsear JSON ni limpiado:', e2.message);
                        // Fallback: parsear NMEA GSV de texto crudo
                        const lines = text.split(/\r?\n/).filter(l => /\$..GSV/.test(l));
                        if (lines.length) {
                            const sats = [];
                            lines.forEach(line => {
                                // $GxGSV,totalMsgs,msgNo,totalSats,sv,el,az,snr,sv,el,az,snr,...
                                const parts = line.split(',');
                                for (let i = 4; i + 3 < parts.length; i += 4) {
                                    const sv = parts[i];
                                    const el = Number(parts[i + 1]);
                                    const az = Number(parts[i + 2]);
                                    const snrPart = parts[i + 3];
                                    const snr = Number(snrPart.replace('*', ''));
                                    sats.push({ id: sv, elevation: el, azimuth: az, snr, constellation: line.substring(1,3), signal_type: 'NMEA' });
                                }
                            });
                            payload = { satellites_detail: sats };
                            console.log('✅ Satélites derivados de NMEA GSV:', sats.length);
                        } else {
                            payload = null;
                        }
                    }
                }
                if (payload) {
                    console.log('📊 Aplicando datos al state...');
                    applyStatsFromServer(payload);
                    console.log('📊 State actualizado:', {
                        lat: state.gnss.latitude,
                        lon: state.gnss.longitude,
                        sats: state.gnss.satellites,
                        fix: state.gnss.fix
                    });
                    if (simulateTimer) {
                        clearInterval(simulateTimer);
                        simulateTimer = null;
                    }
                } else {
                    console.error('❌ Payload es null, no se actualizará el state');
                }
                console.log('🔄 Actualizando UI...');
                updateStatusCards();
                updateSolution();
                updateConnectionStatus();
                updateConstellations();
                updateServices();
                updateImu();
                updateTimeline();
                updateStakeoutPanel();
                updatePoints();
                updateSatellites();
                updateCommands();
                updateProfiles();
                updateFiles();
                updateNtripCard();
                updateLoggingCard();
                updateLoggingSummary();
                updatePhotoLog();
                updateMap();
                updateSnrChart();
                console.log('✅ UI actualizada');
            } else {
                console.error('❌ Error HTTP:', res.status, res.statusText);
            }
        } catch (e) {
            console.error('❌ Error en REST polling:', e);
        }
    }, 1000);
}

// Función de simulación eliminada - todos los datos vienen del módulo GNSS real

// Funciones de exportación
function exportToCSV() {
    if (!state.points.length) {
        showToast('⚠️ No hay puntos para exportar');
        return;
    }
    
    const precision = state.project.precision || 3;
    const headers = ['Nombre', 'Código', 'Categoría', 'Latitud', 'Longitud', 'Altura Elipsoidal', 'Altura Ortométrica', 'Zona UTM', 'Este', 'Norte', 'Precisión (m)', 'Fecha', 'Notas'];
    const rows = state.points.map(p => {
        const utm = p.utm || latLonToUtm(p.lat, p.lon);
        const ortho = Number.isFinite(p.orthometric) ? p.orthometric.toFixed(precision) : '';
        return [
            p.name || '',
            p.code || '',
            p.category || '',
            p.lat.toFixed(8),
            p.lon.toFixed(8),
            p.alt.toFixed(precision),
            ortho,
            `${utm.zone}${utm.band}${utm.hemisphere}`,
            utm.easting.toFixed(precision),
            utm.northing.toFixed(precision),
            p.accuracy.toFixed(4),
            p.date || '',
            (p.notes || '').replace(/"/g, '""')
        ];
    });
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${state.project.code || 'puntos'}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    showToast(`✓ ${state.points.length} puntos exportados a CSV`);
}

function exportToGeoJSON() {
    if (!state.points.length) {
        showToast('⚠️ No hay puntos para exportar');
        return;
    }
    
    const precision = state.project.precision || 3;
    const features = state.points.map(p => {
        const utm = p.utm || latLonToUtm(p.lat, p.lon);
        const ortho = Number.isFinite(p.orthometric) ? p.orthometric : null;
        return {
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [Number(p.lon.toFixed(8)), Number(p.lat.toFixed(8)), Number(p.alt.toFixed(precision))]
            },
            properties: {
                name: p.name || '',
                code: p.code || '',
                category: p.category || '',
                altitude_ellipsoidal: Number(p.alt.toFixed(precision)),
                altitude_orthometric: ortho ? Number(ortho.toFixed(precision)) : null,
                utm_zone: `${utm.zone}${utm.band}${utm.hemisphere}`,
                utm_easting: Number(utm.easting.toFixed(precision)),
                utm_northing: Number(utm.northing.toFixed(precision)),
                accuracy: Number(p.accuracy.toFixed(4)),
                date: p.date || '',
                notes: p.notes || '',
                datum: state.project.datum || 'WGS84',
                geoid_model: state.project.geoidModel || 'EGM2008'
            }
        };
    });
    
    const geojson = {
        type: 'FeatureCollection',
        crs: {
            type: 'name',
            properties: { name: `urn:ogc:def:crs:EPSG::4326` }
        },
        features
    };
    
    const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${state.project.code || 'puntos'}_${new Date().toISOString().split('T')[0]}.geojson`;
    link.click();
    URL.revokeObjectURL(url);
    showToast(`✓ ${state.points.length} puntos exportados a GeoJSON`);
}

function exportToKML() {
    if (!state.points.length) {
        showToast('⚠️ No hay puntos para exportar');
        return;
    }
    
    const precision = state.project.precision || 3;
    const placemarks = state.points.map(p => {
        const utm = p.utm || latLonToUtm(p.lat, p.lon);
        const ortho = Number.isFinite(p.orthometric) ? p.orthometric.toFixed(precision) : 'N/A';
        const description = `
            <![CDATA[
            <b>Código:</b> ${p.code || 'N/A'}<br/>
            <b>Categoría:</b> ${p.category || 'N/A'}<br/>
            <b>Altura Elipsoidal:</b> ${p.alt.toFixed(precision)} m<br/>
            <b>Altura Ortométrica:</b> ${ortho} m<br/>
            <b>UTM:</b> ${utm.zone}${utm.band}${utm.hemisphere} ${utm.easting.toFixed(precision)}E ${utm.northing.toFixed(precision)}N<br/>
            <b>Precisión:</b> ${(p.accuracy * 100).toFixed(1)} cm<br/>
            <b>Fecha:</b> ${p.date || 'N/A'}<br/>
            <b>Notas:</b> ${p.notes || 'N/A'}
            ]]>
        `;
        return `
        <Placemark>
            <name>${p.name || 'Punto'}</name>
            <description>${description}</description>
            <Point>
                <coordinates>${p.lon.toFixed(8)},${p.lat.toFixed(8)},${p.alt.toFixed(precision)}</coordinates>
            </Point>
        </Placemark>`;
    }).join('\n');
    
    const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${state.project.name || 'Proyecto GNSS'}</name>
        <description>Proyecto: ${state.project.name} | Datum: ${state.project.datum || 'WGS84'} | Modelo geoidal: ${state.project.geoidModel || 'EGM2008'}</description>
        ${placemarks}
    </Document>
</kml>`;
    
    const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${state.project.code || 'puntos'}_${new Date().toISOString().split('T')[0]}.kml`;
    link.click();
    URL.revokeObjectURL(url);
    showToast(`✓ ${state.points.length} puntos exportados a KML`);
}

function init() {
    hydrateFromStorage();
    applyTheme();
    applyNtripFromUrl();
    lucide.createIcons();
    bindMenu();
    bindActions();
    bindForms();
    setupModals();
    setupMap();
    setupSnrChart();
    requestGeolocation();
    updateRecordingButtons();
    const mobileToolbar = document.getElementById('mobileToolbar');
    if (mobileToolbar) {
        const syncMobileToolbar = () => {
            mobileToolbar.setAttribute('aria-hidden', window.innerWidth > 1100 ? 'true' : 'false');
        };
        syncMobileToolbar();
        window.addEventListener('resize', syncMobileToolbar);
    }
    updateStatusCards();
    updateSolution();
    updateConnectionStatus();
    updateConstellations();
    updateServices();
    updateImu();
    updateTimeline();
    // Vendor selector wiring
    const vendorSelect = document.getElementById('vendorSelect');
    if (vendorSelect) {
        try { vendorSelect.value = state.vendor || 'ComNav'; } catch (e) {}
        vendorSelect.addEventListener('change', () => {
            state.vendor = vendorSelect.value || 'ComNav';
            updateCommands();
            queuePersist();
        });
    }

    // Theme toggle wiring
    const themeBtn = document.getElementById('themeToggle');
    if (themeBtn) {
        themeBtn.addEventListener('click', () => {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            queuePersist();
        });
    }

    // Quick actions wiring
    const qaSavePoint = document.getElementById('qaSavePoint');
    if (qaSavePoint) {
        qaSavePoint.addEventListener('click', () => {
            populatePointForm();
            openModal('pointModal');
        });
    }
    const qaPhoto = document.getElementById('qaPhoto');
    if (qaPhoto) {
        qaPhoto.addEventListener('click', () => {
            const btn = document.getElementById('capturePhotoBtn');
            if (btn) btn.click();
        });
    }
    const qaExport = document.getElementById('qaExport');
    if (qaExport) {
        qaExport.addEventListener('click', () => {
            const btn = document.getElementById('exportKMLBtn');
            if (btn) btn.click();
        });
    }
    const qaStakeout = document.getElementById('qaStakeout');
    if (qaStakeout) {
        qaStakeout.addEventListener('click', () => {
            populateStakeoutForm();
            openModal('stakeoutModal');
        });
    }
    const qaHighPrecision = document.getElementById('qaHighPrecision');
    if (qaHighPrecision) {
        qaHighPrecision.addEventListener('click', () => {
            const cmd = 'LOG GPGGA COM1 ONTIME 1';
            appendTerminalLog({ dir: 'TX', text: cmd });
            sendGnssCommand(cmd).then(data => {
                if (data && data.success) {
                    appendTerminalLog({ dir: 'RX', text: String(data.response || 'OK').trim() });
                    showToast('✓ Alta precisión: GGA 1Hz habilitado');
                } else {
                    appendTerminalLog({ dir: 'RX', text: `ERROR: ${(data && data.error) || 'Fallo'}` });
                    showToast('⚠️ Error habilitando alta precisión');
                }
            }).catch(err => {
                appendTerminalLog({ dir: 'RX', text: `ERROR CONEXIÓN: ${err && err.message ? err.message : 'Fallo de red'}` });
                showToast('⚠️ Error de red');
            });
        });
    }

    updateStakeoutPanel();
    updatePoints();
    updateSatellites();
    updateCommands();
    updateProfiles();
    updateFiles();
    updateNtripCard();
    updateLoggingCard();
    updateLoggingSummary();
    updatePhotoLog();
    updateSessionTimer();

    if (canPersist && typeof window !== 'undefined') {
        window.addEventListener('storage', event => {
            if (event.key === STORAGE_KEY) {
                hydrateFromStorage();
                updateStatusCards();
                updateSolution();
                updateConstellations();
                updateRtkBanner();
                updateServices();
                updateImu();
                updateTimeline();
                updateStakeoutPanel();
                updatePoints();
                updateSatellites();
                updateCommands();
                updateProfiles();
                updateFiles();
                updateNtripCard();
                updateLoggingCard();
                updateLoggingSummary();
                updatePhotoLog();
                updateMap();
            }
        });
    }

    setInterval(updateSessionTimer, 1000);
    setupSocket();
    setupRestPolling();

    if (pendingNtripNotice) {
        showToast(pendingNtripNotice);
        pendingNtripNotice = null;
    }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>