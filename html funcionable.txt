<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNSS.AI Dashboard PRO</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: linear-gradient(135deg, #0a2463 0%, #1a1a2e 100%);
            --bg-card: rgba(255, 255, 255, 0.03);
            --border-color: rgba(0, 240, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-color: #00f0ff;
            --accent-secondary: #00d9a3;
        }

        body.light-mode {
            --bg-primary: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
            --bg-card: rgba(255, 255, 255, 0.9);
            --border-color: rgba(0, 150, 200, 0.3);
            --text-primary: #1a1a1a;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --accent-color: #0288d1;
            --accent-secondary: #00897b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        /* Smooth value animations */
        .animated-value {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .value-changed {
            animation: valueFlash 0.5s ease;
        }

        @keyframes valueFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid var(--border-color);
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .logo-section h1 {
            font-size: 2.5em;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 5px;
        }

        .project-info {
            margin-top: 10px;
            padding: 10px 15px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .project-info:hover {
            background: rgba(0, 240, 255, 0.2);
            transform: translateX(5px);
        }

        .project-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .project-date {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .logo-gnss { color: #ffffff; }
        .logo-dot { color: #00f0ff; }
        .logo-ai {
            background: linear-gradient(135deg, #00f0ff, #00d9a3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { opacity: 0.8; font-size: 1.1em; }

        .status-section { 
            text-align: right; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 5px;
            display: flex;
            gap: 5px;
            cursor: pointer;
        }

        .theme-btn {
            padding: 8px 15px;
            border-radius: 15px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: flex-end;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
        }

        .status-dot.connected {
            background: #00d9a3;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .uptime { opacity: 0.7; font-size: 0.9em; }

        /* RTK Banner */
        .rtk-banner {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 3px solid;
            transition: all 0.3s ease;
            position: relative;
        }

        .alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            animation: blink 1s infinite;
            display: none;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        .rtk-label { font-size: 1.2em; opacity: 0.8; margin-bottom: 10px; }
        .rtk-status { font-size: 3em; font-weight: 900; margin: 10px 0; }
        .rtk-details { margin-top: 15px; opacity: 0.9; }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 240, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-icon { font-size: 2em; margin-bottom: 15px; }
        .stat-label { opacity: 0.7; font-size: 0.9em; margin-bottom: 10px; }
        .stat-value { font-size: 2.5em; font-weight: 900; margin: 10px 0; }
        .stat-subtitle { font-size: 0.85em; opacity: 0.6; }

        /* Tabs */
        .tabs-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 240, 255, 0.3);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(0, 240, 255, 0.1);
            border-color: rgba(0, 240, 255, 0.6);
        }

        .tab-btn.active {
            background: rgba(0, 240, 255, 0.2);
            border-color: #00f0ff;
            font-weight: bold;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Detail Grid */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(0, 240, 255, 0.2);
        }

        .detail-card h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 240, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #00f0ff;
        }

        .position-value {
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Forms */
        .input-group { margin-bottom: 15px; }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 1em;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #00f0ff;
        }

        .btn {
            background: linear-gradient(135deg, #00f0ff, #00d9a3);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4d4d, #ff6b6b);
        }

        /* Map */
        #map {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            border: 2px solid rgba(0, 240, 255, 0.2);
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            background: white;
            border: 2px solid #00f0ff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Points List */
        .points-table {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .point-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid;
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .point-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .point-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .point-delete {
            background: #ff4d4d;
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(0, 240, 255, 0.2);
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Sky Plot */
        .skyplot-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(0, 240, 255, 0.2);
            text-align: center;
        }

        .skyplot-canvas {
            width: 500px;
            height: 500px;
            margin: 0 auto;
            display: block;
            background: radial-gradient(circle, rgba(0, 240, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        /* Signal Bars */
        .signal-bar-container { margin-bottom: 15px; }

        .signal-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9em;
        }

        .signal-bar-bg {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .signal-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 5px;
        }

        /* Stakeout */
        .stakeout-navigation {
            text-align: center;
            padding: 30px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 15px;
            border: 2px solid #ffc107;
            margin-bottom: 20px;
        }

        .distance-display {
            font-size: 4em;
            font-weight: 900;
            color: #ffc107;
            margin: 20px 0;
        }

        .direction-arrow {
            font-size: 5em;
            margin: 20px 0;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border-left: 4px solid;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.success { border-color: #4caf50; }
        .toast.error { border-color: #f44336; }
        .toast.warning { border-color: #ff9800; }
        .toast.info { border-color: #00bcd4; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #00f0ff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
        }

        /* Photo Gallery */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4d4d;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .status-section { text-align: center; margin-top: 15px; }
            .connection-status { justify-content: center; }
            .detail-grid, .stats-grid { grid-template-columns: 1fr; }
            #map { height: 400px; }
            .skyplot-canvas { width: 100%; max-width: 400px; height: 400px; }
        }

        /* Precision Chart Container */
        .precision-chart-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        .precision-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 10px;
            margin-top: 15px;
        }

        .precision-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            border: 4px solid;
            animation: pulse-precision 2s infinite;
        }

        @keyframes pulse-precision {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Session Stats */
        .session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .session-stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-color);
        }

        .session-stat-value {
            font-size: 2em;
            font-weight: 900;
            color: var(--accent-color);
        }

        .session-stat-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Track Recording */
        .track-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .track-btn {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .track-btn.recording {
            background: linear-gradient(135deg, #f44336, #ff6b6b);
            color: white;
            animation: recording-pulse 1s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
        }

        /* High Precision Mode */
        .precision-mode-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.5);
            z-index: 9999;
            animation: slideInRight 0.5s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .averaging-progress {
            margin-top: 10px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .averaging-bar {
            height: 100%;
            background: linear-gradient(90deg, #00f0ff, #00d9a3);
            transition: width 0.3s ease;
        }

        /* Compact Mobile View */
        .compact-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-color);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 240, 255, 0.5);
            z-index: 9998;
            display: none;
        }

        @media (max-width: 768px) {
            .compact-toggle { display: block; }
            
            body.compact-mode .stats-grid,
            body.compact-mode .detail-grid,
            body.compact-mode .quick-actions,
            body.compact-mode .tabs-nav {
                display: none;
            }
            
            body.compact-mode .header {
                padding: 15px;
            }
            
            body.compact-mode .rtk-banner {
                padding: 15px;
            }
        }

        /* Custom Theme Selector */
        .theme-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .theme-color:hover {
            transform: scale(1.1);
        }

        .theme-color.active {
            border-color: white;
            box-shadow: 0 0 15px currentColor;
        }

        /* Notification Badge */
        .notification-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.5);
            z-index: 10000;
            animation: slideInDown 0.5s ease;
            cursor: pointer;
        }

        @keyframes slideInDown {
            from { transform: translateY(-100px); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <h1>
                <span class="logo-gnss">GNSS</span><span class="logo-dot">.</span><span class="logo-ai">AI</span>
            </h1>
            <p class="subtitle">üß† Professional Suite - ML Enhanced</p>
            
            <div class="project-info" onclick="editProjectName()">
                <div class="project-name" id="projectName">üìã My Survey Project</div>
                <div class="project-date" id="projectDate">Started: Loading...</div>
            </div>
        </div>
        
        <div class="status-section">
            <div class="theme-toggle">
                <button class="theme-btn active" id="darkBtn" onclick="setTheme('dark')">üåô Dark</button>
                <button class="theme-btn" id="lightBtn" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
            </div>
            
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionText">Connecting...</span>
            </div>
            <div class="uptime">
                Uptime: <span id="uptime">0s</span> | 
                <span id="offlineIndicator" style="display:none;">üì± OFFLINE MODE</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-btn" onclick="quickSavePoint()">üíæ Quick Save</button>
        <button class="quick-btn" onclick="showPhotoModal()">üì∏ Take Photo</button>
        <button class="quick-btn" onclick="toggleTracking()">
            <span id="trackIcon">üé¨</span> <span id="trackText">Start Track</span>
        </button>
        <button class="quick-btn" onclick="toggleHighPrecision()">üéØ High Precision</button>
        <button class="quick-btn" onclick="exportAllData()">üì• Export All</button>
        <button class="quick-btn" onclick="syncToCloud()">‚òÅÔ∏è Sync Cloud</button>
        <button class="quick-btn" onclick="generateReport()">üìä PDF Report</button>
        <button class="quick-btn" onclick="showCalculator()">üßÆ Calculator</button>
        <button class="quick-btn" onclick="showSessionStats()">üìà Statistics</button>
    </div>

    <!-- RTK Status Banner -->
    <div class="rtk-banner" id="rtkBanner">
        <div class="alert-badge" id="alertBadge">‚ö†Ô∏è RTK LOST</div>
        <div class="rtk-label">RTK Status</div>
        <div class="rtk-status" id="rtkStatus">NO FIX</div>
        <div class="rtk-details">
            Quality: <span id="quality">0</span> | HDOP: <span id="hdop">0.00</span> | Satellites: <span id="satCount">0</span>
        </div>
    </div>

    <!-- Main Stats -->
    <div class="stats-grid">
        <div class="stat-card" style="border-color: rgba(0, 188, 212, 0.5);">
            <div class="stat-icon">üõ∞Ô∏è</div>
            <div class="stat-label">Total Satellites</div>
            <div class="stat-value" style="color: #00bcd4;" id="totalSats">0</div>
            <div class="stat-subtitle">Tracked in view</div>
        </div>

        <div class="stat-card" style="border-color: rgba(76, 175, 80, 0.5);">
            <div class="stat-icon">üì°</div>
            <div class="stat-label">NMEA Messages</div>
            <div class="stat-value" style="color: #4caf50;" id="nmeaCount">0</div>
            <div class="stat-subtitle">Total transmitted</div>
        </div>

        <div class="stat-card" style="border-color: rgba(156, 39, 176, 0.5);">
            <div class="stat-icon">üß†</div>
            <div class="stat-label">ML Corrections</div>
            <div class="stat-value" style="color: #9c27b0;" id="mlCorrections">0</div>
            <div class="stat-subtitle" id="mlConfidence">Confidence: 0%</div>
        </div>

        <div class="stat-card" style="border-color: rgba(255, 193, 7, 0.5);">
            <div class="stat-icon">üéØ</div>
            <div class="stat-label">Accuracy</div>
            <div class="stat-value" style="color: #ffc107;" id="accuracy">N/A</div>
            <div class="stat-subtitle">Estimated precision</div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('overview')">üìä Overview</button>
        <button class="tab-btn" onclick="switchTab('precision')">üéØ Precision</button>
        <button class="tab-btn" onclick="switchTab('session')">üìà Session Stats</button>
        <button class="tab-btn" onclick="switchTab('map')">üó∫Ô∏è Map</button>
        <button class="tab-btn" onclick="switchTab('points')">üìç Points</button>
        <button class="tab-btn" onclick="switchTab('tracks')">üõ§Ô∏è Tracks</button>
        <button class="tab-btn" onclick="switchTab('stakeout')">üìè Stakeout</button>
        <button class="tab-btn" onclick="switchTab('charts')">üìà Charts</button>
        <button class="tab-btn" onclick="switchTab('skyplot')">üõ∞Ô∏è Sky Plot</button>
        <button class="tab-btn" onclick="switchTab('photos')">üì∏ Photos</button>
        <button class="tab-btn" onclick="switchTab('camera')">üìπ Camera</button>
        <button class="tab-btn" onclick="switchTab('tools')">üîß Tools</button>
    </div>

    <!-- Tab: Overview -->
    <div id="tab-overview" class="tab-content active">
        <div class="detail-grid">
            <div class="detail-card" style="background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); border: 2px solid #00f0ff;">
                <h3 style="color: #00f0ff;"><span>üìç</span> Current Position</h3>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="coord-type-btn" id="coordTypeDD" onclick="setCoordType('dd')" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); color: white; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        Decimal
                    </button>
                    <button class="coord-type-btn active" id="coordTypeUTM" onclick="setCoordType('utm')" style="flex: 1; padding: 12px; background: rgba(0,240,255,0.3); border: 2px solid #00f0ff; color: white; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        UTM WGS84
                    </button>
                </div>

                <div id="coordsDecimal" style="display: none;">
                    <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                        <span style="font-weight: 600;">Latitude</span>
                        <span class="position-value animated-value" id="latitude" style="color: #00f0ff; font-size: 1.1em;">0.0000000¬∞</span>
                    </div>
                    <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                        <span style="font-weight: 600;">Longitude</span>
                        <span class="position-value animated-value" id="longitude" style="color: #00f0ff; font-size: 1.1em;">0.0000000¬∞</span>
                    </div>
                </div>

                <div id="coordsUTM">
                    <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                        <span style="font-weight: 600;">Zone</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="position-value animated-value" id="utmZone" style="color: #00f0ff; font-size: 1.3em; font-weight: 900;">17M</span>
                            <button onclick="showZoneSelector()" style="padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid #00f0ff; border-radius: 5px; color: #00f0ff; cursor: pointer; font-size: 0.8em;">
                                ‚öôÔ∏è Change
                            </button>
                        </div>
                    </div>
                    <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                        <span style="font-weight: 600;">Easting</span>
                        <span class="position-value animated-value" id="utmEasting" style="color: #00f0ff; font-size: 1.1em;">0.00 m</span>
                    </div>
                    <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                        <span style="font-weight: 600;">Northing</span>
                        <span class="position-value animated-value" id="utmNorthing" style="color: #00f0ff; font-size: 1.1em;">0.00 m</span>
                    </div>
                </div>

                <div class="position-row" style="background: rgba(0,240,255,0.15); border-left-color: #00f0ff;">
                    <span style="font-weight: 600;">Altitude</span>
                    <span class="position-value animated-value" id="altitude" style="color: #00f0ff; font-size: 1.1em;">0.00 m</span>
                </div>
                
                <button class="btn" onclick="copyCoordinates()" style="margin-top: 20px; background: linear-gradient(135deg, #00f0ff, #00d9a3); box-shadow: 0 4px 15px rgba(0,240,255,0.4);">
                    üìã Copy Coordinates
                </button>
            </div>

            <div class="detail-card" style="border-color: rgba(0, 217, 163, 0.3);">
                <h3 style="color: #00d9a3;"><span>üì∂</span> Signal Quality (ML)</h3>
                
                <div class="signal-bar-container">
                    <div class="signal-bar-header">
                        <span>LOS (Excellent)</span>
                        <span><strong id="losSats">0</strong>/15</span>
                    </div>
                    <div class="signal-bar-bg">
                        <div class="signal-bar-fill" id="losBar" style="background: #00f0ff; width: 0%;"></div>
                    </div>
                </div>

                <div class="signal-bar-container">
                    <div class="signal-bar-header">
                        <span>Multipath (Good)</span>
                        <span><strong id="multipathSats">0</strong>/15</span>
                    </div>
                    <div class="signal-bar-bg">
                        <div class="signal-bar-fill" id="multipathBar" style="background: #ffa500; width: 0%;"></div>
                    </div>
                </div>

                <div class="signal-bar-container">
                    <div class="signal-bar-header">
                        <span>NLOS (Poor)</span>
                        <span><strong id="nlosSats">0</strong>/15</span>
                    </div>
                    <div class="signal-bar-bg">
                        <div class="signal-bar-fill" id="nlosBar" style="background: #ff4d4d; width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Map -->
    <div id="tab-map" class="tab-content">
        <div class="detail-card">
            <h3 style="color: #00f0ff;">üó∫Ô∏è Interactive Map</h3>
            <div style="position: relative;">
                <div id="map"></div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn" onclick="centerMapOnCurrent()">üìç Center on Position</button>
                <button class="btn btn-secondary" onclick="toggleMapLayer()">üó∫Ô∏è Change Layer</button>
            </div>
        </div>
    </div>

    <!-- Tab: Points -->
    <div id="tab-points" class="tab-content">
        <div class="detail-grid">
            <div class="detail-card" style="border-color: rgba(76, 175, 80, 0.3);">
                <h3 style="color: #4caf50;">üìç Save New Point</h3>
                
                <div class="input-group">
                    <label>Point Name *</label>
                    <input type="text" id="pointName" placeholder="e.g., BM-001, Corner A">
                </div>

                <div class="input-group">
                    <label>Code</label>
                    <select id="pointCode">
                        <option value="">Select code...</option>
                        <option value="BM">BM - Benchmark</option>
                        <option value="CORNER">CORNER - Property Corner</option>
                        <option value="TREE">TREE - Tree</option>
                        <option value="POLE">POLE - Utility Pole</option>
                        <option value="WELL">WELL - Well</option>
                        <option value="BUILDING">BUILDING - Building</option>
                        <option value="FENCE">FENCE - Fence Post</option>
                        <option value="CUSTOM">CUSTOM - Other</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <textarea id="pointDesc" rows="3" placeholder="Optional notes..."></textarea>
                </div>

                <div style="background: rgba(0,240,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Current Position:</strong><br>
                    <span id="currentPosPreview" style="font-family: monospace; font-size: 0.9em;">
                        Waiting for fix...
                    </span>
                </div>

                <button class="btn" onclick="savePoint()">üíæ Save Point</button>
            </div>

            <div class="detail-card">
                <h3>üìã Saved Points (<span id="pointCount">0</span>)</h3>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <input type="text" id="searchPoints" placeholder="üîç Search points..." 
                           style="flex: 1; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); color: white;">
                    <button class="quick-btn" onclick="exportPoints()">üì• CSV</button>
                </div>
                <div class="points-table" id="pointsList">
                    <p style="opacity: 0.5; text-align: center;">No points saved yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Stakeout -->
    <div id="tab-stakeout" class="tab-content">
        <div class="detail-grid">
            <div class="detail-card" style="border-color: rgba(255, 193, 7, 0.3);">
                <h3 style="color: #ffc107;">üìè Stakeout / Replanteo</h3>
                
                <div class="input-group">
                    <label>Target Point</label>
                    <select id="targetPoint" onchange="startStakeout()">
                        <option value="">Select a saved point...</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Or Enter Coordinates Manually:</label>
                    <input type="number" id="targetLat" placeholder="Latitude" step="0.0000001">
                    <input type="number" id="targetLon" placeholder="Longitude" step="0.0000001" style="margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="startManualStakeout()" style="margin-top: 10px;">üéØ Start Navigation</button>
                </div>

                <button class="btn" onclick="loadStakeoutFile()">üìÇ Load Points from CSV</button>
            </div>

            <div class="detail-card">
                <h3 style="color: #ffc107;">üß≠ Navigation</h3>
                <div class="stakeout-navigation" id="stakeoutNav" style="display:none;">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">
                        Target: <strong id="targetName">-</strong>
                    </div>
                    <div class="distance-display" id="distanceDisplay">0.00 m</div>
                    <div class="direction-arrow" id="directionArrow">‚¨ÜÔ∏è</div>
                    <div style="font-size: 1.5em; margin-top: 10px;">
                        <strong id="bearingDisplay">0¬∞</strong>
                    </div>
                    <div style="margin-top: 20px;">
                        <span style="color: #4caf50;">‚úì Within tolerance</span> when distance < 0.05m
                    </div>
                </div>
                <div id="noStakeout" style="text-align: center; opacity: 0.5; padding: 50px;">
                    Select a target point to start navigation
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Charts -->
    <div id="tab-charts" class="tab-content">
        <div class="chart-container">
            <h3 style="color: #00f0ff; margin-bottom: 15px;">üìà HDOP History (Lower is Better)</h3>
            <div class="chart-wrapper">
                <canvas id="hdopChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="color: #4caf50; margin-bottom: 15px;">üõ∞Ô∏è Satellite Count History</h3>
            <div class="chart-wrapper">
                <canvas id="satChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="color: #9c27b0; margin-bottom: 15px;">üß† ML Signal Quality Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="mlChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tab: Sky Plot -->
    <div id="tab-skyplot" class="tab-content">
        <div class="skyplot-container">
            <h3 style="color: #00f0ff; margin-bottom: 20px;">üõ∞Ô∏è Satellite Sky View</h3>
            <canvas id="skyplotCanvas" class="skyplot-canvas"></canvas>
            <div style="margin-top: 20px; opacity: 0.8;">
                <strong>Legend:</strong> 
                <span style="color: #00f0ff;">‚óè LOS</span> | 
                <span style="color: #ffa500;">‚óè Multipath</span> | 
                <span style="color: #ff4d4d;">‚óè NLOS</span>
            </div>
        </div>
    </div>

    <!-- Tab: Photos -->
    <div id="tab-photos" class="tab-content">
        <div class="detail-card">
            <h3 style="color: #00f0ff;">üì∏ Geotagged Photos</h3>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="capturePhoto()">üì∑ Take Photo</button>
                <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none;" onchange="handlePhotoUpload(event)">
            </div>
            
            <div class="photo-grid" id="photoGallery">
                <p style="opacity: 0.5; text-align: center; grid-column: 1/-1;">No photos yet</p>
            </div>
        </div>
    </div>

    <!-- Tab: Tools -->
    <div id="tab-tools" class="tab-content">
        <div class="detail-grid">
            <div class="detail-card">
                <h3 style="color: #00f0ff;">üßÆ Field Calculator</h3>
                
                <div class="input-group">
                    <label>Calculation Type</label>
                    <select id="calcType" onchange="updateCalculator()">
                        <option value="distance">Distance Between Points</option>
                        <option value="area">Polygon Area</option>
                        <option value="inverse">Inverse (Azimuth & Distance)</option>
                        <option value="coords">Coordinate Conversion</option>
                    </select>
                </div>

                <div id="calcInputs"></div>
                
                <button class="btn" onclick="performCalculation()">üî¢ Calculate</button>
                
                <div id="calcResult" style="margin-top: 20px; padding: 20px; background: rgba(0,240,255,0.1); border-radius: 10px; display: none;">
                    <h4>Result:</h4>
                    <div id="calcOutput" style="font-size: 1.2em; margin-top: 10px;"></div>
                </div>
            </div>

            <div class="detail-card">
                <h3 style="color: #4caf50;">‚òÅÔ∏è Google Drive Sync</h3>
                
                <div id="driveNotConnected" style="display: block;">
                    <p style="opacity: 0.8; margin-bottom: 15px;">
                        Connect your Google account to backup points automatically
                    </p>
                    
                    <div class="input-group">
                        <label>Your Email</label>
                        <input type="email" id="userEmail" placeholder="your.email@gmail.com">
                    </div>
                    
                    <button class="btn" onclick="authenticateGoogleDrive()">
                        üîê Connect Google Drive
                    </button>
                </div>

                <div id="driveConnected" style="display: none;">
                    <div style="padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; margin-bottom: 15px;">
                        <p><strong>‚úÖ Connected as:</strong> <span id="connectedEmail"></span></p>
                        <p style="margin-top: 5px;"><strong>Last Sync:</strong> <span id="lastSync">Never</span></p>
                        <p style="margin-top: 5px;"><strong>Files Synced:</strong> <span id="filesSynced">0</span></p>
                    </div>
                    
                    <button class="btn" onclick="manualSync()">üîÑ Sync Now</button>
                    <button class="btn btn-danger" onclick="disconnectDrive()">üîå Disconnect</button>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="authenticateDropbox()">
                        üì¶ Or Connect Dropbox
                    </button>
                </div>
            </div>
        </div>

        <div class="detail-card">
            <h3 style="color: #ff9800;">‚öôÔ∏è Settings & Export</h3>
            
            <div class="input-group">
                <label>Export Format</label>
                <select id="exportFormat">
                    <option value="csv">CSV (Excel Compatible)</option>
                    <option value="kml">KML (Google Earth)</option>
                    <option value="gpx">GPX (GPS Exchange)</option>
                    <option value="geojson">GeoJSON (QGIS)</option>
                    <option value="dxf">DXF (AutoCAD)</option>
                </select>
            </div>

            <button class="btn" onclick="exportInFormat()">üì• Export All Data</button>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Project Settings</h2>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>Project Name</label>
                <input type="text" id="projectNameInput" placeholder="e.g., Highway Survey 2024">
            </div>
            <div class="input-group">
                <label>Description (optional)</label>
                <textarea id="projectDesc" rows="3" placeholder="Brief description of your project..."></textarea>
            </div>
            <button class="btn" onclick="saveProjectName()">üíæ Save Project Info</button>
        </div>
    </div>

    <div id="zoneModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üåç Select UTM Zone</h2>
                <button class="modal-close" onclick="closeModal('zoneModal')">&times;</button>
            </div>
            <div class="input-group">
                <label>UTM Zone Number (1-60)</label>
                <input type="number" id="zoneNumber" min="1" max="60" value="17" placeholder="17">
            </div>
            <div class="input-group">
                <label>Hemisphere</label>
                <select id="zoneHemisphere">
                    <option value="N">Northern (N)</option>
                    <option value="S" selected>Southern (S)</option>
                </select>
            </div>
            <div style="background: rgba(255,193,7,0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>‚ÑπÔ∏è Info:</strong> Peru is typically in zones 17-19 South
            </div>
            <button class="btn" onclick="saveUTMZone()">‚úÖ Apply Zone</button>
        </div>
    </div>

    <div id="photoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Photo Details</h2>
                <button class="modal-close" onclick="closeModal('photoModal')">&times;</button>
            </div>
            <div id="photoModalContent"></div>
        </div>
    </div>

    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßÆ Field Calculator</h2>
                <button class="modal-close" onclick="closeModal('calculatorModal')">&times;</button>
            </div>
            <div id="calculatorContent"></div>
        </div>
    </div>

    <!-- File input hidden -->
    <input type="file" id="stakeoutFileInput" accept=".csv" style="display:none;" onchange="handleStakeoutFile(event)">

    <script>
        // ============================================
        // GLOBAL STATE & INITIALIZATION
        // ============================================
        let socket = io('/ws');
        let savedPoints = JSON.parse(localStorage.getItem('gnssai_points') || '[]');
        let savedPhotos = JSON.parse(localStorage.getItem('gnssai_photos') || '[]');
        let currentPosition = { lat: 0, lon: 0, alt: 0 };
        let lastRtkStatus = 'NO_FIX';
        let isOffline = false;
        
        // Charts
        let chartHdop, chartSat, chartML;
        let hdopData = [], satData = [], mlData = { los: [], multipath: [], nlos: [] };
        
        // Map
        let map, currentMarker, pointMarkers = [], targetMarker;
        let mapLayer = 'osm';
        
        // Stakeout
        let stakeoutActive = false;
        let targetCoords = null;
        
        // RTK Colors
        const rtkColors = {
            'NO_FIX': '#f44336',
            'GPS': '#ff9800',
            'DGPS': '#ffeb3b',
            'RTK_FLOAT': '#8bc34a',
            'RTK_FIXED': '#00bcd4'
        };

        // Point colors by code
        const pointColors = {
            'BM': '#4caf50',
            'CORNER': '#ff9800',
            'TREE': '#8bc34a',
            'POLE': '#9c27b0',
            'WELL': '#00bcd4',
            'BUILDING': '#f44336',
            'FENCE': '#ffc107',
            'CUSTOM': '#757575'
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            initMap();
            loadSavedPoints();
            loadSavedPhotos();
            updateCalculator();
            checkOfflineMode();
            checkDriveConnection();
            loadProjectInfo();
            applyTheme(currentTheme);
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
            
            // Check connectivity
            setInterval(checkConnectivity, 5000);
            
            // Update stakeout if active
            setInterval(updateStakeout, 1000);
        });

        // ============================================
        // SOCKET HANDLERS
        // ============================================
        socket.on('connect', () => {
            isOffline = false;
            document.getElementById('statusDot').classList.add('connected');
            document.getElementById('statusDot').classList.remove('offline');
            document.getElementById('connectionText').textContent = 'Connected ‚úÖ';
            document.getElementById('offlineIndicator').style.display = 'none';
            showToast('Connected to server', 'success');
        });

        socket.on('disconnect', () => {
            document.getElementById('statusDot').classList.remove('connected');
            document.getElementById('connectionText').textContent = 'Disconnected ‚ùå';
            showToast('Connection lost - Working offline', 'warning');
        });

        socket.on('stats', (data) => {
            updateDashboard(data);
        });

        socket.on('uptime', (data) => {
            const mins = Math.floor(data.ts / 60);
            const secs = data.ts % 60;
            document.getElementById('uptime').textContent = `${mins}m ${secs}s`;
        });

        // ============================================
        // DASHBOARD UPDATE
        // ============================================
        function updateDashboard(data) {
            // Update current position
            currentPosition = data.position || { lat: 0, lon: 0, alt: 0 };

            // RTK Status
            const rtkStatus = data.rtk_status || 'NO_FIX';
            const color = rtkColors[rtkStatus];
            const banner = document.getElementById('rtkBanner');
            
            banner.style.background = `linear-gradient(135deg, ${color}30, ${color}10)`;
            banner.style.borderColor = color;
            document.getElementById('rtkStatus').textContent = rtkStatus.replace('_', ' ');
            document.getElementById('rtkStatus').style.color = color;

            // Alert if RTK lost
            if (lastRtkStatus.includes('RTK') && !rtkStatus.includes('RTK')) {
                document.getElementById('alertBadge').style.display = 'block';
                playAlert();
                showToast('‚ö†Ô∏è RTK signal lost!', 'warning');
                setTimeout(() => {
                    document.getElementById('alertBadge').style.display = 'none';
                }, 5000);
            }
            lastRtkStatus = rtkStatus;

            // Quality indicators
            document.getElementById('quality').textContent = data.quality || 0;
            document.getElementById('hdop').textContent = (data.hdop || 0).toFixed(2);
            document.getElementById('satCount').textContent = data.satellites || 0;

            // Main stats
            document.getElementById('totalSats').textContent = data.satellites || 0;
            document.getElementById('nmeaCount').textContent = data.nmea_sent || 0;
            document.getElementById('mlCorrections').textContent = data.ml_corrections || 0;
            
            const confidence = data.avg_confidence || 0;
            document.getElementById('mlConfidence').textContent = `Confidence: ${confidence.toFixed(1)}%`;

            // Accuracy
            const accuracy = data.estimated_accuracy ? 
                (data.estimated_accuracy < 10 ? `${data.estimated_accuracy.toFixed(1)}cm` : 
                 data.estimated_accuracy < 100 ? `${data.estimated_accuracy.toFixed(0)}cm` : 
                 `${(data.estimated_accuracy/100).toFixed(1)}m`) : 'N/A';
            document.getElementById('accuracy').textContent = accuracy;

            // Position - Update both decimal and UTM with animation
            const latEl = document.getElementById('latitude');
            const lonEl = document.getElementById('longitude');
            const altEl = document.getElementById('altitude');
            
            if (latEl.textContent !== `${currentPosition.lat.toFixed(7)}¬∞`) {
                latEl.classList.add('value-changed');
                setTimeout(() => latEl.classList.remove('value-changed'), 500);
            }
            
            latEl.textContent = `${currentPosition.lat.toFixed(7)}¬∞`;
            lonEl.textContent = `${currentPosition.lon.toFixed(7)}¬∞`;
            altEl.textContent = `${currentPosition.alt.toFixed(2)} m`;

            // Convert to UTM
            const utm = convertToUTM(currentPosition.lat, currentPosition.lon);
            document.getElementById('utmZone').textContent = utm.zone;
            document.getElementById('utmEasting').textContent = `${utm.easting.toFixed(2)} m`;
            document.getElementById('utmNorthing').textContent = `${utm.northing.toFixed(2)} m`;
            
            // Play sound when reaching RTK Fixed
            if (rtkStatus === 'RTK_FIXED' && lastRtkStatus !== 'RTK_FIXED' && !rtkFixedSoundPlayed) {
                playSuccessSound();
                rtkFixedSoundPlayed = true;
                showToast('üéØ RTK Fixed achieved!', 'success');
            }
            
            if (rtkStatus !== 'RTK_FIXED') {
                rtkFixedSoundPlayed = false;
            }

            // Update point preview
            document.getElementById('currentPosPreview').innerHTML = 
                `Lat: ${currentPosition.lat.toFixed(7)}¬∞<br>` +
                `Lon: ${currentPosition.lon.toFixed(7)}¬∞<br>` +
                `Alt: ${currentPosition.alt.toFixed(2)} m<br>` +
                `Quality: ${rtkStatus} | HDOP: ${(data.hdop || 0).toFixed(2)}`;

            // Signal Quality
            const losSats = data.los_sats || 0;
            const multipathSats = data.multipath_sats || 0;
            const nlosSats = data.nlos_sats || 0;

            document.getElementById('losSats').textContent = losSats;
            document.getElementById('multipathSats').textContent = multipathSats;
            document.getElementById('nlosSats').textContent = nlosSats;

            document.getElementById('losBar').style.width = `${(losSats / 15) * 100}%`;
            document.getElementById('multipathBar').style.width = `${(multipathSats / 15) * 100}%`;
            document.getElementById('nlosBar').style.width = `${(nlosSats / 15) * 100}%`;

            // Update charts
            updateCharts(data);

            // Update map
            updateMapPosition(currentPosition.lat, currentPosition.lon);

            // Update sky plot
            drawSkyPlot(data);
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            // Special actions for certain tabs
            if (tabName === 'map' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            if (tabName === 'stakeout') {
                updateStakeoutTargetList();
            }
        }

        // ============================================
        // POINT MANAGEMENT
        // ============================================
        function savePoint() {
            const name = document.getElementById('pointName').value.trim();
            if (!name) {
                showToast('Please enter a point name', 'error');
                return;
            }

            if (currentPosition.lat === 0 && currentPosition.lon === 0) {
                showToast('Waiting for valid GPS fix', 'warning');
                return;
            }

            const point = {
                id: Date.now(),
                name: name,
                code: document.getElementById('pointCode').value || 'CUSTOM',
                description: document.getElementById('pointDesc').value.trim(),
                lat: currentPosition.lat,
                lon: currentPosition.lon,
                alt: currentPosition.alt,
                quality: document.getElementById('quality').textContent,
                hdop: document.getElementById('hdop').textContent,
                rtk_status: document.getElementById('rtkStatus').textContent,
                timestamp: new Date().toISOString()
            };

            savedPoints.push(point);
            localStorage.setItem('gnssai_points', JSON.stringify(savedPoints));

            document.getElementById('pointName').value = '';
            document.getElementById('pointDesc').value = '';
            document.getElementById('pointCode').value = '';

            loadSavedPoints();
            addPointToMap(point);
            showToast(`Point "${name}" saved successfully!`, 'success');
        }

        function quickSavePoint() {
            const name = `PT-${savedPoints.length + 1}`;
            if (currentPosition.lat === 0) {
                showToast('No GPS fix available', 'error');
                return;
            }

            const point = {
                id: Date.now(),
                name: name,
                code: 'CUSTOM',
                description: 'Quick save',
                lat: currentPosition.lat,
                lon: currentPosition.lon,
                alt: currentPosition.alt,
                quality: document.getElementById('quality').textContent,
                hdop: document.getElementById('hdop').textContent,
                rtk_status: document.getElementById('rtkStatus').textContent,
                timestamp: new Date().toISOString()
            };

            savedPoints.push(point);
            localStorage.setItem('gnssai_points', JSON.stringify(savedPoints));
            loadSavedPoints();
            addPointToMap(point);
            showToast(`Quick point saved as "${name}"`, 'success');
        }

        function loadSavedPoints() {
            const container = document.getElementById('pointsList');
            document.getElementById('pointCount').textContent = savedPoints.length;

            if (savedPoints.length === 0) {
                container.innerHTML = '<p style="opacity: 0.5; text-align: center;">No points saved yet</p>';
                return;
            }

            container.innerHTML = savedPoints.map(point => `
                <div class="point-item" style="border-color: ${pointColors[point.code] || '#757575'};">
                    <div class="point-header">
                        <div>
                            <div class="point-name">${point.name}</div>
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">
                                ${new Date(point.timestamp).toLocaleString()} | ${point.code}
                            </div>
                        </div>
                        <button class="point-delete" onclick="deletePoint(${point.id})">üóëÔ∏è</button>
                    </div>
                    ${point.description ? `<div style="margin: 10px 0; opacity: 0.8;">${point.description}</div>` : ''}
                    <div class="point-coords">
                        Lat: ${point.lat.toFixed(7)}¬∞<br>
                        Lon: ${point.lon.toFixed(7)}¬∞<br>
                        Alt: ${point.alt.toFixed(2)} m
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; opacity: 0.7;">
                        ${point.rtk_status} | HDOP: ${point.hdop}
                    </div>
                    <button class="btn btn-secondary" onclick="showPointOnMap(${point.id})" style="margin-top: 10px;">
                        üó∫Ô∏è Show on Map
                    </button>
                </div>
            `).join('');
        }

        function deletePoint(id) {
            if (confirm('Delete this point?')) {
                savedPoints = savedPoints.filter(p => p.id !== id);
                localStorage.setItem('gnssai_points', JSON.stringify(savedPoints));
                loadSavedPoints();
                updateMapMarkers();
                showToast('Point deleted', 'info');
            }
        }

        function exportPoints() {
            exportInFormat();
        }

        // ============================================
        // COORDINATE CONVERSION - UTM WGS84
        // ============================================
        function setCoordType(type) {
            coordType = type;
            
            if (type === 'dd') {
                document.getElementById('coordsDecimal').style.display = 'block';
                document.getElementById('coordsUTM').style.display = 'none';
                document.getElementById('coordTypeDD').style.background = 'rgba(0,240,255,0.3)';
                document.getElementById('coordTypeDD').style.borderColor = '#00f0ff';
                document.getElementById('coordTypeUTM').style.background = 'rgba(255,255,255,0.1)';
                document.getElementById('coordTypeUTM').style.borderColor = 'rgba(255,255,255,0.3)';
            } else {
                document.getElementById('coordsDecimal').style.display = 'none';
                document.getElementById('coordsUTM').style.display = 'block';
                document.getElementById('coordTypeDD').style.background = 'rgba(255,255,255,0.1)';
                document.getElementById('coordTypeDD').style.borderColor = 'rgba(255,255,255,0.3)';
                document.getElementById('coordTypeUTM').style.background = 'rgba(0,240,255,0.3)';
                document.getElementById('coordTypeUTM').style.borderColor = '#00f0ff';
            }
            
            showToast(`Switched to ${type === 'dd' ? 'Decimal' : 'UTM WGS84'}`, 'info');
        }

        function convertToUTM(lat, lon) {
            if (lat === 0 && lon === 0) {
                return { zone: '--', easting: 0, northing: 0, hemisphere: 'N' };
            }

            // UTM WGS84 conversion - With manual zone override
            const a = 6378137.0;
            const f = 1 / 298.257223563;
            const k0 = 0.9996;
            
            // Determine UTM zone (or use manual override)
            let zone = manualUTMZone || Math.floor((lon + 180) / 6) + 1;
            
            // Special zones (if not manual)
            if (!manualUTMZone) {
                if (lat >= 56.0 && lat < 64.0 && lon >= 3.0 && lon < 12.0) zone = 32;
                if (lat >= 72.0 && lat < 84.0) {
                    if (lon >= 0.0 && lon < 9.0) zone = 31;
                    else if (lon >= 9.0 && lon < 21.0) zone = 33;
                    else if (lon >= 21.0 && lon < 33.0) zone = 35;
                    else if (lon >= 33.0 && lon < 42.0) zone = 37;
                }
            }
            
            // Central meridian
            const lonOrigin = (zone - 1) * 6 - 180 + 3;
            
            // Convert to radians
            const latRad = lat * Math.PI / 180;
            const lonRad = lon * Math.PI / 180;
            const lonOriginRad = lonOrigin * Math.PI / 180;
            
            // Ellipsoid parameters
            const eccSquared = 2 * f - f * f;
            const eccPrimeSquared = eccSquared / (1 - eccSquared);
            
            const N = a / Math.sqrt(1 - eccSquared * Math.sin(latRad) * Math.sin(latRad));
            const T = Math.tan(latRad) * Math.tan(latRad);
            const C = eccPrimeSquared * Math.cos(latRad) * Math.cos(latRad);
            const A = Math.cos(latRad) * (lonRad - lonOriginRad);
            
            // Calculate M (meridional arc)
            const M = a * ((1 - eccSquared/4 - 3*eccSquared*eccSquared/64 - 5*eccSquared*eccSquared*eccSquared/256) * latRad
                    - (3*eccSquared/8 + 3*eccSquared*eccSquared/32 + 45*eccSquared*eccSquared*eccSquared/1024) * Math.sin(2*latRad)
                    + (15*eccSquared*eccSquared/256 + 45*eccSquared*eccSquared*eccSquared/1024) * Math.sin(4*latRad)
                    - (35*eccSquared*eccSquared*eccSquared/3072) * Math.sin(6*latRad));
            
            // Calculate UTM Easting
            const easting = k0 * N * (A + (1 - T + C) * A * A * A / 6
                    + (5 - 18 * T + T * T + 72 * C - 58 * eccPrimeSquared) * A * A * A * A * A / 120)
                    + 500000.0;
            
            // Calculate UTM Northing
            let northing = k0 * (M + N * Math.tan(latRad) * (A * A / 2
                    + (5 - T + 9 * C + 4 * C * C) * A * A * A * A / 24
                    + (61 - 58 * T + T * T + 600 * C - 330 * eccPrimeSquared) * A * A * A * A * A * A / 720));
            
            // Add false northing for southern hemisphere
            const actualHemisphere = manualUTMHemisphere || (lat >= 0 ? 'N' : 'S');
            if (actualHemisphere === 'S') {
                northing += 10000000.0;
            }
            
            // Get zone letter
            const zoneLetter = getUTMZoneLetter(lat);
            
            return {
                zone: manualUTMZone ? `${zone}${manualUTMHemisphere || zoneLetter}` : `${zone}${zoneLetter}`,
                easting: easting,
                northing: northing,
                hemisphere: actualHemisphere
            };
        }

        function getUTMZoneLetter(lat) {
            if (lat >= -80 && lat <= 84) {
                const letters = 'CDEFGHJKLMNPQRSTUVWXX';
                return letters[Math.floor((lat + 80) / 8)];
            }
            return 'Z';
        }

        // ============================================
        // THEME FUNCTIONS
        // ============================================
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('darkBtn').classList.remove('active');
                document.getElementById('lightBtn').classList.add('active');
            } else {
                document.body.classList.remove('light-mode');
                document.getElementById('darkBtn').classList.add('active');
                document.getElementById('lightBtn').classList.remove('active');
            }
        }

        // ============================================
        // PROJECT NAME FUNCTIONS
        // ============================================
        function loadProjectInfo() {
            document.getElementById('projectName').textContent = `üìã ${projectName}`;
            const startDate = new Date(projectStartDate);
            document.getElementById('projectDate').textContent = `Started: ${startDate.toLocaleDateString()}`;
        }

        function editProjectName() {
            document.getElementById('projectNameInput').value = projectName;
            document.getElementById('projectModal').classList.add('active');
        }

        function saveProjectName() {
            const name = document.getElementById('projectNameInput').value.trim();
            if (!name) {
                showToast('Please enter a project name', 'error');
                return;
            }
            
            projectName = name;
            localStorage.setItem('project_name', projectName);
            
            const desc = document.getElementById('projectDesc').value.trim();
            if (desc) {
                localStorage.setItem('project_desc', desc);
            }
            
            loadProjectInfo();
            closeModal('projectModal');
            showToast('Project info saved', 'success');
        }

        // ============================================
        // UTM ZONE SELECTOR
        // ============================================
        function showZoneSelector() {
            if (manualUTMZone) {
                document.getElementById('zoneNumber').value = manualUTMZone;
                document.getElementById('zoneHemisphere').value = manualUTMHemisphere || 'S';
            }
            document.getElementById('zoneModal').classList.add('active');
        }

        function saveUTMZone() {
            const zone = parseInt(document.getElementById('zoneNumber').value);
            const hemisphere = document.getElementById('zoneHemisphere').value;
            
            if (zone < 1 || zone > 60) {
                showToast('Zone must be between 1 and 60', 'error');
                return;
            }
            
            manualUTMZone = zone;
            manualUTMHemisphere = hemisphere;
            localStorage.setItem('manual_utm_zone', zone);
            localStorage.setItem('manual_utm_hemisphere', hemisphere);
            
            closeModal('zoneModal');
            showToast(`UTM Zone set to ${zone}${hemisphere}`, 'success');
            
            // Refresh display
            if (currentPosition.lat !== 0) {
                const utm = convertToUTM(currentPosition.lat, currentPosition.lon);
                document.getElementById('utmZone').textContent = utm.zone;
                document.getElementById('utmEasting').textContent = `${utm.easting.toFixed(2)} m`;
                document.getElementById('utmNorthing').textContent = `${utm.northing.toFixed(2)} m`;
            }
        }

        // ============================================
        // SOUND FUNCTIONS
        // ============================================
        function playSuccessSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Success melody: 3 ascending notes
            const notes = [523.25, 659.25, 783.99]; // C, E, G
            
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 150);
            });
        }

        // ============================================
        // COPY COORDINATES (WITH UTM SUPPORT)
        // ============================================
        function copyCoordinates() {
            let text;
            if (coordType === 'utm') {
                const utm = convertToUTM(currentPosition.lat, currentPosition.lon);
                text = `Zone: ${utm.zone}, E: ${utm.easting.toFixed(2)}m, N: ${utm.northing.toFixed(2)}m, Alt: ${currentPosition.alt.toFixed(2)}m`;
            } else {
                text = `${currentPosition.lat.toFixed(7)}, ${currentPosition.lon.toFixed(7)}, ${currentPosition.alt.toFixed(2)}`;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Coordinates copied (${coordType.toUpperCase()})`, 'success');
            });
        }

        // ============================================
        // GOOGLE DRIVE SYNC
        // ============================================
        function checkDriveConnection() {
            if (driveAccessToken && userEmail) {
                document.getElementById('driveNotConnected').style.display = 'none';
                document.getElementById('driveConnected').style.display = 'block';
                document.getElementById('connectedEmail').textContent = userEmail;
                
                const lastSyncTime = localStorage.getItem('last_sync_time');
                if (lastSyncTime) {
                    document.getElementById('lastSync').textContent = new Date(parseInt(lastSyncTime)).toLocaleString();
                }
                
                const syncedFiles = localStorage.getItem('synced_files_count') || '0';
                document.getElementById('filesSynced').textContent = syncedFiles;
            }
        }

        function authenticateGoogleDrive() {
            const email = document.getElementById('userEmail').value.trim();
            
            if (!email) {
                showToast('Please enter your email address', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showToast('Please enter a valid email', 'error');
                return;
            }
            
            // Google OAuth2 configuration
            const clientId = '764686051470-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com'; // Public client ID for demo
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'https://www.googleapis.com/auth/drive.file';
            
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=token&` +
                `scope=${encodeURIComponent(scope)}&` +
                `login_hint=${encodeURIComponent(email)}`;
            
            // Save email for later
            localStorage.setItem('user_email', email);
            
            // Open OAuth window
            const width = 500;
            const height = 600;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            const authWindow = window.open(
                authUrl,
                'Google Drive Authorization',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            // Check for OAuth callback
            const checkAuth = setInterval(() => {
                try {
                    if (authWindow.closed) {
                        clearInterval(checkAuth);
                        // Check if we have a token in URL hash
                        const hash = window.location.hash;
                        if (hash.includes('access_token')) {
                            const token = hash.match(/access_token=([^&]*)/);
                            if (token) {
                                driveAccessToken = token[1];
                                localStorage.setItem('drive_access_token', driveAccessToken);
                                userEmail = email;
                                checkDriveConnection();
                                showToast('‚úÖ Connected to Google Drive!', 'success');
                                
                                // Auto-sync
                                setTimeout(manualSync, 1000);
                            }
                        }
                    }
                } catch (e) {
                    // Cross-origin error - ignore
                }
            }, 500);
        }

        async function manualSync() {
            if (!driveAccessToken) {
                showToast('Please connect to Google Drive first', 'warning');
                return;
            }
            
            showToast('üîÑ Syncing to Google Drive...', 'info');
            
            try {
                // Prepare data to sync
                const syncData = {
                    points: savedPoints,
                    photos: savedPhotos.map(p => ({...p, data: 'base64_too_large'})), // Don't sync full images
                    timestamp: new Date().toISOString(),
                    version: '3.0'
                };
                
                const jsonData = JSON.stringify(syncData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                
                // Upload to Google Drive
                const metadata = {
                    name: `gnssai_backup_${new Date().toISOString().split('T')[0]}.json`,
                    mimeType: 'application/json',
                    parents: ['appDataFolder'] // Use app data folder
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${driveAccessToken}`
                    },
                    body: form
                });
                
                if (response.ok) {
                    const result = await response.json();
                    localStorage.setItem('last_sync_time', Date.now().toString());
                    localStorage.setItem('synced_files_count', (savedPoints.length + savedPhotos.length).toString());
                    
                    document.getElementById('lastSync').textContent = new Date().toLocaleString();
                    document.getElementById('filesSynced').textContent = (savedPoints.length + savedPhotos.length).toString();
                    
                    showToast('‚úÖ Synced to Google Drive successfully!', 'success');
                } else {
                    throw new Error('Sync failed');
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                showToast('‚ùå Sync failed - Try reconnecting', 'error');
                
                // Clear token if unauthorized
                if (error.message.includes('401')) {
                    localStorage.removeItem('drive_access_token');
                    driveAccessToken = null;
                    checkDriveConnection();
                }
            }
        }

        function disconnectDrive() {
            if (confirm('Disconnect from Google Drive?')) {
                localStorage.removeItem('drive_access_token');
                localStorage.removeItem('user_email');
                driveAccessToken = null;
                userEmail = null;
                
                document.getElementById('driveNotConnected').style.display = 'block';
                document.getElementById('driveConnected').style.display = 'none';
                document.getElementById('userEmail').value = '';
                
                showToast('Disconnected from Google Drive', 'info');
            }
        }

        function authenticateDropbox() {
            showToast('Dropbox sync - Coming soon!', 'info');
        }

        // ============================================
        // CHARTS
        // ============================================
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: { 
                        ticks: { color: '#ffffff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };

            chartHdop = new Chart(document.getElementById('hdopChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'HDOP',
                        data: [],
                        borderColor: '#00f0ff',
                        backgroundColor: 'rgba(0,240,255,0.1)',
                        tension: 0.4
                    }]
                },
                options: commonOptions
            });

            chartSat = new Chart(document.getElementById('satChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Satellites',
                        data: [],
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76,175,80,0.1)',
                        tension: 0.4
                    }]
                },
                options: commonOptions
            });

            chartML = new Chart(document.getElementById('mlChart'), {
                type: 'bar',
                data: {
                    labels: ['LOS', 'Multipath', 'NLOS'],
                    datasets: [{
                        label: 'Satellites',
                        data: [0, 0, 0],
                        backgroundColor: ['#00f0ff', '#ffa500', '#ff4d4d']
                    }]
                },
                options: commonOptions
            });
        }

        function updateCharts(data) {
            const now = new Date().toLocaleTimeString();

            if (hdopData.length > 20) {
                hdopData.shift();
                satData.shift();
                chartHdop.data.labels.shift();
                chartSat.data.labels.shift();
            }

            hdopData.push(data.hdop || 0);
            satData.push(data.satellites || 0);

            chartHdop.data.labels.push(now);
            chartHdop.data.datasets[0].data = hdopData;
            chartHdop.update('none');

            chartSat.data.labels.push(now);
            chartSat.data.datasets[0].data = satData;
            chartSat.update('none');

            // ML Chart
            chartML.data.datasets[0].data = [
                data.los_sats || 0,
                data.multipath_sats || 0,
                data.nlos_sats || 0
            ];
            chartML.update('none');
        }

        // ============================================
        // MAP FUNCTIONS
        // ============================================
        function initMap() {
            map = L.map('map').setView([-6.7, -79.9], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            currentMarker = L.marker([-6.7, -79.9], {
                icon: L.divIcon({
                    className: 'current-marker',
                    html: '<div style="background: #00f0ff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white;"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(map);

            // Add saved points to map
            savedPoints.forEach(addPointToMap);
        }

        function updateMapPosition(lat, lon) {
            if (!map || lat === 0) return;
            currentMarker.setLatLng([lat, lon]);
        }

        function centerMapOnCurrent() {
            if (currentPosition.lat !== 0) {
                map.setView([currentPosition.lat, currentPosition.lon], 18);
                showToast('Map centered on current position', 'info');
            }
        }

        function addPointToMap(point) {
            if (!map) return;
            const color = pointColors[point.code] || '#757575';
            const marker = L.marker([point.lat, point.lon], {
                icon: L.divIcon({
                    className: 'point-marker',
                    html: `<div style="background: ${color}; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [15, 15]
                })
            }).addTo(map);
            
            marker.bindPopup(`<strong>${point.name}</strong><br>${point.code}<br>${point.description || ''}`);
            pointMarkers.push(marker);
        }

        function showPointOnMap(id) {
            const point = savedPoints.find(p => p.id === id);
            if (point) {
                switchTab('map');
                setTimeout(() => {
                    map.setView([point.lat, point.lon], 19);
                }, 200);
            }
        }

        function updateMapMarkers() {
            pointMarkers.forEach(m => map.removeLayer(m));
            pointMarkers = [];
            savedPoints.forEach(addPointToMap);
        }

        function toggleMapLayer() {
            // Cycle through different map layers
            showToast('Map layer switching - Feature coming soon', 'info');
        }

        // ============================================
        // STAKEOUT FUNCTIONS
        // ============================================
        function updateStakeoutTargetList() {
            const select = document.getElementById('targetPoint');
            select.innerHTML = '<option value="">Select a saved point...</option>' +
                savedPoints.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
        }

        function startStakeout() {
            const id = parseInt(document.getElementById('targetPoint').value);
            if (!id) return;
            
            const point = savedPoints.find(p => p.id === id);
            if (point) {
                targetCoords = { lat: point.lat, lon: point.lon, name: point.name };
                stakeoutActive = true;
                document.getElementById('stakeoutNav').style.display = 'block';
                document.getElementById('noStakeout').style.display = 'none';
                document.getElementById('targetName').textContent = point.name;
                
                if (map && targetMarker) map.removeLayer(targetMarker);
                targetMarker = L.marker([point.lat, point.lon], {
                    icon: L.divIcon({
                        className: 'target-marker',
                        html: '<div style="background: #ffc107; width: 25px; height: 25px; border-radius: 50%; border: 4px solid white;"></div>',
                        iconSize: [25, 25]
                    })
                }).addTo(map);
                
                showToast(`Navigation started to: ${point.name}`, 'success');
            }
        }

        function startManualStakeout() {
            const lat = parseFloat(document.getElementById('targetLat').value);
            const lon = parseFloat(document.getElementById('targetLon').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                showToast('Please enter valid coordinates', 'error');
                return;
            }
            
            targetCoords = { lat, lon, name: 'Manual Target' };
            stakeoutActive = true;
            document.getElementById('stakeoutNav').style.display = 'block';
            document.getElementById('noStakeout').style.display = 'none';
            document.getElementById('targetName').textContent = 'Manual Target';
            showToast('Navigation started', 'success');
        }

        function updateStakeout() {
            if (!stakeoutActive || !targetCoords || currentPosition.lat === 0) return;
            
            const distance = calculateDistance(
                currentPosition.lat, currentPosition.lon,
                targetCoords.lat, targetCoords.lon
            );
            
            const bearing = calculateBearing(
                currentPosition.lat, currentPosition.lon,
                targetCoords.lat, targetCoords.lon
            );
            
            document.getElementById('distanceDisplay').textContent = 
                distance < 1 ? `${(distance * 100).toFixed(2)} cm` : `${distance.toFixed(2)} m`;
            
            document.getElementById('bearingDisplay').textContent = `${bearing.toFixed(0)}¬∞`;
            document.getElementById('directionArrow').textContent = getArrow(bearing);
            
            // Alert when within tolerance
            if (distance < 0.05) {
                showToast('‚úÖ Target reached!', 'success');
                playAlert();
            }
        }

        function loadStakeoutFile() {
            document.getElementById('stakeoutFileInput').click();
        }

        function handleStakeoutFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                let imported = 0;
                
                lines.slice(1).forEach(line => {
                    const parts = line.split(',');
                    if (parts.length >= 3) {
                        const point = {
                            id: Date.now() + imported,
                            name: parts[0].trim(),
                            code: 'CUSTOM',
                            description: 'Imported from CSV',
                            lat: parseFloat(parts[1]),
                            lon: parseFloat(parts[2]),
                            alt: parts[3] ? parseFloat(parts[3]) : 0,
                            quality: 0,
                            hdop: 0,
                            rtk_status: 'IMPORTED',
                            timestamp: new Date().toISOString()
                        };
                        savedPoints.push(point);
                        imported++;
                    }
                });
                
                localStorage.setItem('gnssai_points', JSON.stringify(savedPoints));
                loadSavedPoints();
                updateMapMarkers();
                showToast(`${imported} points imported successfully`, 'success');
            };
            reader.readAsText(file);
        }

        // ============================================
        // CALCULATION FUNCTIONS
        // ============================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
            const x = Math.cos(œÜ1) * Math.sin(œÜ2) -
                    Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
            const Œ∏ = Math.atan2(y, x);

            return (Œ∏ * 180 / Math.PI + 360) % 360;
        }

        function getArrow(bearing) {
            const arrows = ['‚¨ÜÔ∏è', '‚ÜóÔ∏è', '‚û°Ô∏è', '‚ÜòÔ∏è', '‚¨áÔ∏è', '‚ÜôÔ∏è', '‚¨ÖÔ∏è', '‚ÜñÔ∏è'];
            const index = Math.round(bearing / 45) % 8;
            return arrows[index];
        }

        function updateCalculator() {
            const type = document.getElementById('calcType').value;
            const container = document.getElementById('calcInputs');
            
            switch(type) {
                case 'distance':
                    container.innerHTML = `
                        <div class="input-group">
                            <label>Point 1 (or select saved point)</label>
                            <select id="calc_p1" onchange="fillCalcPoint(1)">
                                <option value="">Manual entry...</option>
                                ${savedPoints.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <input type="number" id="calc_lat1" placeholder="Latitude 1" step="0.0000001">
                            <input type="number" id="calc_lon1" placeholder="Longitude 1" step="0.0000001">
                        </div>
                        <div class="input-group">
                            <label>Point 2</label>
                            <select id="calc_p2" onchange="fillCalcPoint(2)">
                                <option value="">Manual entry...</option>
                                ${savedPoints.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <input type="number" id="calc_lat2" placeholder="Latitude 2" step="0.0000001">
                            <input type="number" id="calc_lon2" placeholder="Longitude 2" step="0.0000001">
                        </div>
                    `;
                    break;
                case 'area':
                    container.innerHTML = `
                        <div class="input-group">
                            <label>Select Points (in order)</label>
                            <div id="areaPoints" style="max-height: 200px; overflow-y: auto;">
                                ${savedPoints.map(p => `
                                    <label style="display: block; padding: 5px;">
                                        <input type="checkbox" value="${p.id}"> ${p.name}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                case 'inverse':
                    container.innerHTML = `
                        <div class="input-group">
                            <label>From Point</label>
                            <input type="number" id="inv_lat1" placeholder="Latitude" step="0.0000001">
                            <input type="number" id="inv_lon1" placeholder="Longitude" step="0.0000001">
                        </div>
                        <div class="input-group">
                            <label>To Point</label>
                            <input type="number" id="inv_lat2" placeholder="Latitude" step="0.0000001">
                            <input type="number" id="inv_lon2" placeholder="Longitude" step="0.0000001">
                        </div>
                    `;
                    break;
                case 'coords':
                    container.innerHTML = `
                        <div class="input-group">
                            <label>Coordinate Format</label>
                            <select id="coord_format">
                                <option value="dd">Decimal Degrees (DD)</option>
                                <option value="dms">Degrees Minutes Seconds (DMS)</option>
                                <option value="utm">UTM</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Input Coordinates</label>
                            <input type="text" id="coord_input" placeholder="e.g., -6.7, -79.9">
                        </div>
                    `;
                    break;
            }
        }

        function fillCalcPoint(num) {
            const selectId = `calc_p${num}`;
            const id = parseInt(document.getElementById(selectId).value);
            if (!id) return;
            
            const point = savedPoints.find(p => p.id === id);
            if (point) {
                document.getElementById(`calc_lat${num}`).value = point.lat;
                document.getElementById(`calc_lon${num}`).value = point.lon;
            }
        }

        function performCalculation() {
            const type = document.getElementById('calcType').value;
            const result = document.getElementById('calcResult');
            const output = document.getElementById('calcOutput');
            
            result.style.display = 'block';
            
            switch(type) {
                case 'distance':
                    const lat1 = parseFloat(document.getElementById('calc_lat1').value);
                    const lon1 = parseFloat(document.getElementById('calc_lon1').value);
                    const lat2 = parseFloat(document.getElementById('calc_lat2').value);
                    const lon2 = parseFloat(document.getElementById('calc_lon2').value);
                    
                    if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
                        output.innerHTML = '‚ùå Invalid coordinates';
                        return;
                    }
                    
                    const dist = calculateDistance(lat1, lon1, lat2, lon2);
                    const bearing = calculateBearing(lat1, lon1, lat2, lon2);
                    
                    output.innerHTML = `
                        <strong>Distance:</strong> ${dist.toFixed(3)} m<br>
                        <strong>Bearing:</strong> ${bearing.toFixed(2)}¬∞<br>
                        <strong>Horizontal:</strong> ${dist.toFixed(3)} m
                    `;
                    break;
                    
                case 'area':
                    const selectedIds = Array.from(document.querySelectorAll('#areaPoints input:checked'))
                        .map(cb => parseInt(cb.value));
                    
                    if (selectedIds.length < 3) {
                        output.innerHTML = '‚ùå Select at least 3 points';
                        return;
                    }
                    
                    const points = selectedIds.map(id => savedPoints.find(p => p.id === id));
                    const area = calculatePolygonArea(points);
                    
                    output.innerHTML = `
                        <strong>Area:</strong> ${area.toFixed(2)} m¬≤<br>
                        <strong>Hectares:</strong> ${(area / 10000).toFixed(4)} ha<br>
                        <strong>Acres:</strong> ${(area / 4046.86).toFixed(4)} ac
                    `;
                    break;
                    
                case 'inverse':
                    const ilat1 = parseFloat(document.getElementById('inv_lat1').value);
                    const ilon1 = parseFloat(document.getElementById('inv_lon1').value);
                    const ilat2 = parseFloat(document.getElementById('inv_lat2').value);
                    const ilon2 = parseFloat(document.getElementById('inv_lon2').value);
                    
                    const idist = calculateDistance(ilat1, ilon1, ilat2, ilon2);
                    const ibearing = calculateBearing(ilat1, ilon1, ilat2, ilon2);
                    const backBearing = (ibearing + 180) % 360;
                    
                    output.innerHTML = `
                        <strong>Forward Azimuth:</strong> ${ibearing.toFixed(4)}¬∞<br>
                        <strong>Back Azimuth:</strong> ${backBearing.toFixed(4)}¬∞<br>
                        <strong>Distance:</strong> ${idist.toFixed(3)} m
                    `;
                    break;
                    
                case 'coords':
                    output.innerHTML = 'Coordinate conversion - Feature coming soon';
                    break;
            }
        }

        function calculatePolygonArea(points) {
            let area = 0;
            const n = points.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                const xi = points[i].lon * Math.PI / 180;
                const yi = points[i].lat * Math.PI / 180;
                const xj = points[j].lon * Math.PI / 180;
                const yj = points[j].lat * Math.PI / 180;
                
                area += xi * yj - xj * yi;
            }
            
            const R = 6371000; // Earth radius in meters
            return Math.abs(area * R * R / 2);
        }

        function showCalculator() {
            switchTab('tools');
        }

        // ============================================
        // PHOTO FUNCTIONS
        // ============================================
        function capturePhoto() {
            document.getElementById('photoInput').click();
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const photo = {
                    id: Date.now(),
                    data: e.target.result,
                    lat: currentPosition.lat,
                    lon: currentPosition.lon,
                    alt: currentPosition.alt,
                    timestamp: new Date().toISOString(),
                    name: `Photo_${new Date().toISOString().split('T')[0]}_${savedPhotos.length + 1}`
                };
                
                savedPhotos.push(photo);
                localStorage.setItem('gnssai_photos', JSON.stringify(savedPhotos));
                loadSavedPhotos();
                showToast('Photo saved with geolocation', 'success');
            };
            reader.readAsDataURL(file);
        }

        function loadSavedPhotos() {
            const gallery = document.getElementById('photoGallery');
            
            if (savedPhotos.length === 0) {
                gallery.innerHTML = '<p style="opacity: 0.5; text-align: center; grid-column: 1/-1;">No photos yet</p>';
                return;
            }
            
            gallery.innerHTML = savedPhotos.map(photo => `
                <div class="photo-item" onclick="showPhotoDetails(${photo.id})">
                    <img src="${photo.data}" alt="${photo.name}">
                    <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto(${photo.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function deletePhoto(id) {
            if (confirm('Delete this photo?')) {
                savedPhotos = savedPhotos.filter(p => p.id !== id);
                localStorage.setItem('gnssai_photos', JSON.stringify(savedPhotos));
                loadSavedPhotos();
                showToast('Photo deleted', 'info');
            }
        }

        function showPhotoDetails(id) {
            const photo = savedPhotos.find(p => p.id === id);
            if (!photo) return;
            
            const modal = document.getElementById('photoModal');
            const content = document.getElementById('photoModalContent');
            
            content.innerHTML = `
                <img src="${photo.data}" style="width: 100%; border-radius: 10px; margin-bottom: 15px;">
                <p><strong>Name:</strong> ${photo.name}</p>
                <p><strong>Date:</strong> ${new Date(photo.timestamp).toLocaleString()}</p>
                <p><strong>Location:</strong><br>
                Lat: ${photo.lat.toFixed(7)}¬∞<br>
                Lon: ${photo.lon.toFixed(7)}¬∞<br>
                Alt: ${photo.alt.toFixed(2)} m</p>
                <button class="btn" onclick="showPhotoOnMap(${id})">üó∫Ô∏è Show on Map</button>
            `;
            
            modal.classList.add('active');
        }

        function showPhotoOnMap(id) {
            const photo = savedPhotos.find(p => p.id === id);
            if (photo) {
                closeModal('photoModal');
                switchTab('map');
                setTimeout(() => {
                    map.setView([photo.lat, photo.lon], 19);
                }, 200);
            }
        }

        function showPhotoModal() {
            capturePhoto();
        }

        // ============================================
        // SKY PLOT
        // ============================================
        function drawSkyPlot(data) {
            const canvas = document.getElementById('skyplotCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 20;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw circles (0¬∞, 30¬∞, 60¬∞, 90¬∞)
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 90; i += 30) {
                const r = radius * (90 - i) / 90;
                ctx.beginPath();
                ctx.arc(centerX, centerY, r, 0, 2 * Math.PI);
                ctx.stroke();
            }
            
            // Draw cardinal directions
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('N', centerX, centerY - radius - 5);
            ctx.fillText('S', centerX, centerY + radius + 15);
            ctx.fillText('E', centerX + radius + 10, centerY + 5);
            ctx.fillText('W', centerX - radius - 10, centerY + 5);
            
            // Draw satellites (placeholder - real data would come from GSV)
            const losSats = data.los_sats || 0;
            const mpSats = data.multipath_sats || 0;
            const nlosSats = data.nlos_sats || 0;
            
            // Simulate satellite positions
            for (let i = 0; i < losSats; i++) {
                drawSatellite(ctx, centerX, centerY, radius, Math.random() * 360, Math.random() * 90, '#00f0ff');
            }
            for (let i = 0; i < mpSats; i++) {
                drawSatellite(ctx, centerX, centerY, radius, Math.random() * 360, Math.random() * 90, '#ffa500');
            }
            for (let i = 0; i < nlosSats; i++) {
                drawSatellite(ctx, centerX, centerY, radius, Math.random() * 360, Math.random() * 90, '#ff4d4d');
            }
        }

        function drawSatellite(ctx, cx, cy, maxR, azimuth, elevation, color) {
            const r = maxR * (90 - elevation) / 90;
            const angle = (azimuth - 90) * Math.PI / 180;
            const x = cx + r * Math.cos(angle);
            const y = cy + r * Math.sin(angle);
            
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportInFormat() {
            const format = document.getElementById('exportFormat').value;
            
            switch(format) {
                case 'csv':
                    exportCSV();
                    break;
                case 'kml':
                    exportKML();
                    break;
                case 'gpx':
                    exportGPX();
                    break;
                case 'geojson':
                    exportGeoJSON();
                    break;
                case 'dxf':
                    showToast('DXF export - Feature coming soon', 'info');
                    break;
            }
        }

        function exportCSV() {
            let csv = 'Name,Code,Description,Latitude,Longitude,Altitude,Quality,HDOP,RTK_Status,Timestamp\n';
            
            savedPoints.forEach(point => {
                csv += `"${point.name}","${point.code}","${point.description || ''}",${point.lat},${point.lon},${point.alt},${point.quality},${point.hdop},"${point.rtk_status}","${point.timestamp}"\n`;
            });

            downloadFile(csv, `gnssai_points_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showToast('CSV exported successfully', 'success');
        }

        function exportKML() {
            let kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n';
            kml += '<name>GNSS.AI Points</name>\n';
            
            savedPoints.forEach(point => {
                kml += '<Placemark>\n';
                kml += `  <name>${point.name}</name>\n`;
                kml += `  <description>${point.description || point.code}</description>\n`;
                kml += '  <Point>\n';
                kml += `    <coordinates>${point.lon},${point.lat},${point.alt}</coordinates>\n`;
                kml += '  </Point>\n';
                kml += '</Placemark>\n';
            });
            
            kml += '</Document>\n</kml>';
            
            downloadFile(kml, `gnssai_points_${new Date().toISOString().split('T')[0]}.kml`, 'application/vnd.google-earth.kml+xml');
            showToast('KML exported successfully', 'success');
        }

        function exportGPX() {
            let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n';
            gpx += '<gpx version="1.1" creator="GNSS.AI">\n';
            
            savedPoints.forEach(point => {
                gpx += `<wpt lat="${point.lat}" lon="${point.lon}">\n`;
                gpx += `  <ele>${point.alt}</ele>\n`;
                gpx += `  <name>${point.name}</name>\n`;
                gpx += `  <desc>${point.description || point.code}</desc>\n`;
                gpx += '</wpt>\n';
            });
            
            gpx += '</gpx>';
            
            downloadFile(gpx, `gnssai_points_${new Date().toISOString().split('T')[0]}.gpx`, 'application/gpx+xml');
            showToast('GPX exported successfully', 'success');
        }

        function exportGeoJSON() {
            const geojson = {
                type: 'FeatureCollection',
                features: savedPoints.map(point => ({
                    type: 'Feature',
                    properties: {
                        name: point.name,
                        code: point.code,
                        description: point.description,
                        rtk_status: point.rtk_status,
                        hdop: point.hdop,
                        timestamp: point.timestamp
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [point.lon, point.lat, point.alt]
                    }
                }))
            };
            
            downloadFile(JSON.stringify(geojson, null, 2), `gnssai_points_${new Date().toISOString().split('T')[0]}.geojson`, 'application/json');
            showToast('GeoJSON exported successfully', 'success');
        }

        function exportAllData() {
            exportInFormat();
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ============================================
        // PDF REPORT
        // ============================================
        function generateReport() {
            showToast('Generating PDF report...', 'info');
            
            // This is a simplified version - would need jsPDF library
            const reportData = {
                project: 'GNSS.AI Survey',
                date: new Date().toLocaleDateString(),
                points: savedPoints.length,
                photos: savedPhotos.length,
                summary: `Report generated with ${savedPoints.length} points and ${savedPhotos.length} photos.`
            };
            
            // For now, export as JSON
            downloadFile(JSON.stringify(reportData, null, 2), `gnssai_report_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showToast('Report exported (JSON format)', 'success');
        }

        // ============================================
        // CLOUD SYNC
        // ============================================
        function syncToCloud() {
            showToast('Cloud sync - Configure in Tools tab', 'info');
            switchTab('tools');
        }

        function authenticateGoogleDrive() {
            showToast('Google Drive authentication - Feature coming soon', 'info');
            // Would implement OAuth flow here
        }

        function authenticateDropbox() {
            showToast('Dropbox authentication - Feature coming soon', 'info');
            // Would implement OAuth flow here
        }

        function manualSync() {
            showToast('Manual sync initiated', 'info');
            // Would sync data here
            document.getElementById('lastSync').textContent = new Date().toLocaleString();
        }

        // ============================================
        // OFFLINE MODE
        // ============================================
        function checkOfflineMode() {
            if (!navigator.onLine) {
                isOffline = true;
                document.getElementById('statusDot').classList.add('offline');
                document.getElementById('offlineIndicator').style.display = 'inline';
            }
        }

        function checkConnectivity() {
            if (navigator.onLine && isOffline) {
                isOffline = false;
                document.getElementById('offlineIndicator').style.display = 'none';
                showToast('Back online', 'success');
            } else if (!navigator.onLine && !isOffline) {
                isOffline = true;
                document.getElementById('offlineIndicator').style.display = 'inline';
                showToast('Working offline', 'warning');
            }
        }

        function autoSave() {
            localStorage.setItem('gnssai_points', JSON.stringify(savedPoints));
            localStorage.setItem('gnssai_photos', JSON.stringify(savedPhotos));
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function playAlert() {
            // Simple beep using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will delete ALL points and photos. Are you sure?')) {
                if (confirm('This action cannot be undone. Continue?')) {
                    savedPoints = [];
                    savedPhotos = [];
                    localStorage.clear();
                    loadSavedPoints();
                    loadSavedPhotos();
                    updateMapMarkers();
                    showToast('All data cleared', 'info');
                }
            }
        }

        // ============================================
        // FALLBACK POLLING
        // ============================================
        setInterval(() => {
            if (!socket.connected && !isOffline) {
                fetch('/api/stats')
                    .then(r => r.json())
                    .then(data => updateDashboard(data))
                    .catch(e => console.log('Fetch error'));
            }
        }, 2000);

        // Initial load
        fetch('/api/stats')
            .then(r => r.json())
            .then(data => updateDashboard(data))
            .catch(e => console.log('Initial load error'));
    </script>
</body>
</html>